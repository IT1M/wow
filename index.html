<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ميس للمنتجات الطبية - الموارد البشرية والتوظيف</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

	 <style>
	/*
    * Mays Medical HR Portal Stylesheet
    * Version: 1.1.0
    * Author: AI Assistant (refined from original)
    * Description: Comprehensive styling for the HR and recruitment portal.
    */

/* --- CSS Variables & Root Configuration --- */
:root {
    --primary-color: #3498db;      /* Main blue, inviting and professional */
    --primary-dark: #2980b9;       /* Darker blue for hover/active states */
    --primary-light: #aed6f1;      /* Lighter blue for accents and backgrounds */
    --secondary-color: #2c3e50;    /* Dark gray for headings and key text */
    --secondary-dark: #1f3a55;     /* Darker shade of secondary for depth */
    --accent-color: #e74c3c;       /* Distinct color for CTAs and important actions */
    --accent-dark: #c0392b;        /* Darker accent for hover/active states */
    --success-color: #2ecc71;      /* Green for success messages/indicators */
    --success-dark: #27ae60;
    --warning-color: #f39c12;      /* Orange for warnings */
    --warning-dark: #d68910;
    --error-color: var(--accent-color); /* Consistent error indication */
    --error-dark: var(--accent-dark);
    --light-bg: #f8f9fa;           /* Very light background for sections */
    --surface-bg: #ffffff;         /* White for cards, modals, interactive surfaces */
    --text-color: #34495e;         /* Primary text color for readability */
    --text-muted: #7f8c8d;         /* Muted text for secondary info */
    --border-color: #e0e6ed;       /* Standard border color */
    --font-family-base: 'Cairo', 'Arial', sans-serif; /* Primary font */
    --border-radius-sm: 4px;
    --border-radius-md: 6px;
    --border-radius-lg: 10px;
    --shadow-xs: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-sm: 0 3px 10px rgba(0,0,0,0.08);
    --shadow-md: 0 6px 20px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
    --spacing-unit: 8px;           /* Base unit for consistent spacing */
    --header-height: 70px;         /* Fixed header height */
    --transition-speed: 0.3s;      /* Standard transition duration */
    --transition-timing: ease;     /* Standard transition timing function */
}

/* --- Global Resets & Base Styles --- */
*,
*::before,
*::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    font-size: 100%; /* Base font size (typically 16px) */
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
}

body {
    font-family: var(--font-family-base);
    line-height: 1.7;
    color: var(--text-color);
    background-color: var(--light-bg);
    direction: rtl;
    overflow-x: hidden; /* Prevent unwanted horizontal scroll */
    overscroll-behavior-y: none; /* Prevent pull-to-refresh on scroll */
    -webkit-font-smoothing: antialiased; /* Smoother fonts on WebKit */
    -moz-osx-font-smoothing: grayscale; /* Smoother fonts on Firefox */
}

.container {
    width: 90%;
    max-width: 1200px;
    margin-inline: auto; /* Logical property for LTR/RTL */
    padding-inline: calc(var(--spacing-unit) * 2); /* 16px */
}

/* --- Typography Enhancements --- */
h1, h2, h3, h4, h5, h6 {
    color: var(--secondary-color);
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: calc(var(--spacing-unit) * 1.5); /* 12px */
}
h1 { font-size: clamp(2.5rem, 5vw, 2.8rem); } /* Responsive font size */
h2 { font-size: clamp(2rem, 4vw, 2.2rem); }
h3 { font-size: clamp(1.4rem, 3vw, 1.6rem); }
h4 { font-size: clamp(1.1rem, 2.5vw, 1.2rem); }

p {
    margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */
    font-size: 1rem;
}

a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color var(--transition-speed) var(--transition-timing);
}
a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

img {
    max-width: 100%;
    height: auto;
    display: block;
    border-radius: var(--border-radius-sm); /* Subtle rounding for images */
}

ul, ol {
    list-style-position: inside;
    padding-right: var(--spacing-unit); /* RTL: padding for list markers */
}

/* --- Enhanced Buttons --- */
.btn {
    display: inline-block;
    padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 2.5); /* 10px 20px */
    border: 2px solid transparent; /* Prepare for outline styles */
    border-radius: var(--border-radius-md);
    font-family: var(--font-family-base);
    font-size: 0.95rem;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: background-color var(--transition-speed) var(--transition-timing),
                transform var(--transition-speed) var(--transition-timing),
                box-shadow var(--transition-speed) var(--transition-timing),
                color var(--transition-speed) var(--transition-timing),
                border-color var(--transition-speed) var(--transition-timing);
    text-decoration: none;
    color: var(--surface-bg);
    background-color: var(--primary-color);
    min-height: 44px; /* Accessibility: minimum touch target size */
    line-height: 1.5; /* Ensure text is vertically centered */
}
.btn:hover, .btn:focus-visible { /* Added focus-visible for keyboard users */
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
    color: var(--surface-bg);
    text-decoration: none;
    outline: none; /* Custom focus styles preferred */
}
.btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-xs);
}
.btn-secondary { background-color: var(--secondary-color); }
.btn-secondary:hover, .btn-secondary:focus-visible { background-color: var(--secondary-dark); }
.btn-accent { background-color: var(--accent-color); }
.btn-accent:hover, .btn-accent:focus-visible { background-color: var(--accent-dark); }
.btn-success { background-color: var(--success-color); }
.btn-success:hover, .btn-success:focus-visible { background-color: var(--success-dark); }

.btn-outline {
    background-color: transparent;
    color: var(--primary-color);
    border-color: var(--primary-color);
}
.btn-outline:hover, .btn-outline:focus-visible {
    background-color: var(--primary-color);
    color: var(--surface-bg);
}
.btn-icon {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-unit);
}
.btn-icon i {
    font-size: 1.1em;
    line-height: 1; /* Prevent icon from affecting button height */
}

/* --- Header & Navigation Refinements --- */
.header {
    background: var(--surface-bg);
    color: var(--secondary-color);
    padding-block: calc(var(--spacing-unit) * 1); /* Logical property */
    position: fixed;
    top: 0;
    left: 0; right: 0; /* Cover full width */
    width: 100%;
    z-index: 1000;
    box-shadow: var(--shadow-sm);
    transition: background-color var(--transition-speed) var(--transition-timing),
                padding-block var(--transition-speed) var(--transition-timing),
                height var(--transition-speed) var(--transition-timing),
                box-shadow var(--transition-speed) var(--transition-timing);
    height: var(--header-height);
    display: flex;
    align-items: center;
}
.header.scrolled {
    background: rgba(255, 255, 255, 0.97); /* Slightly transparent for depth */
    backdrop-filter: blur(5px); /* Frosted glass effect */
    padding-block: calc(var(--spacing-unit) * 0.75);
    box-shadow: var(--shadow-md);
    height: calc(var(--header-height) - 10px);
}

.nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.logo {
    font-size: 1.8rem;
    font-weight: 800; /* Bolder logo */
    color: var(--primary-color);
    text-decoration: none;
    transition: color var(--transition-speed) var(--transition-timing);
}
.logo:hover, .logo:focus-visible {
    color: var(--primary-dark);
    text-decoration: none;
}

.main-nav {
    display: flex;
    align-items: center;
}

.nav-menu {
    display: flex;
    list-style: none;
    gap: calc(var(--spacing-unit) * 2.5); /* 20px */
}

.nav-menu a {
    color: var(--secondary-color);
    padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit); /* 6px 8px */
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    font-size: 0.95rem;
    position: relative;
    transition: color var(--transition-speed) var(--transition-timing);
}
.nav-menu a::after { /* Underline effect */
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: -4px;
    left: 50%; /* Start from center */
    transform: translateX(-50%); /* Center it */
    background-color: var(--primary-color);
    transition: width var(--transition-speed) var(--transition-timing), left var(--transition-speed) var(--transition-timing), transform var(--transition-speed) var(--transition-timing);
}
.nav-menu a:hover,
.nav-menu a:focus-visible, /* Added focus-visible */
.nav-menu a.active-link {
    color: var(--primary-color);
    text-decoration: none;
}
.nav-menu a:hover::after,
.nav-menu a:focus-visible::after, /* Added focus-visible */
.nav-menu a.active-link::after {
    width: 100%;
    left: 0;
    transform: translateX(0);
}

.user-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-unit);
    position: relative;
}

.user-icon-button {
    background: none;
    border: none;
    color: var(--secondary-color);
    cursor: pointer;
    font-size: 1.8rem;
    padding: calc(var(--spacing-unit) * 0.5); /* 4px */
    border-radius: 50%;
    transition: background-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing);
    line-height: 1; /* Ensure icon is centered */
}
.user-icon-button:hover, .user-icon-button:focus-visible { /* Added focus-visible */
    background-color: var(--light-bg);
    color: var(--primary-color);
    outline: none;
}
.user-icon-button i.fa-user-check { /* Logged in user icon style */
    color: var(--success-color);
}
.user-icon-button i.user-icon-loggedin { /* Alternative class for logged in user styling */
    color: var(--success-color);
}

.dropdown-menu {
    position: absolute;
    top: calc(100% + 12px);
    left: 0; /* RTL: aligns to the left */
    background: var(--surface-bg);
    color: var(--text-color);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 220px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px) scale(0.95); /* Added scale for smoother appearance */
    z-index: 1001;
    overflow: hidden;
    transition: opacity var(--transition-speed) var(--transition-timing),
                visibility var(--transition-speed) var(--transition-timing),
                transform var(--transition-speed) var(--transition-timing);
    border: 1px solid var(--border-color); /* Subtle border for definition */
}
.dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}
.dropdown-menu-header {
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
    border-bottom: 1px solid var(--border-color);
    text-align: right;
}
.dropdown-menu-header strong {
    font-size: 1rem;
    color: var(--secondary-color);
    display: block;
}
.dropdown-menu-header small {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: block;
    word-break: break-all; /* Prevent long emails from breaking layout */
}
.dropdown-menu a {
    display: flex;
    align-items: center;
    gap: calc(var(--spacing-unit) * 1.25);
    padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 1.5);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
    text-decoration: none;
    transition: background-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing);
}
.dropdown-menu a:last-child {
    border-bottom: none;
}
.dropdown-menu a:hover, .dropdown-menu a:focus-visible { /* Added focus-visible */
    background-color: var(--primary-light);
    color: var(--primary-dark);
    text-decoration: none;
    outline: none;
}
.dropdown-menu a i {
    width: 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 1em;
    transition: color var(--transition-speed) var(--transition-timing);
}
.dropdown-menu a:hover i, .dropdown-menu a:focus-visible i { /* Added focus-visible */
    color: var(--primary-dark);
}

.mobile-nav-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--secondary-color);
    font-size: 1.8rem;
    cursor: pointer;
    padding: var(--spacing-unit);
    z-index: 1005; /* Above mobile nav content */
    touch-action: manipulation; /* Improve touch responsiveness */
    line-height: 1; /* Ensure icon is centered */
}
.mobile-nav-toggle:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* --- Main Content & Hero Section --- */
.main-content {
    padding-top: var(--header-height); /* Ensure content is below fixed header */
}

.hero {
    background: linear-gradient(to bottom, rgba(44, 62, 80, 0.85), rgba(52, 152, 219, 0.5)),
                url('https://images.unsplash.com/photo-1556761175-5973dc0f32e7?auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
    color: var(--surface-bg);
    padding: 6rem 0;
    text-align: center;
    min-height: calc(100vh - var(--header-height));
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Prevent gradient overflow issues */
}
.hero-content {
    max-width: 900px;
    padding-inline: var(--spacing-unit); /* Add some padding on very small screens */
}
.hero h1 {
    font-size: clamp(2.8rem, 7vw, 4.2rem); /* Responsive hero title */
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: calc(var(--spacing-unit) * 2.5);
    background: linear-gradient(145deg, #ffffff 60%, var(--primary-light) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent; /* Fallback for browsers not supporting background-clip */
    filter: drop-shadow(0 4px 20px rgba(0,0,0,0.5));
}
.hero h1 .highlight-word {
    display: inline-block; /* Ensure text shadow applies correctly */
    color: var(--primary-light); /* Fallback if gradient fails */
    -webkit-text-fill-color: var(--primary-light); /* Override parent's transparent fill */
    text-shadow: 0 0 15px rgba(174, 214, 241, 0.6), 0 0 5px rgba(255, 255, 255, 0.5);
}
.hero p {
    font-size: clamp(1rem, 2.5vw, 1.2rem); /* Responsive hero paragraph */
    margin-bottom: calc(var(--spacing-unit) * 4);
    opacity: 0.95;
    line-height: 1.8;
    max-width: 700px;
    margin-inline: auto; /* RTL/LTR safe */
    letter-spacing: 0.5px;
}
.cta-button { /* Specific CTA in hero */
    background: var(--accent-color);
    color: white;
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 3.5);
    border-radius: var(--border-radius-md);
    font-size: clamp(1rem, 2.2vw, 1.1rem);
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.35);
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-unit);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.cta-button:hover, .cta-button:focus-visible { /* Added focus-visible */
    background: var(--accent-dark);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 18px rgba(231, 76, 60, 0.45);
    color: white; /* Ensure color remains white */
}

/* Hero Animation */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-hero {
    opacity: 0; /* Start hidden */
    animation: fadeInUp 0.8s ease-out forwards;
    animation-delay: var(--animation-delay, 0s); /* Custom property for staggering */
}

/* --- Sections General Styling --- */
.section {
    padding-block: clamp(3rem, 8vw, 5rem); /* Responsive vertical padding */
}
.section:nth-of-type(odd) {
    background-color: var(--surface-bg); /* Alternating section backgrounds */
}
.section-title {
    text-align: center;
    font-size: clamp(2rem, 5vw, 2.5rem); /* Responsive section titles */
    margin-bottom: calc(var(--spacing-unit) * 5);
    color: var(--secondary-color);
    position: relative;
    padding-bottom: calc(var(--spacing-unit) * 1.5);
}
.section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background-color: var(--primary-color);
    border-radius: 2px;
}

/* --- Jobs Section & Filters --- */
#jobs {
    background-color: var(--light-bg);
}
.filters-container {
    display: flex;
    gap: calc(var(--spacing-unit) * 2);
    margin-bottom: calc(var(--spacing-unit) * 3);
    flex-wrap: wrap;
    justify-content: center;
    padding: calc(var(--spacing-unit) * 2);
    background-color: var(--surface-bg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
}
.filter-group {
    flex: 1;
    min-width: 200px;
}
.filter-group label {
    display: block;
    font-weight: 600;
    margin-bottom: var(--spacing-unit);
    font-size: 0.9rem;
    color: var(--secondary-color);
}
.filter-select {
    width: 100%;
    padding: calc(var(--spacing-unit) * 1.25);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    font-size: 0.95rem;
    background-color: var(--surface-bg);
    color: var(--text-color);
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2334495e' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 0.75rem center; /* RTL: arrow on the left */
    padding-left: 2.5rem; /* RTL: space for arrow */
    cursor: pointer;
    transition: border-color var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing);
}
.filter-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25); /* Focus ring */
}

.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr)); /* Responsive grid columns */
    gap: calc(var(--spacing-unit) * 3);
}
.job-card {
    background: var(--surface-bg);
    padding: calc(var(--spacing-unit) * 2.5);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    transition: transform var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing);
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
}
.job-card:hover {
    transform: translateY(-6px) scale(1.02); /* Added subtle scale */
    box-shadow: var(--shadow-md);
}
.job-title {
    font-size: 1.3rem;
    margin-bottom: calc(var(--spacing-unit) * 0.75);
    color: var(--primary-color);
}
.job-department {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: var(--spacing-unit);
    font-weight: 600;
}
.job-details {
    display: flex;
    flex-wrap: wrap; /* Allow details to wrap */
    gap: calc(var(--spacing-unit) * 1.5);
    margin-bottom: calc(var(--spacing-unit) * 1.5);
    font-size: 0.8rem;
    color: var(--text-muted);
}
.job-detail {
    display: flex;
    align-items: center;
    gap: calc(var(--spacing-unit) * 0.5);
}
.job-detail i {
    color: var(--primary-light);
}
.job-description-snippet {
    font-size: 0.9rem;
    margin-bottom: calc(var(--spacing-unit) * 2);
    flex-grow: 1; /* Allow description to take available space */
    color: var(--text-color);
    line-height: 1.6;
}
.job-actions {
    margin-top: auto; /* Push actions to the bottom */
    display: flex;
    gap: calc(var(--spacing-unit) * 1.5);
}
.job-actions .details-btn,
.job-actions .apply-btn-in-card {
    flex-grow: 1; /* Make buttons take equal width */
    padding: calc(var(--spacing-unit) * 1) calc(var(--spacing-unit) * 1.5);
    font-size: 0.9rem;
}
.details-btn { background-color: var(--secondary-color); }
.details-btn:hover, .details-btn:focus-visible { background-color: var(--secondary-dark); }
.apply-btn-in-card { background-color: var(--accent-color); }
.apply-btn-in-card:hover, .apply-btn-in-card:focus-visible { background-color: var(--accent-dark); }

#noJobsMessage {
    text-align: center;
    padding: calc(var(--spacing-unit) * 4) 0; /* More padding */
    color: var(--text-muted);
    font-size: 1.1rem;
}
#noJobsMessage i {
    font-size: 2.5rem;
    display: block;
    margin-bottom: var(--spacing-unit);
    color: var(--primary-light);
}

.general-apply-cta {
    text-align: center;
    margin-top: calc(var(--spacing-unit) * 4);
}

/* --- Contact Section --- */
.contact-section {
    background-color: var(--secondary-dark);
    color: var(--light-bg);
}
.contact-section .section-title {
    color: var(--surface-bg);
}
.contact-section .section-title::after {
    background-color: var(--primary-light);
}
.contact-content {
    text-align: center;
    max-width: 700px;
    margin-inline: auto; /* RTL/LTR safe */
}
.contact-content p {
    font-size: 1.1rem;
    margin-bottom: calc(var(--spacing-unit) * 3);
}
.contact-content a {
    color: var(--primary-light);
    font-weight: 600; /* Make links slightly bolder */
}
.contact-content a:hover, .contact-content a:focus-visible { /* Added focus-visible */
    color: var(--surface-bg);
    text-decoration: underline;
}
.contact-info-item {
    margin-bottom: calc(var(--spacing-unit) * 1.5);
    font-size: 1.1rem;
}
.contact-info-item i {
    color: var(--primary-light);
    margin-left: var(--spacing-unit); /* RTL: icon on the right of text */
}

/* --- Footer --- */
.footer {
    background-color: var(--secondary-color);
    color: var(--light-bg);
    padding: calc(var(--spacing-unit) * 3) 0;
    text-align: center;
    font-size: 0.9rem;
}
.footer p {
    margin-bottom: 0;
    color: var(--primary-light);
}

/* --- Modals (General Styles) --- */
.modal {
    /* display: none; by default, JS handles this */
    position: fixed;
    z-index: 2000;
    inset: 0; /* Replaces left, top, width, height: 100% */
    overflow-y: auto; /* Enable scroll if modal content is too long */
    background-color: rgba(44, 62, 80, 0.85);
    display: flex; /* For centering */
    align-items: center;
    justify-content: center;
    padding: calc(var(--spacing-unit) * 2);
    backdrop-filter: blur(3px); /* Frosted glass effect for overlay */
}
.modal-content {
    background-color: var(--surface-bg);
    margin: auto; /* Ensures centering within the flex container */
    padding: calc(var(--spacing-unit) * 3);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    width: 90%;
    max-width: 550px;
    position: relative;
    animation: fadeInModal 0.4s var(--transition-timing);
}
.modal-content.large {
    max-width: 750px;
}
@keyframes fadeInModal {
    from { opacity: 0; transform: translateY(-30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: calc(var(--spacing-unit) * 2);
    padding-bottom: calc(var(--spacing-unit) * 1.5);
    border-bottom: 1px solid var(--border-color);
}
.modal-header h3 {
    font-size: 1.5rem;
    margin-bottom: 0;
    color: var(--primary-color);
}
.close-modal-btn {
    background: none;
    border: none;
    font-size: 2.2rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color var(--transition-speed) var(--transition-timing), transform 0.2s var(--transition-timing);
}
.close-modal-btn:hover, .close-modal-btn:focus-visible { /* Added focus-visible */
    color: var(--accent-color);
    transform: scale(1.1); /* Slight zoom on hover/focus */
    outline: none;
}

/* Forms within modals */
.form-group {
    margin-bottom: calc(var(--spacing-unit) * 2);
}
.form-group label {
    display: block;
    margin-bottom: calc(var(--spacing-unit) * 0.75);
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--secondary-color);
}
.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="tel"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group input[type="file"],
.form-group textarea,
.form-group select {
    width: 100%;
    padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 1.5);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    font-size: 0.95rem;
    font-family: var(--font-family-base);
    background-color: var(--light-bg); /* Slightly off-white for inputs */
    color: var(--text-color);
    transition: border-color var(--transition-speed) var(--transition-timing),
                box-shadow var(--transition-speed) var(--transition-timing),
                background-color var(--transition-speed) var(--transition-timing);
    min-height: 44px; /* Accessibility */
}
.form-group input[type="file"] {
    padding: calc(var(--spacing-unit) * 1);
    background-color: var(--surface-bg); /* File inputs often look better white */
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
    background-color: var(--surface-bg); /* White background on focus */
}
.form-group textarea {
    min-height: 100px;
    resize: vertical;
}
.form-error-message {
    display: block;
    color: var(--error-color);
    font-size: 0.8rem;
    margin-top: calc(var(--spacing-unit) * 0.5);
    font-weight: 600; /* Make error messages more prominent */
}
.submit-btn { /* Generic submit button for forms */
    width: 100%;
    padding-block: calc(var(--spacing-unit) * 1.5);
    font-size: 1.05rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.form-link {
    text-align: center;
    margin-top: calc(var(--spacing-unit) * 2);
    font-size: 0.85rem;
    color: var(--text-muted);
}
.form-link a {
    font-weight: 600;
    color: var(--primary-color);
}
.form-link a:hover, .form-link a:focus-visible { /* Added focus-visible */
    color: var(--primary-dark);
}

/* Specific Modal Content Styling */
.modal-body {
    max-height: 70vh; /* Limit height and allow scrolling */
    overflow-y: auto;
    padding-right: var(--spacing-unit); /* Space for scrollbar in RTL */
    /* Custom scrollbar (optional, WebKit only for wide compatibility) */
}
.modal-body::-webkit-scrollbar { width: 8px; }
.modal-body::-webkit-scrollbar-track { background: var(--light-bg); border-radius: 4px; }
.modal-body::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 4px; }
.modal-body::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

.modal-body h4 {
    font-size: 1.1rem;
    color: var(--secondary-color);
    margin-top: calc(var(--spacing-unit) * 2);
    margin-bottom: var(--spacing-unit);
    padding-bottom: calc(var(--spacing-unit) * 0.5);
    border-bottom: 1px solid var(--border-color);
}
.modal-body p, .modal-body ul {
    font-size: 0.95rem;
    line-height: 1.8;
    color: var(--text-color);
}
.modal-body ul {
    padding-right: calc(var(--spacing-unit) * 2.5);
    margin-bottom: calc(var(--spacing-unit) * 1.5);
}
.modal-body ul li {
    margin-bottom: calc(var(--spacing-unit) * 0.5);
}
.modal-body .cta-button { /* Button inside job details modal */
    margin-top: calc(var(--spacing-unit) * 2.5);
    width: auto; /* Don't make it full width */
}

/* --- Chat Functionality Enhancements --- */
.chat-toggle-button {
    position: fixed;
    bottom: calc(var(--spacing-unit) * 3); /* 24px */
    left: calc(var(--spacing-unit) * 3);   /* 24px (RTL) - For LTR it would be 'right' */
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    color: white;
    font-size: 2.2rem; /* Icon size */
    border: 3px solid white;
    box-shadow: var(--shadow-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1500; /* Ensure above most elements, but below modals */
    transition: transform 0.3s var(--transition-timing), box-shadow 0.3s var(--transition-timing);
    animation: pulseSupportBtn 2.5s infinite;
    touch-action: manipulation;
    outline: none;
}
@keyframes pulseSupportBtn {
    0% { transform: scale(1); box-shadow: var(--shadow-md), 0 0 0 0 rgba(52, 152, 219, 0.7); }
    70% { transform: scale(1); box-shadow: var(--shadow-md), 0 0 0 15px rgba(52, 152, 219, 0); }
    100% { transform: scale(1); box-shadow: var(--shadow-md), 0 0 0 0 rgba(52, 152, 219, 0); }
}
.chat-toggle-button:hover, .chat-toggle-button:focus-visible { /* Added focus-visible */
    transform: scale(1.1) rotate(10deg);
    animation-play-state: paused; /* Pause pulse on hover/focus */
    box-shadow: var(--shadow-lg), 0 0 0 5px rgba(255, 255, 255, 0.5); /* Enhanced focus outline */
}
.chat-window {
    display: none; /* JS will toggle to flex */
    flex-direction: column;
    position: fixed;
    bottom: calc(var(--spacing-unit) * 12); /* 96px */
    left: calc(var(--spacing-unit) * 3);    /* 24px (RTL) */
    width: 360px;
    max-height: 550px;
    background-color: var(--surface-bg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: 1499; /* Below toggle button if it overlaps, but above page content */
    overflow: hidden;
    transform: translateY(20px) scale(0.95); /* Initial state for animation */
    opacity: 0;
    transition: transform 0.3s var(--transition-timing), opacity 0.3s var(--transition-timing);
}
.chat-window.show {
    display: flex;
    transform: translateY(0) scale(1);
    opacity: 1;
}
.chat-header {
    background: var(--primary-color);
    color: white;
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top-left-radius: var(--border-radius-lg); /* Match window rounding */
    border-top-right-radius: var(--border-radius-lg);
}
.chat-header h4 {
    margin: 0;
    font-size: 1.1rem;
    color: white;
    font-weight: 600;
}
.chat-header .icon-button { /* For close chat button */
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s var(--transition-timing), transform 0.2s var(--transition-timing);
    padding: calc(var(--spacing-unit) * 0.5); /* Make clickable area larger */
    line-height: 1;
}
.chat-header .icon-button:hover, .chat-header .icon-button:focus-visible { /* Added focus-visible */
    opacity: 1;
    transform: scale(1.1);
    outline: none;
}
.chat-options {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--light-bg); /* Subtle background for options bar */
}
.chat-option {
    flex: 1;
    padding: calc(var(--spacing-unit) * 1.25) 0; /* 10px */
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted);
    transition: color 0.2s var(--transition-timing), border-bottom-color 0.2s var(--transition-timing);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}
.chat-option.active, .chat-option:hover, .chat-option:focus-visible { /* Combined states */
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    outline: none;
}
.chat-option i { line-height: 1; }

.chat-messages {
    flex-grow: 1;
    padding: calc(var(--spacing-unit) * 2);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    /* Custom scrollbar for chat messages */
}
.chat-messages::-webkit-scrollbar { width: 6px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 3px; }
.chat-messages::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

.message {
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    line-height: 1.5;
    word-wrap: break-word; /* Ensure long words break */
    font-size: 0.9rem; /* Slightly smaller for chat messages */
}
.message.user {
    background: var(--primary-color);
    color: white;
    align-self: flex-start; /* RTL: user messages on the left */
    border-bottom-left-radius: 4px; /* "Tail" effect */
}
.message.bot {
    background: var(--light-bg);
    color: var(--text-color);
    align-self: flex-end; /* RTL: bot messages on the right */
    border-bottom-right-radius: 4px;
}
.message.loading-dots {
    display: flex;
    gap: 4px; /* Increased gap */
    padding: 14px 18px;
    background: var(--light-bg);
}
.message.loading-dots span {
    width: 8px; height: 8px;
    background-color: var(--primary-light);
    border-radius: 50%;
    animation: bounceDot 1.4s infinite ease-in-out both;
}
.message.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.message.loading-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounceDot {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1.0); }
}
.chat-input-area {
    padding: calc(var(--spacing-unit) * 1.5);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: var(--spacing-unit);
    background-color: var(--surface-bg); /* Ensure consistent background */
}
#chatInputControl { /* Text input for chat */
    flex-grow: 1;
    border: 1px solid var(--border-color);
    border-radius: 20px; /* Pill shape */
    padding: 10px 15px;
    font-size: 0.95rem;
    transition: border-color var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing);
    min-height: 44px; /* Accessibility */
}
#chatInputControl:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2); /* Subtle focus shadow */
}
#sendChatMessageBtn, #voiceRecognitionBtn {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s var(--transition-timing), transform 0.2s var(--transition-timing);
}
#sendChatMessageBtn:hover, #voiceRecognitionBtn:hover,
#sendChatMessageBtn:focus-visible, #voiceRecognitionBtn:focus-visible { /* Added focus-visible */
    background: var(--primary-dark);
    transform: scale(1.05); /* Slight scale on hover/focus */
    outline: none;
}
#voiceRecognitionBtn.listening {
    background-color: var(--accent-color);
    animation: pulseRecord 1.5s infinite;
}
@keyframes pulseRecord {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } /* Darker initial shadow */
    70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* --- Global Alert Notifications --- */
#globalAlertContainer {
    position: fixed;
    top: calc(var(--header-height) + 15px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 3000; /* Highest z-index for alerts */
    width: auto;
    max-width: 90%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-unit);
}
.message-alert {
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2.5);
    border-radius: var(--border-radius-md);
    font-weight: 600;
    font-size: 0.95rem;
    text-align: center;
    box-shadow: var(--shadow-md);
    color: var(--surface-bg);
    opacity: 0; /* Start invisible for animation */
    min-width: 280px;
    display: flex;
    align-items: center;
    gap: var(--spacing-unit);
    /* Animation handled by JS to allow staggering if multiple alerts */
}
/* Animations will be applied by JS for more control if needed, but CSS keyframes are fine for simple cases */
.message-alert.slide-in { animation: slideInFadeAlert 0.4s ease-out forwards; }
.message-alert.fade-out { animation: fadeOutAlertLater 0.4s ease-in forwards; }

.message-alert i { font-size: 1.3em; line-height: 1; }
.message-alert.success { background-color: var(--success-color); border-left: 5px solid var(--success-dark); }
.message-alert.error { background-color: var(--error-color); border-left: 5px solid var(--error-dark); }
.message-alert.info { background-color: var(--primary-color); border-left: 5px solid var(--primary-dark); }

@keyframes slideInFadeAlert {
    from { opacity: 0; transform: translateY(-20px) /* translateX remains -50% from parent */; }
    to { opacity: 1; transform: translateY(0) /* translateX remains -50% from parent */; }
}
@keyframes fadeOutAlertLater {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
}


/* --- Responsive Design Adjustments --- */
@media (max-width: 992px) { /* Tablet and below */
    .container { width: 95%; }
    .logo { font-size: 1.6rem; }
    .nav-menu { display: none; } /* Hide desktop menu */

    .main-nav.mobile-active { /* Fullscreen mobile navigation overlay */
        position: fixed;
        top: 0; /* Align with top of viewport */
        right: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255,255,255,0.98); /* Near opaque background */
        z-index: 1999; /* Below header buttons but above content */
        overflow-y: auto;
        padding-top: var(--header-height); /* Space for header */
        display: flex; /* Allow centering of menu if needed, or full-width items */
        flex-direction: column;
    }
    .main-nav.mobile-active .nav-menu { /* Mobile menu appearance */
        display: flex;
        flex-direction: column;
        background: var(--surface-bg); /* Solid background for menu items */
        width: 100%; /* Full width */
        box-shadow: none; /* Shadow might be redundant on full overlay */
        padding: var(--spacing-unit) 0;
        animation: slideDownNav 0.3s var(--transition-timing);
    }
    @keyframes slideDownNav {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .main-nav.mobile-active .nav-menu a {
        padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2.5); /* Larger tap targets */
        width: 100%;
        text-align: right; /* RTL */
        border-bottom: 1px solid var(--border-color);
        color: var(--secondary-color);
        font-size: 1.1rem; /* Larger font for mobile */
    }
    .main-nav.mobile-active .nav-menu a:hover,
    .main-nav.mobile-active .nav-menu a.active-link,
    .main-nav.mobile-active .nav-menu a:focus-visible { /* Added focus-visible */
        background-color: var(--primary-light);
        color: var(--primary-dark);
    }
    .main-nav.mobile-active .nav-menu li:last-child a {
        border-bottom: none;
    }
    .main-nav.mobile-active .nav-menu a::after { display: none; } /* No underline effect for mobile links */

    .mobile-nav-toggle { display: block; position: relative; z-index: 2100; /* Ensure toggle is above nav overlay */ }

    .hero h1 { font-size: clamp(2.5rem, 6vw, 3.5rem); }
    .hero p { font-size: clamp(1rem, 2.2vw, 1.15rem); }
    .section-title { font-size: clamp(1.8rem, 4.5vw, 2.2rem); }
    .filters-container { flex-direction: column; align-items: stretch; }
    
    body.mobile-nav-open {
        overflow: hidden !important; /* Prevent body scroll */
        /* position: fixed and width: 100vw can cause issues with scroll restoration, be careful */
    }
}

@media (max-width: 768px) { /* Mobile devices */
    html { font-size: 93.75%; } /* ~15px base */
    .hero { padding: 5rem 0; min-height: auto; }
    .hero h1 { font-size: clamp(2.2rem, 5.5vw, 2.8rem); line-height: 1.3; }
    .hero p { font-size: clamp(0.95rem, 2vw, 1.1rem); }
    .section { padding-block: clamp(2.5rem, 7vw, 4rem); }
    .section-title { font-size: clamp(1.7rem, 4vw, 2rem); margin-bottom: calc(var(--spacing-unit) * 4); }
    
    .jobs-grid { grid-template-columns: 1fr; } /* Stack job cards */
    .job-card { padding: calc(var(--spacing-unit) * 2); }
    .job-actions { flex-direction: column; gap: var(--spacing-unit); } /* Stack buttons in job card, smaller gap */
    
    .modal-content { padding: calc(var(--spacing-unit) * 2.5); width: 95%; }
    .modal-content.large { max-width: 95%; }

    .chat-window {
        width: calc(100vw - (var(--spacing-unit) * 4)); /* More responsive width */
        left: var(--spacing-unit) * 2; /* Centered with margin */
        bottom: calc(var(--spacing-unit) * 10); /* Adjust position relative to toggle button */
        max-height: 75vh; /* Slightly less height */
    }
    #globalAlertContainer { width: 90%; }
}

@media (max-width: 480px) {
    html { font-size: 87.5%; } /* ~14px base */
    
    /* Adjust header for smaller screens */
    :root { --header-height: 60px; } /* Reduce header height */
    /* .header, .main-content padding-top will adjust based on the variable */
    .header.scrolled { height: calc(var(--header-height) - 10px); }
    .main-nav.mobile-active { padding-top: var(--header-height); }


    .logo { font-size: 1.4rem; }
    .user-icon-button, .mobile-nav-toggle { font-size: 1.6rem; padding: calc(var(--spacing-unit) * 0.75); }
    
    .hero { padding: 4rem 0; }
    .hero h1 { font-size: clamp(1.8rem, 5vw, 2.2rem); }
    .hero p { font-size: clamp(0.9rem, 1.8vw, 1rem); }
    .cta-button { font-size: 0.95rem; padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 3); }
    
    .section { padding-block: clamp(2rem, 6vw, 3rem); }
    .section-title { font-size: clamp(1.5rem, 3.5vw, 1.7rem); }
    
    .filter-select { font-size: 0.9rem; }
    .job-title { font-size: 1.2rem; }
    
    .modal-content { padding: var(--spacing-unit) * 2; }
    .modal-header h3 { font-size: 1.3rem; }
    .close-modal-btn { font-size: 2rem; }

    .chat-toggle-button {
        width: 56px; height: 56px;
        font-size: 1.8rem; /* Slightly smaller icon */
        bottom: var(--spacing-unit) * 2;
        left: var(--spacing-unit) * 2;
        box-shadow: var(--shadow-sm); /* Less prominent shadow */
    }
    .chat-window {
        width: calc(100vw - (var(--spacing-unit) * 2)); /* Almost full width */
        left: var(--spacing-unit);
        bottom: calc(var(--spacing-unit) * 9); /* Closer to bottom toggle */
        border-radius: var(--border-radius-md); /* Smaller radius for compact look */
        max-height: 80vh;
    }

    .filters-container {
        gap: var(--spacing-unit);
        padding: var(--spacing-unit);
    }
    .filter-group { min-width: 0; width: 100%; }
    .jobs-grid { gap: var(--spacing-unit) * 2; }
    .job-card { padding: var(--spacing-unit) * 1.5; }
    
    .modal-content.large, .modal-content {
        max-width: 98vw; padding: var(--spacing-unit) * 1.5;
    }
    
    .chat-header h4 { font-size: 1rem; }
    .chat-messages { padding: var(--spacing-unit); font-size: 0.9rem; }
    .chat-input-area { padding: var(--spacing-unit); gap: calc(var(--spacing-unit) * 0.5); }
    #chatInputControl { font-size: 0.9rem; padding: 8px 12px; }
    #sendChatMessageBtn, #voiceRecognitionBtn { width: 38px; height: 38px; font-size: 1rem; }
    
    .general-apply-cta { margin-top: calc(var(--spacing-unit) * 2.5); }
    
    .contact-content { padding-inline: var(--spacing-unit); }
    .contact-info-item { font-size: 0.95rem; }
    .footer { font-size: 0.85rem; padding-block: calc(var(--spacing-unit) * 2); }
    .footer p { font-size: 0.9rem; }
    
    .nav-container.container { padding-inline: var(--spacing-unit); }
    .main-nav.mobile-active .nav-menu a { font-size: 1rem; }
}

/* Ensure form elements maintain a minimum size for usability */
input, button, select, textarea {
    font-size: 1rem; /* Base size, can be overridden */
    min-height: 40px; /* Minimum height for easier interaction */
}
/* Ensure buttons are consistently sized */
.btn, .cta-button, .submit-btn {
    min-height: 44px; /* WCAG touch target recommendation */
    font-size: 1rem; /* Default button font size */
    display: inline-flex; /* Helps with vertical alignment of text/icons */
    align-items: center;
    justify-content: center;
}

/* Very small screens: fine-tuning */
@media (max-width: 360px) {
    html { font-size: 81.25%; } /* ~13px base */
    .hero h1 { font-size: clamp(1.5rem, 4.5vw, 1.8rem); } /* Further reduce hero title */
    .chat-window, .modal-content, .modal-content.large {
        width: 98vw;
        max-width: 98vw;
        padding: var(--spacing-unit);
    }
    .section-title { font-size: clamp(1.3rem, 3vw, 1.5rem); }
    .user-actions .dropdown-menu { min-width: 180px; /* Adjust dropdown for small screens */ }
}

	/* --- Support Floating Button (Bottom Left) --- */
.support-toggle-button {
    position: fixed;
    bottom: calc(var(--spacing-unit) * 3); /* 24px */
    left: calc(var(--spacing-unit) * 3);   /* 24px */
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    color: white;
    font-size: 2.2rem;
    border: 3px solid white;
    box-shadow: var(--shadow-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1500;
    transition: transform 0.3s var(--transition-timing), box-shadow 0.3s var(--transition-timing);
    touch-action: manipulation;
    outline: none;
}
.support-toggle-button:hover, .support-toggle-button:focus-visible {
    transform: scale(1.1) rotate(10deg);
    box-shadow: var(--shadow-lg), 0 0 0 5px rgba(255, 255, 255, 0.5);
}
@media (max-width: 480px) {
    .support-toggle-button {
        width: 56px;
        height: 56px;
        font-size: 1.8rem;
        bottom: var(--spacing-unit) * 2;
        left: var(--spacing-unit) * 2;
        box-shadow: var(--shadow-sm);
    }
}
.support-modal-iframe {
    width: 100%;
    height: 70vh;
    border: none;
    border-radius: var(--border-radius-lg);
    background: #fff;
    min-height: 350px;
    max-height: 80vh;
    display: block;
}
</style>
</head>

<body>
    <!-- Header -->
    <header class="header" id="pageHeader">
        <div class="nav-container container">
            <a href="#home" class="logo">ميس للمنتجات الطبية</a>
            <nav class="main-nav" id="mainNavMenu">
                <ul class="nav-menu">
                    <li><a href="#home" class="nav-link active-link" data-section="home">الرئيسية</a></li>
                    <li><a href="#culture" class="nav-link" data-section="culture">ثقافة العمل</a></li>
                    <li><a href="pages/job.html" class="nav-link" data-section="jobs">الوظائف</a></li>
                    <li><a href="#contact" class="nav-link" data-section="contact">تواصل معنا</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <button class="user-icon-button" id="userMenuButton" aria-label="قائمة المستخدم" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle"></i>
                </button>
                <div class="dropdown-menu" id="userDropdownMenu" role="menu">
                    <!-- Dynamic content: Login/Register or User Profile/Logout -->
<a href="pages/login.html" role="menuitem" id="loginMenuLinkPlaceholder"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</a>
<a href="pages/signup.html" role="menuitem" id="registerMenuLinkPlaceholder"><i class="fas fa-user-plus"></i> إنشاء حساب</a>
                </div>
            </div>
            <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="فتح/إغلاق القائمة الرئيسية" aria-expanded="false" aria-controls="mainNavMenu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Section -->
        <section id="home" class="hero section-observer">
            <div class="hero-content">
                <h1 class="animate-hero">انضم إلى فريق <span class="highlight-word">يبتكر</span><br>لمستقبل الرعاية الصحية</h1>
                <p class="animate-hero" style="--animation-delay: 0.2s;">في ميس للمنتجات الطبية، نصنع الفرق. نبحث عن مواهب شغوفة للمساهمة في تطوير حلول طبية رائدة تحدث تأثيرًا إيجابيًا في حياة الناس.</p>
                <a href="#jobs" class="cta-button animate-hero nav-link" style="--animation-delay: 0.4s;" data-section="jobs">استكشف الفرص الوظيفية <i class="fas fa-arrow-left"></i></a>
            </div>
        </section>

        <!-- Company Culture Section -->
        <section id="culture" class="section section-observer">
             <div class="container">
                <h2 class="section-title">ثقافتنا في ميس</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; text-align: center;">
                    <div class="culture-item">
                        <i class="fas fa-heartbeat" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3>الرعاية أولاً</h3>
                        <p>نضع صحة ورفاهية مرضانا وموظفينا في صميم كل ما نقوم به.</p>
                    </div>
                    <div class="culture-item">
                        <i class="fas fa-rocket" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3>الابتكار المستدام</h3>
                        <p>نشجع على التفكير الإبداعي وندعم الحلول التي تحدث تطوراً حقيقياً.</p>
                    </div>
                    <div class="culture-item">
                        <i class="fas fa-handshake" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3>التعاون المثمر</h3>
                        <p>نؤمن بقوة العمل الجماعي ونعزز بيئة داعمة وشاملة للجميع.</p>
                    </div>
                     <div class="culture-item">
                        <i class="fas fa-medal" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3>السعي للتميز</h3>
                        <p>نلتزم بأعلى معايير الجودة ونسعى للريادة في مجالنا.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Jobs Section -->
        <section id="jobs" class="section section-observer">
            <div class="container">
                <h2 class="section-title">انضم إلى فريقنا</h2>
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="departmentFilter">القسم</label>
                        <select class="filter-select" id="departmentFilter" aria-label="تصفية حسب القسم">
                            <option value="">جميع الأقسام</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="locationFilter">الموقع</label>
                        <select class="filter-select" id="locationFilter" aria-label="تصفية حسب الموقع">
                            <option value="">جميع المواقع</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">نوع الدوام</label>
                        <select class="filter-select" id="typeFilter" aria-label="تصفية حسب نوع الدوام">
                            <option value="">جميع أنواع الدوام</option>
                        </select>
                    </div>
                </div>
                <div class="jobs-grid" id="jobsGridContainer" aria-live="polite">
                    <!-- Job cards will be injected here by JS -->
                </div>
                <div id="noJobsMessage" style="display:none;" aria-hidden="true">
                    <i class="fas fa-search"></i>
                    <p>عفواً، لا توجد وظائف تطابق معايير البحث الحالية.</p>
                </div>
                <div class="general-apply-cta">
                    <button id="showGeneralApplicationModalBtn" class="btn btn-success">
                        <i class="fas fa-file-import"></i> لم تجد وظيفة مناسبة؟ قدم سيرتك الذاتية
                    </button>
                </div>
            </div>
        </section>

        <!-- Contact Us Section -->
        <section id="contact" class="section contact-section section-observer">
            <div class="container contact-content">
                <h2 class="section-title">تواصل معنا</h2>
                <p>
                    إذا كانت لديك أي استفسارات أو ترغب في معرفة المزيد عن فرص العمل في ميس للمنتجات الطبية، فلا تتردد في التواصل معنا.
                </p>
                <div class="contact-info">
                    <div class="contact-info-item">
                        <i class="fas fa-envelope"></i> البريد الإلكتروني: <a href="mailto:careers@mays-medical.com">careers@mays-medical.com</a>
                    </div>
                    <div class="contact-info-item">
                        <i class="fas fa-phone-alt"></i> الهاتف: <a href="tel:+966112345678" aria-label="اتصل بنا على الرقم +966 11 234 5678">+966 11 234 5678</a> (مثال)
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; <span id="currentYear"></span> ميس للمنتجات الطبية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- Support Chat -->
    <div class="support-chat">
        <button class="chat-toggle-button" id="chatToggleButton" aria-label="فتح نافذة الدردشة المساعدة" aria-expanded="false" aria-controls="chatWindowContainer">
            <i class="fas fa-headset"></i>
        </button>
        <div class="chat-window" id="chatWindowContainer" role="log" aria-live="polite" aria-hidden="true">
            <div class="chat-header">
                <h4>مساعد ميس الذكي</h4>
                <button id="closeChatButton" class="icon-button" aria-label="إغلاق نافذة الدردشة">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-options">
                <button class="chat-option active" id="chatModeTextBtn" data-mode="text" aria-pressed="true">
                    <i class="fas fa-keyboard"></i> كتابي
                </button>
                <button class="chat-option" id="chatModeVoiceBtn" data-mode="voice" aria-pressed="false">
                    <i class="fas fa-microphone-alt"></i> صوتي
                </button>
            </div>
            <div class="chat-messages" id="chatMessagesContainer" tabindex="0" aria-label="رسائل الدردشة">
                <div class="message bot">مرحباً بك! أنا مساعدك الذكي من ميس. كيف يمكنني خدمتك اليوم؟</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInputControl" placeholder="اكتب رسالتك هنا..." aria-label="أدخل رسالتك النصية للدردشة">
                <button id="sendChatMessageBtn" aria-label="إرسال الرسالة النصية">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="voiceRecognitionBtn" aria-label="بدء التسجيل الصوتي" style="display: none;">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- Technical Support Floating Button -->
    <button class="support-toggle-button" id="supportToggleButton" aria-label="فتح نافذة الدعم الفني" type="button">
        <i class="fas fa-life-ring"></i>
    </button>
    <script>
    // دعم فتح وإغلاق نافذة الدعم الفني
    document.addEventListener('DOMContentLoaded', function() {
        var supportBtn = document.getElementById('supportToggleButton');
        var supportModal = document.getElementById('supportModalContainer');
        if (supportBtn && supportModal) {
            supportBtn.addEventListener('click', function(e) {
                supportModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });
        }
        // إغلاق النافذة عند الضغط على زر الإغلاق أو خارج النافذة
        var closeBtn = supportModal ? supportModal.querySelector('.close-modal-btn') : null;
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                supportModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }
        window.addEventListener('click', function(event) {
            if (supportModal && event.target === supportModal) {
                supportModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape" && supportModal && supportModal.style.display === 'flex') {
                supportModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    });
    </script>

    <!-- Modals -->

    <!-- Technical Support Modal -->
    <div class="modal" id="supportModalContainer" role="dialog" aria-labelledby="supportModalTitle" aria-modal="true" style="display:none;">
        <div class="modal-content" style="width: 95%; max-width: 430px; height: 80vh; display: flex; flex-direction: column; padding: 0;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h3 id="supportModalTitle" style="font-size: 1.2rem;">الدعم الفني</h3>
                <button class="close-modal-btn" data-modal-id="supportModalContainer" aria-label="إغلاق نافذة الدعم الفني">&times;</button>
            </div>
            <iframe id="supportIframe" src="pages/supportAI.html" class="support-modal-iframe" allow="microphone; clipboard-write" title="الدعم الفني"></iframe>
        </div>
    </div>
    <!-- Login Modal -->
    <div class="modal" id="loginModalContainer" role="dialog" aria-labelledby="loginModalTitle" aria-modal="true" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="loginModalTitle">تسجيل الدخول</h3>
                <button class="close-modal-btn" data-modal-id="loginModalContainer" aria-label="إغلاق نافذة تسجيل الدخول">&times;</button>
            </div>
            <form id="loginFormElement" novalidate>
                <div class="form-group">
                    <label for="loginEmailInput">البريد الإلكتروني:</label>
                    <input type="email" id="loginEmailInput" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPasswordInput">كلمة المرور:</label>
                    <input type="password" id="loginPasswordInput" required autocomplete="current-password">
                </div>
                <button type="submit" class="submit-btn btn btn-primary">تسجيل الدخول</button>
                <p class="form-link">ليس لديك حساب؟ <a href="pages/signup.html" id="switchToRegisterLink">أنشئ حسابًا</a></p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
     <div class="modal" id="registerModalContainer" role="dialog" aria-labelledby="registerModalTitle" aria-modal="true" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="registerModalTitle">إنشاء حساب جديد</h3>
                <button class="close-modal-btn" data-modal-id="registerModalContainer" aria-label="إغلاق نافذة إنشاء الحساب">&times;</button>
            </div>
            <form id="registerFormElement" novalidate>
                <div class="form-group">
                    <label for="registerNameInput">الاسم الكامل:</label>
                    <input type="text" id="registerNameInput" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="registerEmailInput">البريد الإلكتروني:</label>
                    <input type="email" id="registerEmailInput" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="registerPhoneInput">رقم الهاتف (اختياري):</label>
                    <input type="tel" id="registerPhoneInput" autocomplete="tel" pattern="[0-9\s+]*">
                </div>
                <div class="form-group">
                    <label for="registerPasswordInput">كلمة المرور:</label>
                    <input type="password" id="registerPasswordInput" required minlength="8" autocomplete="new-password" aria-describedby="passwordHelp">
                    <small id="passwordHelp" class="form-text text-muted" style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 4px;">يجب أن تكون كلمة المرور 8 أحرف على الأقل.</small>
                </div>
                <div class="form-group">
                    <label for="confirmPasswordInput">تأكيد كلمة المرور:</label>
                    <input type="password" id="confirmPasswordInput" required minlength="8" autocomplete="new-password">
                </div>
                <button type="submit" class="submit-btn btn btn-primary">إنشاء الحساب</button>
                <p class="form-link">لديك حساب بالفعل؟ <a href="pages/login.html" id="switchToLoginLink">سجل الدخول</a></p>
            </form>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div class="modal" id="jobDetailsModalContainer" role="dialog" aria-labelledby="jobDetailsModalTitle" aria-modal="true" style="display:none;">
        <div class="modal-content large"> <!-- Added 'large' class -->
            <div class="modal-header">
                <h3 id="jobDetailsModalTitle">تفاصيل الوظيفة</h3>
                <button class="close-modal-btn" data-modal-id="jobDetailsModalContainer" aria-label="إغلاق نافذة تفاصيل الوظيفة">&times;</button>
            </div>
            <div id="jobDetailsModalContent" class="modal-body">
                <!-- Dynamic content for job details -->
            </div>
        </div>
    </div>

    <!-- Job Application Modal -->
    <div class="modal" id="jobApplicationModalContainer" role="dialog" aria-labelledby="jobApplicationModalTitleText" aria-modal="true" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="jobApplicationModalTitleText">التقديم على وظيفة: <span class="job-title-placeholder"></span></h3>
                <button class="close-modal-btn" data-modal-id="jobApplicationModalContainer" aria-label="إغلاق نافذة التقديم">&times;</button>
            </div>
            <form id="jobApplicationFormElement" novalidate>
                <input type="hidden" id="applicationJobIdInput">
                <div class="form-group">
                    <label for="applyNameInput">الاسم الكامل:</label>
                    <input type="text" id="applyNameInput" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="applyEmailInput">البريد الإلكتروني:</label>
                    <input type="email" id="applyEmailInput" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="applyPhoneInput">رقم الهاتف:</label>
                    <input type="tel" id="applyPhoneInput" autocomplete="tel" pattern="[0-9\s+]*" required>
                </div>
                <div class="form-group">
                    <label for="applyExperienceInput">سنوات الخبرة (رقم):</label>
                    <input type="number" id="applyExperienceInput" min="0" required>
                </div>
                <div class="form-group">
                    <label for="applyCoverLetterTextarea">رسالة تعريفية (اختياري):</label>
                    <textarea id="applyCoverLetterTextarea" rows="4" maxlength="1000"></textarea>
                </div>
                <div class="form-group">
                    <label for="applyResumeFileInput">رفع السيرة الذاتية (PDF, DOC, DOCX - حد أقصى 5MB):</label>
                    <input type="file" id="applyResumeFileInput" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required>
                    <small id="applyResumeFileError" class="form-error-message"></small>
                </div>
                <button type="submit" class="submit-btn btn btn-primary">إرسال الطلب</button>
            </form>
        </div>
    </div>
    
    <!-- General Application Modal -->
    <div class="modal" id="generalApplicationModalContainer" role="dialog" aria-labelledby="generalApplicationModalTitle" aria-modal="true" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="generalApplicationModalTitle">تقديم عام للسيرة الذاتية</h3>
                <button class="close-modal-btn" data-modal-id="generalApplicationModalContainer" aria-label="إغلاق نافذة التقديم العام">&times;</button>
            </div>
            <form id="generalApplicationFormElement" novalidate>
                 <div class="form-group">
                    <label for="generalApplyNameInput">الاسم الكامل:</label>
                    <input type="text" id="generalApplyNameInput" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="generalApplyEmailInput">البريد الإلكتروني:</label>
                    <input type="email" id="generalApplyEmailInput" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="generalApplyPhoneInput">رقم الهاتف:</label>
                    <input type="tel" id="generalApplyPhoneInput" autocomplete="tel" pattern="[0-9\s+]*" required>
                </div>
                <div class="form-group">
                    <label for="generalDesiredFieldSelect">مجال الاهتمام الرئيسي:</label>
                    <select id="generalDesiredFieldSelect" required>
                        <option value="">-- اختر المجال --</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="generalApplyExperienceInput">سنوات الخبرة (رقم):</label>
                    <input type="number" id="generalApplyExperienceInput" min="0" required>
                </div>
                <div class="form-group">
                    <label for="generalApplyBioTextarea">نبذة مختصرة عنك (اختياري):</label>
                    <textarea id="generalApplyBioTextarea" rows="4" placeholder="مهاراتك، طموحاتك..." maxlength="1000"></textarea>
                </div>
                <div class="form-group">
                    <label for="generalApplyResumeFileInput">رفع السيرة الذاتية (PDF, DOC, DOCX - حد أقصى 5MB):</label>
                    <input type="file" id="generalApplyResumeFileInput" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required>
                     <small id="generalResumeFileError" class="form-error-message"></small>
                </div>
                <button type="submit" class="submit-btn btn btn-primary">إرسال السيرة الذاتية</button>
            </form>
        </div>
    </div>

    <!-- Global Alert Notification Container -->
    <div id="globalAlertContainer"></div>

<!-- Load API Key from local environment file (optional, for development) -->
<script>

/*
 * Mays Medical HR Portal JavaScript
 * Version: 1.1.0
 * Author: AI Assistant (refined from original)
 * Description: Handles dynamic content, user interactions, and API integrations.
 */

// --- Global Application State & Configuration ---
const appState = {
    currentUser: null, // { id, name, email, isAdmin, phone, dateJoined, type }
    jobs: [],
    applications: [], 
    users: [], 
    chat: {
        mode: 'text', // 'text' or 'voice'
        isVoiceListening: false,
        messages: [], // { sender: 'user'/'bot', text: 'message', timestamp: ... }
        aiIsTyping: false,
        isWindowOpen: false,
        lastBotMessage: "", // To avoid repetitive bot messages if AI is slow
    },
    ui: {
        activeModalId: null,
        isUserMenuOpen: false,
        isMobileNavOpen: false,
        alertTimeoutId: null, // To manage alert timeouts
        activeSection: 'home', // For active nav link highlighting
    },
    filters: { 
        departments: [],
        locations: [],
        types: []
    }
};

// Intentionally global for env.local.js to set it if present
var GEMINI_API_KEY_FOR_CHATBOT = "YOUR_GEMINI_API_KEY_PLACEHOLDER"; 

let speechRecognitionInstance = null;

// --- DOM Elements Cache ---
const DOMElements = {};

function cacheDOMElements() {
    DOMElements.pageHeader = document.getElementById('pageHeader');
    DOMElements.userMenuButton = document.getElementById('userMenuButton');
    DOMElements.userDropdownMenu = document.getElementById('userDropdownMenu');
    DOMElements.mobileNavToggle = document.getElementById('mobileNavToggle');
    DOMElements.mainNav = document.getElementById('mainNavMenu'); // Changed selector
    DOMElements.navLinks = document.querySelectorAll('.nav-link'); // For scrollspy

    DOMElements.jobsGridContainer = document.getElementById('jobsGridContainer');
    DOMElements.noJobsMessage = document.getElementById('noJobsMessage');
    DOMElements.departmentFilter = document.getElementById('departmentFilter');
    DOMElements.locationFilter = document.getElementById('locationFilter');
    DOMElements.typeFilter = document.getElementById('typeFilter');
    DOMElements.showGeneralApplicationModalBtn = document.getElementById('showGeneralApplicationModalBtn');

    DOMElements.chatToggleButton = document.getElementById('chatToggleButton');
    DOMElements.chatWindowContainer = document.getElementById('chatWindowContainer');
    DOMElements.closeChatButton = document.getElementById('closeChatButton');
    DOMElements.chatModeTextBtn = document.getElementById('chatModeTextBtn');
    DOMElements.chatModeVoiceBtn = document.getElementById('chatModeVoiceBtn');
    DOMElements.chatMessagesContainer = document.getElementById('chatMessagesContainer');
    DOMElements.chatInputControl = document.getElementById('chatInputControl');
    DOMElements.sendChatMessageBtn = document.getElementById('sendChatMessageBtn');
    DOMElements.voiceRecognitionBtn = document.getElementById('voiceRecognitionBtn');

    DOMElements.loginModalContainer = document.getElementById('loginModalContainer');
    DOMElements.registerModalContainer = document.getElementById('registerModalContainer');
    DOMElements.jobDetailsModalContainer = document.getElementById('jobDetailsModalContainer');
    DOMElements.jobApplicationModalContainer = document.getElementById('jobApplicationModalContainer');
    DOMElements.generalApplicationModalContainer = document.getElementById('generalApplicationModalContainer');

    DOMElements.loginFormElement = document.getElementById('loginFormElement');
    DOMElements.registerFormElement = document.getElementById('registerFormElement');
    DOMElements.jobDetailsModalTitle = document.getElementById('jobDetailsModalTitle');
    DOMElements.jobDetailsModalContent = document.getElementById('jobDetailsModalContent');
    DOMElements.jobApplicationModalTitleSpan = document.querySelector('#jobApplicationModalTitleText .job-title-placeholder');
    DOMElements.applicationJobIdInput = document.getElementById('applicationJobIdInput');
    DOMElements.jobApplicationFormElement = document.getElementById('jobApplicationFormElement');
    DOMElements.generalApplicationFormElement = document.getElementById('generalApplicationFormElement');
    DOMElements.generalDesiredFieldSelect = document.getElementById('generalDesiredFieldSelect');
    
    DOMElements.applyResumeFileInput = document.getElementById('applyResumeFileInput');
    DOMElements.applyResumeFileError = document.getElementById('applyResumeFileError');
    DOMElements.generalApplyResumeFileInput = document.getElementById('generalApplyResumeFileInput');
    DOMElements.generalResumeFileError = document.getElementById('generalResumeFileError');

    DOMElements.globalAlertContainer = document.getElementById('globalAlertContainer');
    DOMElements.currentYearSpan = document.getElementById('currentYear');
}

// --- Application Initialization ---
document.addEventListener('DOMContentLoaded', function() {
    // Check if env.local.js has set the API key
    if (typeof window.DEV_GEMINI_API_KEY !== 'undefined' && window.DEV_GEMINI_API_KEY) {
        GEMINI_API_KEY_FOR_CHATBOT = window.DEV_GEMINI_API_KEY;
    }
    if (GEMINI_API_KEY_FOR_CHATBOT === "YOUR_GEMINI_API_KEY_PLACEHOLDER" || !GEMINI_API_KEY_FOR_CHATBOT) {
        console.warn("Gemini API Key for Chatbot is not configured. Chat AI will use mock responses or be disabled.");
    }
    
    cacheDOMElements();
    loadInitialMockData(); // Load data first
    populateJobFiltersFromData(); // Then populate filters
    renderJobsGrid();
    initializeSpeechRecognitionAPI();
    updateUserMenuDisplay(); // Reflects login state
    addEventListeners();
    checkUserSession(); // Checks localStorage for logged-in user
    initializeScrollSpy();
    
    if (DOMElements.currentYearSpan) {
        DOMElements.currentYearSpan.textContent = new Date().getFullYear();
    }

    // Ensure chat window is hidden initially and ARIA attributes are set
    if (DOMElements.chatWindowContainer) {
        DOMElements.chatWindowContainer.classList.remove('show');
        DOMElements.chatWindowContainer.setAttribute('aria-hidden', 'true');
        appState.chat.isWindowOpen = false;
        DOMElements.chatToggleButton?.setAttribute('aria-expanded', 'false');
    }
});

function addEventListeners() {
    window.addEventListener('scroll', handleHeaderScroll);
    window.addEventListener('scroll', handleScrollSpy); // For nav link highlighting

    DOMElements.userMenuButton?.addEventListener('click', () => toggleUserMenu());
    DOMElements.mobileNavToggle?.addEventListener('click', () => toggleMobileNav());

    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.dataset.modalId;
            if (modalId) closeModal(modalId);
        });
    });
    
    // Dynamic links in user dropdown and form links
    document.addEventListener('click', (event) => {
        const target = event.target.closest('a[data-action], button[data-action]');
        if (target && target.dataset.action) {
            event.preventDefault();
            const action = target.dataset.action;
            if (action === 'showLoginModal') showLoginModal();
            else if (action === 'showRegisterModal') showRegisterModal();
            else if (action === 'logout') userLogout();
            else if (action === 'adminDashboard') window.location.href = 'page/dashboard/dashboard.html'; // Example
        }
    });

    DOMElements.chatToggleButton?.addEventListener('click', () => toggleChatWindow()); // Simplified toggle
    DOMElements.closeChatButton?.addEventListener('click', () => toggleChatWindow(false));
    DOMElements.chatModeTextBtn?.addEventListener('click', () => selectChatMode('text'));
    DOMElements.chatModeVoiceBtn?.addEventListener('click', () => selectChatMode('voice'));
    DOMElements.sendChatMessageBtn?.addEventListener('click', sendUserChatMessage);
    DOMElements.chatInputControl?.addEventListener('keypress', handleChatInputKeyPress);
    DOMElements.voiceRecognitionBtn?.addEventListener('click', toggleVoiceRecognition);

    DOMElements.departmentFilter?.addEventListener('change', renderJobsGrid);
    DOMElements.locationFilter?.addEventListener('change', renderJobsGrid);
    DOMElements.typeFilter?.addEventListener('change', renderJobsGrid);
    DOMElements.showGeneralApplicationModalBtn?.addEventListener('click', openGeneralApplicationModal);

    DOMElements.loginFormElement?.addEventListener('submit', handleUserLogin);
    DOMElements.registerFormElement?.addEventListener('submit', handleUserRegister);
    DOMElements.jobApplicationFormElement?.addEventListener('submit', handleSpecificJobApplication);
    DOMElements.generalApplicationFormElement?.addEventListener('submit', handleGeneralCvSubmission);

    DOMElements.applyResumeFileInput?.addEventListener('change', () => validateResumeFile(DOMElements.applyResumeFileInput, DOMElements.applyResumeFileError));
    DOMElements.generalApplyResumeFileInput?.addEventListener('change', () => validateResumeFile(DOMElements.generalApplyResumeFileInput, DOMElements.generalResumeFileError));

    window.addEventListener('click', handleOutsideClicks);
    document.addEventListener('keydown', handleGlobalKeyDown);

    DOMElements.navLinks?.forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                // Smooth scroll to section
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close mobile nav if open
                if (appState.ui.isMobileNavOpen) toggleMobileNav(false);
                // Manually update active link (scroll spy will also do this, but this is immediate)
                updateActiveNavLink(this.dataset.section);
            }
        });
    });
}

// --- UI Interaction & State Management ---
function handleHeaderScroll() {
    DOMElements.pageHeader?.classList.toggle('scrolled', window.scrollY > 50);
}

function toggleUserMenu(forceState) {
    const isOpen = typeof forceState === 'boolean' ? forceState : !appState.ui.isUserMenuOpen;
    DOMElements.userDropdownMenu?.classList.toggle('show', isOpen);
    appState.ui.isUserMenuOpen = isOpen;
    DOMElements.userMenuButton?.setAttribute('aria-expanded', isOpen.toString());
}

function toggleMobileNav(forceState) {
    const isOpen = typeof forceState === 'boolean' ? forceState : !appState.ui.isMobileNavOpen;
    appState.ui.isMobileNavOpen = isOpen;
    DOMElements.mainNav?.classList.toggle('mobile-active', isOpen);
    DOMElements.mobileNavToggle?.setAttribute('aria-expanded', isOpen.toString());
    if (DOMElements.mobileNavToggle) {
        DOMElements.mobileNavToggle.querySelector('i').className = isOpen ? 'fas fa-times' : 'fas fa-bars';
    }
    document.body.classList.toggle('mobile-nav-open', isOpen);
}

function handleOutsideClicks(event) {
    if (appState.ui.isUserMenuOpen && DOMElements.userMenuButton && 
        !DOMElements.userMenuButton.contains(event.target) && 
        DOMElements.userDropdownMenu && !DOMElements.userDropdownMenu.contains(event.target)) {
        toggleUserMenu(false);
    }
    // Mobile nav usually closes on item click, or via toggle, so specific outside click handling might not be needed
    // if it's a full-screen overlay.
}

function handleGlobalKeyDown(event) {
    if (event.key === "Escape") {
        if (appState.ui.activeModalId) {
            closeModal(appState.ui.activeModalId);
        } else if (appState.chat.isWindowOpen) {
            toggleChatWindow(false);
        } else if (appState.ui.isUserMenuOpen) {
            toggleUserMenu(false);
        } else if (appState.ui.isMobileNavOpen) {
            toggleMobileNav(false);
        }
    }
}

// --- ScrollSpy for Active Navigation Link ---
function initializeScrollSpy() {
    const sections = document.querySelectorAll('.section-observer');
    const observerOptions = {
        root: null, // viewport
        rootMargin: `-${(DOMElements.pageHeader?.offsetHeight || 70) + 10}px 0px 0px 0px`, // Offset by header height + a bit
        threshold: 0.4 // Trigger when 40% of the section is visible
    };

    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                updateActiveNavLink(entry.target.id);
            }
        });
    }, observerOptions);

    sections.forEach(section => sectionObserver.observe(section));
}

function updateActiveNavLink(sectionId) {
    appState.ui.activeSection = sectionId;
    DOMElements.navLinks?.forEach(link => {
        link.classList.toggle('active-link', link.dataset.section === sectionId);
    });
}


// --- Mock Data & Initialization ---
function loadInitialMockData() {
    // Enhanced Mock Data
    appState.jobs = [
        { id: 'J001', title: 'مطور واجهة أمامية أول (Senior Frontend Developer)', department: 'تطوير البرمجيات', location: 'الرياض', type: 'دوام كامل', datePosted: '2024-07-28', description: 'نبحث عن مطور واجهة أمامية محترف يتمتع بخبرة واسعة في بناء تطبيقات ويب تفاعلية باستخدام أحدث التقنيات. ستكون مسؤولاً عن قيادة تطوير الواجهات الأمامية، وضمان جودة الكود، والتعاون مع فرق التصميم والـ backend.', responsibilities: ['قيادة تصميم وتنفيذ واجهات مستخدم متقدمة باستخدام React و TypeScript.', 'تحسين أداء وسرعة تحميل التطبيقات لضمان أفضل تجربة مستخدم.', 'كتابة كود نظيف، قابل للصيانة، وموثق بشكل جيد وفقًا لأفضل الممارسات.', 'مراجعة كود الزملاء وتقديم التوجيه والإرشاد الفني.', 'البقاء على اطلاع دائم بأحدث اتجاهات وتقنيات تطوير الواجهات الأمامية.'], qualifications: ['خبرة لا تقل عن 5 سنوات في تطوير الواجهات الأمامية.', 'إتقان HTML5, CSS3, JavaScript (ES6+), و TypeScript.', 'خبرة عميقة ومثبتة في React (Hooks, Context API, Redux/Zustand).', 'فهم جيد لـ RESTful APIs وكيفية التفاعل معها بكفاءة.', 'خبرة في أدوات بناء (Webpack/Vite) واختبار الواجهات الأمامية (Jest, React Testing Library).', 'قدرة على العمل بشكل مستقل وضمن فريق.'], skills: ['React', 'TypeScript', 'JavaScript', 'HTML5', 'CSS3/SASS', 'Redux', 'Jest', 'Git', 'Agile Development', 'Problem Solving', 'Leadership'] },
        { id: 'J002', title: 'أخصائي تسويق منتجات طبية', department: 'التسويق', location: 'جدة', type: 'دوام كامل', datePosted: '2024-07-25', description: 'نسعى لتوظيف أخصائي تسويق منتجات طبية مبدع لإدارة وتطوير استراتيجيات التسويق لمنتجاتنا الطبية المبتكرة، وزيادة الوعي بالعلامة التجارية في السوق السعودي.', responsibilities: ['تطوير وتنفيذ خطط التسويق للمنتجات الطبية الجديدة والحالية.', 'إجراء أبحاث السوق وتحليل المنافسين لتحديد الفرص والتحديات.', 'إنشاء محتوى تسويقي جذاب (كتيبات، عروض تقديمية، محتوى رقمي).', 'تنظيم والمشاركة في الفعاليات والمعارض الطبية.', 'بناء علاقات قوية مع قادة الرأي في المجال الطبي.'], qualifications: ['شهادة جامعية في التسويق، الصيدلة، أو مجال طبي ذي صلة.', 'خبرة عملية لا تقل عن 3 سنوات في تسويق المنتجات الطبية أو الأدوية.', 'فهم عميق للسوق الطبي السعودي والمتطلبات التنظيمية.', 'مهارات تواصل وعرض ممتازة باللغتين العربية والإنجليزية.'], skills: ['Product Marketing', 'Medical Devices', 'Pharmaceutical Marketing', 'Market Research', 'Content Creation', 'Event Management', 'Communication Skills'] },
        { id: 'J003', title: 'مهندس أجهزة طبية (خريج حديث)', department: 'الهندسة الطبية', location: 'الدمام', type: 'تدريب', datePosted: '2024-07-22', description: 'فرصة تدريب للخريجين الجدد في مجال الهندسة الطبية للمساهمة في تصميم واختبار أجهزة طبية مبتكرة تحت إشراف فريق من المهندسين الخبراء.', responsibilities: ['المساعدة في تصميم وتطوير نماذج أولية للأجهزة الطبية.', 'إجراء الاختبارات والفحوصات على الأجهزة.', 'توثيق نتائج الاختبارات والمساهمة في إعداد التقارير الفنية.', 'الالتزام بمعايير الجودة والسلامة.'], qualifications: ['حديث التخرج بدرجة البكالوريوس في الهندسة الطبية أو هندسة الإلكترونيات/الميكانيكا.', 'شغف بمجال الأجهزة الطبية والابتكار.', 'قدرة على التعلم السريع والعمل ضمن فريق.', 'مهارات تواصل جيدة باللغتين العربية والإنجليزية.'], skills: ['CAD (SolidWorks/AutoCAD)', 'Microcontrollers', 'Problem Solving', 'Teamwork', 'Technical Writing', 'Prototyping'] },
        { id: 'J004', title: 'مدير حسابات عملاء (قطاع الأدوية)', department: 'المبيعات', location: 'عن بُعد', type: 'دوام كامل', datePosted: '2024-07-20', description: 'نبحث عن مدير حسابات ذو خبرة في قطاع الأدوية لإدارة وتنمية العلاقات مع العملاء الرئيسيين. العمل يتطلب زيارات ميدانية وتواصل عن بعد لخدمة العملاء في مختلف مناطق المملكة.', responsibilities: ['تحقيق أهداف المبيعات المحددة للمنطقة.', 'بناء وتوطيد علاقات قوية ومستدامة مع العملاء الحاليين والمحتملين.', 'تقديم عروض تقديمية احترافية عن منتجات الشركة وفوائدها.', 'متابعة اتجاهات السوق وأنشطة المنافسين لتقديم توصيات استراتيجية.'], qualifications: ['شهادة جامعية في الصيدلة، إدارة الأعمال أو مجال ذي صلة.', 'خبرة لا تقل عن 4 سنوات في مبيعات الأدوية أو المنتجات الطبية.', 'سجل حافل بالإنجازات في تحقيق أهداف المبيعات.', 'مهارات تفاوض وإقناع ممتازة.'], skills: ['Pharmaceutical Sales', 'Account Management', 'Negotiation', 'CRM Software', 'Communication', 'Territory Management'] }
    ];
    appState.users = [
        { id: 'U001', name: 'المدير يزيد', email: 'admin@login.com', phone: '0501234567', dateJoined: '2023-01-01', type: 'مدير', passwordHash: 'admin13579', isAdmin: true },
        { id: 'U002', name: 'سالم الموظف', email: 'salem@mays.com', phone: '0512223333', dateJoined: '2023-06-10', type: 'موظف', passwordHash: 'salem123', isAdmin: false }
    ];
    appState.applications = []; 
}

function populateJobFiltersFromData() {
    if (!appState.jobs || appState.jobs.length === 0) return;

    const departments = [...new Set(appState.jobs.map(job => job.department))].sort();
    const locations = [...new Set(appState.jobs.map(job => job.location))].sort();
    const types = [...new Set(appState.jobs.map(job => job.type))].sort();

    appState.filters.departments = departments;
    appState.filters.locations = locations;
    appState.filters.types = types;

    populateSelectWithOptions(DOMElements.departmentFilter, departments, "جميع الأقسام");
    populateSelectWithOptions(DOMElements.locationFilter, locations, "جميع المواقع");
    populateSelectWithOptions(DOMElements.typeFilter, types, "جميع أنواع الدوام");
    
    // Populate general application desired field select, excluding "أخرى" if already present
    const uniqueDepartmentsForGeneral = departments.filter(dep => dep.toLowerCase() !== 'أخرى');
    populateSelectWithOptions(DOMElements.generalDesiredFieldSelect, uniqueDepartmentsForGeneral, "-- اختر المجال --");
    if (DOMElements.generalDesiredFieldSelect && !uniqueDepartmentsForGeneral.includes('أخرى')) {
         DOMElements.generalDesiredFieldSelect.add(new Option('أخرى', 'أخرى'));
    }
}

function populateSelectWithOptions(selectElement, optionsArray, defaultOptionText = "") {
    if (!selectElement) return;
    
    // Preserve the first option if it's the default placeholder
    const firstOptionValue = selectElement.options.length > 0 ? selectElement.options[0].value : "";
    selectElement.innerHTML = ''; // Clear all existing options

    if (defaultOptionText) {
        const defaultOpt = new Option(defaultOptionText, "");
        if (firstOptionValue === "") defaultOpt.selected = true; // Reselect if it was the original default
        selectElement.add(defaultOpt);
    }

    optionsArray.forEach(optValue => {
        if (optValue) { // Ensure optValue is not null or empty before adding
            selectElement.add(new Option(optValue, optValue));
        }
    });
}

// --- UI Rendering & Updates ---
function renderJobsGrid() {
    if (!DOMElements.jobsGridContainer || !DOMElements.noJobsMessage) return;
    DOMElements.jobsGridContainer.innerHTML = ''; // Clear previous jobs

    const departmentFilter = DOMElements.departmentFilter?.value || "";
    const locationFilter = DOMElements.locationFilter?.value || "";
    const typeFilter = DOMElements.typeFilter?.value || "";

    const filteredJobs = appState.jobs.filter(job =>
        (!departmentFilter || job.department === departmentFilter) &&
        (!locationFilter || job.location === locationFilter) &&
        (!typeFilter || job.type === typeFilter)
    );

    if (filteredJobs.length === 0) {
        DOMElements.noJobsMessage.style.display = 'block';
        DOMElements.noJobsMessage.setAttribute('aria-hidden', 'false');
        DOMElements.jobsGridContainer.setAttribute('aria-busy', 'false');
        return;
    }
    DOMElements.noJobsMessage.style.display = 'none';
    DOMElements.noJobsMessage.setAttribute('aria-hidden', 'true');
    DOMElements.jobsGridContainer.setAttribute('aria-busy', 'true'); // Announce content is loading

    const fragment = document.createDocumentFragment();
    filteredJobs.forEach(job => {
        const card = document.createElement('div');
        card.className = 'job-card';
        card.setAttribute('role', 'article');
        card.setAttribute('aria-labelledby', `job-title-${job.id}`);
        
        card.innerHTML = `
            <h3 class="job-title" id="job-title-${job.id}">${job.title}</h3>
            <div class="job-department">${job.department}</div>
            <div class="job-details">
                <span class="job-detail"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> ${job.location}</span>
                <span class="job-detail"><i class="fas fa-briefcase" aria-hidden="true"></i> ${job.type}</span>
                 <span class="job-detail"><i class="fas fa-calendar-alt" aria-hidden="true"></i> ${new Date(job.datePosted).toLocaleDateString('ar-SA')}</span>
            </div>
            <p class="job-description-snippet">${job.description.substring(0, 120)}...</p>
            <div class="job-actions">
                <button class="btn details-btn" data-job-id="${job.id}" aria-label="عرض تفاصيل وظيفة ${job.title}">عرض التفاصيل</button>
                <button class="btn apply-btn-in-card" data-job-id="${job.id}" aria-label="التقديم على وظيفة ${job.title}">قدم الآن</button>
            </div>
        `;
        // Add event listeners directly to buttons on creation
        card.querySelector('.details-btn').addEventListener('click', () => openJobDetailsModal(job.id));
        card.querySelector('.apply-btn-in-card').addEventListener('click', () => openJobApplicationModal(job.id));
        fragment.appendChild(card);
    });
    DOMElements.jobsGridContainer.appendChild(fragment);
    DOMElements.jobsGridContainer.setAttribute('aria-busy', 'false'); // Announce content has loaded
}

function updateUserMenuDisplay() {
    if (!DOMElements.userDropdownMenu || !DOMElements.userMenuButton) return;
    const userIcon = DOMElements.userMenuButton.querySelector('i');

    if (appState.currentUser) {
        userIcon.className = 'fas fa-user-check user-icon-loggedin'; // Specific class for logged-in state
        DOMElements.userMenuButton.setAttribute('aria-label', `قائمة المستخدم: ${appState.currentUser.name}`);
        DOMElements.userDropdownMenu.innerHTML = `
            <div class="dropdown-menu-header">
                <strong>${appState.currentUser.name}</strong>
                <small>${appState.currentUser.email}</small>
            </div>
            ${appState.currentUser.isAdmin ? `<a href="#" role="menuitem" data-action="adminDashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>` : ''}
            <a href="#" role="menuitem" data-action="logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
        `;
    } else {
        userIcon.className = 'fas fa-user-circle';
        DOMElements.userMenuButton.setAttribute('aria-label', 'قائمة المستخدم');
        DOMElements.userDropdownMenu.innerHTML = `
            <a href="#" role="menuitem" data-action="showLoginModal"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</a>
            <a href="#" role="menuitem" data-action="showRegisterModal"><i class="fas fa-user-plus"></i> إنشاء حساب</a>
        `;
    }
}

// --- Modal Handling ---
function openModal(modalId) {
    if (appState.ui.activeModalId) {
        closeModal(appState.ui.activeModalId); // Close any currently open modal
    }
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        appState.ui.activeModalId = modalId;
        document.body.style.overflow = 'hidden'; // Prevent background scroll
        // Focus on the first focusable element in the modal
        const firstFocusable = modal.querySelector('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])');
        firstFocusable?.focus();
    } else {
        console.error(`Modal with id "${modalId}" not found.`);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
    if (appState.ui.activeModalId === modalId) {
        appState.ui.activeModalId = null;
        document.body.style.overflow = 'auto'; // Restore background scroll
        // Return focus to the element that opened the modal, if applicable (more advanced)
    }
}

function showLoginModal() { openModal('loginModalContainer'); }
function showRegisterModal() { openModal('registerModalContainer'); }

function openJobDetailsModal(jobId) {
    const job = appState.jobs.find(j => j.id === jobId);
    if (!job || !DOMElements.jobDetailsModalTitle || !DOMElements.jobDetailsModalContent) {
        displayAlert('لم يتم العثور على تفاصيل الوظيفة.', 'error');
        return;
    }
    DOMElements.jobDetailsModalTitle.textContent = job.title;
    
    // Sanitize and format lists
    const formatList = (items) => {
        if (!items) return '<li>غير محدد</li>';
        return (Array.isArray(items) ? items : [items]).map(item => `<li>${escapeHTML(item)}</li>`).join('');
    };

    DOMElements.jobDetailsModalContent.innerHTML = `
        <p><strong>القسم:</strong> ${escapeHTML(job.department)}</p>
        <p><strong>الموقع:</strong> ${escapeHTML(job.location)}</p>
        <p><strong>نوع الدوام:</strong> ${escapeHTML(job.type)}</p>
        <p><strong>تاريخ النشر:</strong> ${new Date(job.datePosted).toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
        <hr style="margin: 1rem 0;">
        <h4>الوصف الوظيفي:</h4>
        <p style="white-space: pre-wrap;">${escapeHTML(job.description)}</p>
        ${job.responsibilities ? `<h4 style="margin-top:1rem;">المسؤوليات:</h4><ul style="padding-right: 20px;">${formatList(job.responsibilities)}</ul>` : ''}
        ${job.qualifications ? `<h4 style="margin-top:1rem;">المؤهلات:</h4><ul style="padding-right: 20px;">${formatList(job.qualifications)}</ul>` : ''}
        ${job.skills ? `<h4 style="margin-top:1rem;">المهارات المطلوبة:</h4><p>${Array.isArray(job.skills) ? job.skills.map(escapeHTML).join(', ') : escapeHTML(job.skills)}</p>` : ''}
        <div style="margin-top: 2rem; text-align: center;">
            <button class="btn cta-button" id="applyFromDetailsBtn" data-job-id="${job.id}">
                <i class="fas fa-paper-plane"></i> قدم على هذه الوظيفة
            </button>
        </div>
    `;
    // Add event listener to the newly created button
    document.getElementById('applyFromDetailsBtn')?.addEventListener('click', () => {
        openJobApplicationModal(job.id);
        closeModal('jobDetailsModalContainer');
    });
    openModal('jobDetailsModalContainer');
}

function openJobApplicationModal(jobId) {
    const job = appState.jobs.find(j => j.id === jobId);
    if (!job || !DOMElements.jobApplicationModalTitleSpan || !DOMElements.applicationJobIdInput || !DOMElements.jobApplicationFormElement) {
        displayAlert('خطأ في تهيئة نموذج التقديم.', 'error');
        return;
    }
    DOMElements.jobApplicationModalTitleSpan.textContent = job.title;
    DOMElements.applicationJobIdInput.value = jobId;
    
    const form = DOMElements.jobApplicationFormElement;
    form.reset(); // Clear form fields
    clearFormErrors(form); // Clear any previous error messages

    // Pre-fill form if user is logged in
    if (appState.currentUser && !appState.currentUser.isAdmin) {
        form.elements['applyNameInput'].value = appState.currentUser.name || '';
        form.elements['applyEmailInput'].value = appState.currentUser.email || '';
        form.elements['applyPhoneInput'].value = appState.currentUser.phone || '';
    }
    openModal('jobApplicationModalContainer');
}

function openGeneralApplicationModal() {
    if (!DOMElements.generalApplicationFormElement) {
        displayAlert('خطأ في تهيئة نموذج التقديم العام.', 'error');
        return;
    }
    const form = DOMElements.generalApplicationFormElement;
    form.reset();
    clearFormErrors(form);

    if (appState.currentUser && !appState.currentUser.isAdmin) {
        form.elements['generalApplyNameInput'].value = appState.currentUser.name || '';
        form.elements['generalApplyEmailInput'].value = appState.currentUser.email || '';
        form.elements['generalApplyPhoneInput'].value = appState.currentUser.phone || '';
    }
    openModal('generalApplicationModalContainer');
}

// --- User Authentication & Session ---
function handleUserLogin(event) {
    event.preventDefault();
    const form = event.target;
    const email = form.elements['loginEmailInput'].value.trim();
    const password = form.elements['loginPasswordInput'].value;

    if (!email || !password) {
        displayAlert('يرجى إدخال البريد الإلكتروني وكلمة المرور.', 'error');
        return;
    }

    // Special case for hardcoded admin for demo
    if (email === 'admin@login.com' && password === 'admin13579') {
        const adminUser = appState.users.find(u => u.email === email && u.isAdmin);
        appState.currentUser = adminUser || { id:'ADMIN_RUNTIME', name: 'المدير يزيد', email: email, isAdmin: true, phone: 'N/A', dateJoined: new Date().toISOString().split('T')[0], type: 'مدير' };
        if (!adminUser && appState.currentUser.id === 'ADMIN_RUNTIME') { // Add if dynamically created
             appState.users.push(appState.currentUser);
        }
        
        localStorage.setItem('yzUserSession', JSON.stringify(appState.currentUser));
        displayAlert('تم تسجيل الدخول كمدير بنجاح! جاري توجيهك...', 'success');
        setTimeout(() => {
            closeModal('loginModalContainer');
            updateUserMenuDisplay();
            window.location.href = 'page/dashboard/dashboard.html'; // Redirect to dashboard
        }, 1200);
        return;
    }
    
    const user = appState.users.find(u => u.email === email && u.passwordHash === password && !u.isAdmin);
    if (user) {
        appState.currentUser = { ...user, isAdmin: false }; // Ensure isAdmin is explicitly false
        localStorage.setItem('yzUserSession', JSON.stringify(appState.currentUser));
        displayAlert('تم تسجيل الدخول بنجاح!', 'success');
        closeModal('loginModalContainer');
        updateUserMenuDisplay();
    } else {
        displayAlert('بيانات الدخول غير صحيحة. يرجى المحاولة مرة أخرى.', 'error');
    }
}

function handleUserRegister(event) {
    event.preventDefault();
    const form = event.target;
    const name = form.elements['registerNameInput'].value.trim();
    const email = form.elements['registerEmailInput'].value.trim();
    const phone = form.elements['registerPhoneInput'].value.trim();
    const password = form.elements['registerPasswordInput'].value;
    const confirmPassword = form.elements['confirmPasswordInput'].value;

    if (!name || !email || !password || !confirmPassword) {
        displayAlert('يرجى ملء جميع الحقول المطلوبة.', 'error'); return;
    }
    if (password.length < 8) { 
        displayAlert('كلمة المرور يجب أن لا تقل عن 8 أحرف.', 'error'); return; 
    }
    if (password !== confirmPassword) { 
        displayAlert('كلمتا المرور غير متطابقتين!', 'error'); return; 
    }
    if (appState.users.find(u => u.email === email)) { 
        displayAlert('هذا البريد الإلكتروني مسجل مسبقاً!', 'error'); return; 
    }

    const newUser = {
        id: 'U' + String(Date.now()).slice(-4) + Math.random().toString(36).substr(2, 2), // More unique ID
        name, email, phone,
        dateJoined: new Date().toISOString().split('T')[0],
        type: 'مستخدم', passwordHash: password, // In real app, hash this password
        isAdmin: false
    };
    appState.users.push(newUser);
    appState.currentUser = newUser; // Auto-login new user
    localStorage.setItem('yzUserSession', JSON.stringify(appState.currentUser));
    // localStorage.setItem('yzMockUsers', JSON.stringify(appState.users)); // Persist users for mock
    displayAlert('تم إنشاء حسابك بنجاح! مرحباً بك.', 'success');
    closeModal('registerModalContainer');
    updateUserMenuDisplay();
}

function userLogout() {
    appState.currentUser = null;
    localStorage.removeItem('yzUserSession');
    displayAlert('تم تسجيل الخروج بنجاح.', 'info');
    updateUserMenuDisplay();
    if (DOMElements.userDropdownMenu?.classList.contains('show')) {
        toggleUserMenu(false); // Close dropdown if open
    }
    // If on an admin page, redirect to home
    if (window.location.pathname.includes('/dashboard.html')) {
        window.location.href = '../../Oooo.html'; // Adjust path as needed
    }
}

function checkUserSession() {
    const sessionData = localStorage.getItem('yzUserSession');
    if (sessionData) {
        try {
            const userData = JSON.parse(sessionData);
            // Basic validation of stored user data
            if (userData && userData.id && userData.email) {
                appState.currentUser = userData;
                updateUserMenuDisplay();
            } else {
                localStorage.removeItem('yzUserSession'); // Clear invalid session
            }
        } catch (e) {
            console.error("Error parsing session data:", e);
            localStorage.removeItem('yzUserSession');
        }
    }
}

// --- Job Application & File Handling ---
function validateResumeFile(fileInput, errorElement) {
    if (!fileInput || !errorElement) return false;
    errorElement.textContent = ''; // Clear previous errors

    const file = fileInput.files[0];
    if (!file) {
        errorElement.textContent = 'يرجى اختيار ملف السيرة الذاتية.';
        fileInput.setAttribute('aria-invalid', 'true');
        return false;
    }
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!allowedTypes.includes(file.type)) {
        errorElement.textContent = 'صيغة الملف غير مدعومة. يرجى استخدام PDF, DOC, أو DOCX.';
        fileInput.setAttribute('aria-invalid', 'true');
        return false;
    }
    const maxSizeMB = 5;
    if (file.size > maxSizeMB * 1024 * 1024) {
        errorElement.textContent = `حجم الملف يتجاوز الحد المسموح به (${maxSizeMB}MB).`;
        fileInput.setAttribute('aria-invalid', 'true');
        return false;
    }
    fileInput.setAttribute('aria-invalid', 'false');
    return true;
}

function handleSpecificJobApplication(event) {
    event.preventDefault();
    const form = event.target;
    if (!validateResumeFile(DOMElements.applyResumeFileInput, DOMElements.applyResumeFileError)) return;

    // Additional form validation for other fields
    if (!form.elements['applyNameInput'].value.trim() || !form.elements['applyEmailInput'].value.trim() ||
        !form.elements['applyPhoneInput'].value.trim() || !form.elements['applyExperienceInput'].value) {
        displayAlert('يرجى ملء جميع الحقول المطلوبة.', 'error');
        return;
    }

    const jobId = DOMElements.applicationJobIdInput.value;
    const job = appState.jobs.find(j => j.id === jobId);
    const applicationData = {
        id: 'APP' + String(Date.now()).slice(-5) + Math.random().toString(36).substr(2, 2),
        applicantName: form.elements['applyNameInput'].value.trim(),
        applicantEmail: form.elements['applyEmailInput'].value.trim(),
        applicantPhone: form.elements['applyPhoneInput'].value.trim(),
        experience: parseInt(form.elements['applyExperienceInput'].value, 10),
        coverLetter: form.elements['applyCoverLetterTextarea'].value.trim(),
        resumeFileName: DOMElements.applyResumeFileInput.files[0].name,
        jobId: jobId,
        jobTitle: job ? job.title : 'N/A',
        dateApplied: new Date().toISOString().split('T')[0],
        status: 'قيد المراجعة'
    };
    appState.applications.push(applicationData);
    // localStorage.setItem('yzMockApplications', JSON.stringify(appState.applications)); 
    displayAlert('تم إرسال طلب التوظيف بنجاح! سيتم التواصل معك قريباً.', 'success');
    closeModal('jobApplicationModalContainer');
    form.reset();
    clearFormErrors(form);
}

function handleGeneralCvSubmission(event) {
    event.preventDefault();
    const form = event.target;
    if (!validateResumeFile(DOMElements.generalApplyResumeFileInput, DOMElements.generalResumeFileError)) return;

    if (!form.elements['generalApplyNameInput'].value.trim() || !form.elements['generalApplyEmailInput'].value.trim() ||
        !form.elements['generalApplyPhoneInput'].value.trim() || !form.elements['generalDesiredFieldSelect'].value ||
        !form.elements['generalApplyExperienceInput'].value) {
        displayAlert('يرجى ملء جميع الحقول المطلوبة.', 'error');
        return;
    }

     const generalApplicationData = {
        id: 'GEN' + String(Date.now()).slice(-5) + Math.random().toString(36).substr(2, 2),
        applicantName: form.elements['generalApplyNameInput'].value.trim(),
        applicantEmail: form.elements['generalApplyEmailInput'].value.trim(),
        applicantPhone: form.elements['generalApplyPhoneInput'].value.trim(),
        desiredField: form.elements['generalDesiredFieldSelect'].value,
        experience: parseInt(form.elements['generalApplyExperienceInput'].value, 10),
        bio: form.elements['generalApplyBioTextarea'].value.trim(),
        resumeFileName: DOMElements.generalApplyResumeFileInput.files[0].name,
        jobId: null, jobTitle: 'تقديم عام', // Indicates a general application
        dateApplied: new Date().toISOString().split('T')[0],
        status: 'تقديم عام محفوظ'
    };
    appState.applications.push(generalApplicationData);
    // localStorage.setItem('yzMockApplications', JSON.stringify(appState.applications));
    displayAlert('تم إرسال سيرتك الذاتية بنجاح! شكراً لاهتمامك.', 'success');
    closeModal('generalApplicationModalContainer');
    form.reset();
    clearFormErrors(form);
}

// --- Chat Functionality ---
function toggleChatWindow(forceState) {
    const isOpen = typeof forceState === 'boolean' ? forceState : !appState.chat.isWindowOpen;
    appState.chat.isWindowOpen = isOpen;
    DOMElements.chatWindowContainer?.classList.toggle('show', isOpen);
    DOMElements.chatWindowContainer?.setAttribute('aria-hidden', (!isOpen).toString());
    DOMElements.chatToggleButton?.setAttribute('aria-expanded', isOpen.toString());

    if (isOpen) {
        if (appState.chat.mode === 'text' && DOMElements.chatInputControl) {
            DOMElements.chatInputControl.focus();
        }
        DOMElements.chatMessagesContainer?.scrollTo(0, DOMElements.chatMessagesContainer.scrollHeight);
    } else {
        // Stop voice recognition if window is closed
        if (appState.chat.isVoiceListening && speechRecognitionInstance) {
            speechRecognitionInstance.stop();
        }
    }
}

function selectChatMode(mode) {
    if (!DOMElements.chatInputControl || !DOMElements.voiceRecognitionBtn || !DOMElements.sendChatMessageBtn ||
        !DOMElements.chatModeTextBtn || !DOMElements.chatModeVoiceBtn) return;

    appState.chat.mode = mode;
    const isTextMode = mode === 'text';

    DOMElements.chatInputControl.style.display = isTextMode ? 'block' : 'none';
    DOMElements.sendChatMessageBtn.style.display = isTextMode ? 'flex' : 'none';
    DOMElements.voiceRecognitionBtn.style.display = !isTextMode ? 'flex' : 'none';
    
    DOMElements.chatModeTextBtn.classList.toggle('active', isTextMode);
    DOMElements.chatModeVoiceBtn.classList.toggle('active', !isTextMode);
    DOMElements.chatModeTextBtn.setAttribute('aria-pressed', isTextMode.toString());
    DOMElements.chatModeVoiceBtn.setAttribute('aria-pressed', (!isTextMode).toString());

    if (appState.chat.isVoiceListening && speechRecognitionInstance) {
        speechRecognitionInstance.stop(); // Stop listening if switching modes
    }
    if (isTextMode) DOMElements.chatInputControl.focus();
}

function handleChatInputKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendUserChatMessage();
    }
}

function sendUserChatMessage() {
    if (!DOMElements.chatInputControl) return;
    const messageText = DOMElements.chatInputControl.value.trim();
    if (!messageText) return;
    
    appendChatMessage(messageText, 'user');
    appState.chat.messages.push({ sender: 'user', text: messageText, timestamp: new Date() });
    DOMElements.chatInputControl.value = '';
    DOMElements.chatInputControl.focus();
    
    processUserMessageWithAI(messageText);
}

function appendChatMessage(text, sender, isLoading = false) {
    if (!DOMElements.chatMessagesContainer) return null;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message', sender);
    if (isLoading) {
        messageElement.classList.add('loading-dots');
        messageElement.setAttribute('aria-label', 'المساعد يكتب الآن');
        messageElement.innerHTML = `<span></span><span></span><span></span>`; // Simpler spans
    } else {
        messageElement.textContent = escapeHTML(text); // Sanitize text before rendering
    }
    DOMElements.chatMessagesContainer.appendChild(messageElement);
    // Scroll to the bottom of the chat messages
    DOMElements.chatMessagesContainer.scrollTop = DOMElements.chatMessagesContainer.scrollHeight;
    return messageElement;
}

async function processUserMessageWithAI(userMessage) {
    if (appState.chat.aiIsTyping) return; // Prevent multiple simultaneous requests

    if (GEMINI_API_KEY_FOR_CHATBOT === "YOUR_GEMINI_API_KEY_PLACEHOLDER" || !GEMINI_API_KEY_FOR_CHATBOT) {
        const mockResponses = [
            "أنا هنا للمساعدة! ما الذي يمكنني أن أفعله لك بخصوص التوظيف في ميس؟",
            `الوظائف المتاحة حاليًا هي: ${appState.jobs.map(j => j.title).join('، ')}. هل تود معرفة المزيد عن وظيفة معينة؟`,
            "ثقافة العمل في ميس ترتكز على الابتكار، التعاون، ورعاية الموظفين والمرضى.",
            "يمكنك التقديم على الوظائف من خلال قسم 'الوظائف' أو تقديم سيرتك الذاتية بشكل عام عبر الزر المخصص.",
            "عذرًا، لا أستطيع الإجابة على هذا السؤال. يمكنني المساعدة في الاستفسارات المتعلقة بالتوظيف في ميس."
        ];
        // Simple mock logic:
        let responseText = mockResponses[Math.floor(Math.random() * mockResponses.length)];
        if (userMessage.toLowerCase().includes("راتب") || userMessage.toLowerCase().includes("راتب")) {
            responseText = "لا يمكنني تقديم معلومات عن الرواتب في الوقت الحالي. يتم تحديدها بناءً على الخبرة والمقابلة.";
        } else if (userMessage.toLowerCase().includes("تقديم")) {
             responseText = "يمكنك التقديم على وظيفة معينة من خلال صفحة الوظائف، أو تقديم سيرتك الذاتية بشكل عام بالضغط على زر 'قدم سيرتك الذاتية' في قسم الوظائف.";
        }

        setTimeout(() => {
            appendChatMessage(responseText, 'bot');
            appState.chat.messages.push({ sender: 'bot', text: responseText, timestamp: new Date() });
        }, 800);
        return;
    }

    appState.chat.aiIsTyping = true;
    const loadingElement = appendChatMessage('', 'bot', true);

    try {
        const jobTitles = appState.jobs.map(j => j.title).join('؛ ') || "لا توجد وظائف معلنة حاليًا";
        const companyCultureKeywords = "الرعاية، الابتكار المستدام، التعاون المثمر، السعي للتميز، النمو المهني، النزاهة والشفافية";
        
        // Refined prompt for Gemini
        const prompt = `أنت "مساعد ميس الذكي"، وكيل محادثة ودود ومحترف تابع لقسم الموارد البشرية في شركة "ميس للمنتجات الطبية".
مهمتك الأساسية هي مساعدة المستخدمين في استفساراتهم المتعلقة بالتوظيف، فرص العمل، ثقافة الشركة، وعملية التقديم في ميس.
يجب أن تكون ردودك دائماً باللغة العربية الفصحى، مهذبة، وموجزة قدر الإمكان.
معلومات أساسية عن الشركة: "ميس للمنتجات الطبية" هي شركة رائدة في مجال المنتجات الطبية وتسعى لتوظيف أفضل الكفاءات.
الوظائف المتاحة حاليًا هي: ${jobTitles}.
إذا سئلت عن ثقافة الشركة، يمكنك ذكر بعض من هذه الكلمات المفتاحية: ${companyCultureKeywords}.
إذا سئلت عن كيفية التقديم، وجه المستخدم إلى استكشاف قسم "الوظائف" في الصفحة، أو استخدام زر "قدم سيرتك الذاتية" لتقديم عام.
لا تقدم معلومات عن الرواتب أو تفاصيل تعاقدية محددة، بل اذكر أن هذه الأمور تناقش خلال مراحل متقدمة من عملية التوظيف.
إذا كان السؤال خارج نطاق الموارد البشرية والتوظيف (مثل أسعار المنتجات، الدعم الفني للمنتجات، إلخ)، اعتذر بلطف واقترح على المستخدم التواصل مع القسم المختص عبر معلومات الاتصال الموجودة في صفحة "تواصل معنا" أو زيارة الموقع الرسمي للشركة لمزيد من المعلومات العامة.
تجنب إعطاء نصائح طبية أو معلومات عن المنتجات نفسها. ركز على التوظيف.
تاريخ المحادثة حتى الآن (آخر رسالة هي الأحدث):
${appState.chat.messages.slice(-5).map(m => `${m.sender === 'user' ? 'المستخدم' : 'المساعد'}: ${m.text}`).join('\n')}

رسالة المستخدم الجديدة: "${userMessage}"
ردك كمساعد ميس الذكي:`;

        const requestBody = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { 
                temperature: 0.7, // Slightly more creative but still factual
                topP: 0.95, 
                topK: 40, 
                maxOutputTokens: 350 // Allow for slightly longer, more detailed responses if needed
            },
            // Safety settings (optional, adjust as needed)
            // safetySettings: [
            //     { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            //     { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            //     // etc.
            // ]
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY_FOR_CHATBOT}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });
        
        loadingElement?.remove(); // Remove loading indicator

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({})); // Try to parse error
            console.error("Gemini API Error:", response.status, response.statusText, errorData);
            appendChatMessage('عذرًا، أواجه بعض الصعوبات التقنية في الوقت الحالي. يرجى المحاولة لاحقًا أو التواصل معنا مباشرة.', 'bot');
            appState.chat.messages.push({ sender: 'bot', text: 'API Error', timestamp: new Date() });
            appState.chat.aiIsTyping = false;
            return;
        }

        const data = await response.json();
        let botResponseText = 'عذرًا، لم أتمكن من فهم طلبك. هل يمكنك إعادة صياغته؟'; // Default fallback

        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
            botResponseText = data.candidates[0].content.parts[0].text.trim();
        } else if (data.promptFeedback?.blockReason) {
            console.warn("Gemini content blocked:", data.promptFeedback.blockReason, data.promptFeedback.safetyRatings);
            botResponseText = 'عذرًا، لا يمكنني معالجة هذا الطلب حاليًا بسبب سياسات المحتوى.';
        }
        
        appendChatMessage(botResponseText, 'bot');
        appState.chat.messages.push({ sender: 'bot', text: botResponseText, timestamp: new Date() });

    } catch (error) {
        console.error("Chat AI Processing Error:", error);
        loadingElement?.remove();
        appendChatMessage('حدث خطأ غير متوقع أثناء محاولة الرد. يرجى المحاولة مرة أخرى.', 'bot');
        appState.chat.messages.push({ sender: 'bot', text: 'Client-side Error', timestamp: new Date() });
    } finally {
        appState.chat.aiIsTyping = false;
    }
}


function initializeSpeechRecognitionAPI() {
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognitionAPI && DOMElements.chatModeVoiceBtn && DOMElements.voiceRecognitionBtn) {
        speechRecognitionInstance = new SpeechRecognitionAPI();
        speechRecognitionInstance.lang = 'ar-SA'; // Arabic - Saudi Arabia
        speechRecognitionInstance.continuous = false; // Stop after first recognition
        speechRecognitionInstance.interimResults = false; // We only want final results

        speechRecognitionInstance.onresult = function(event) {
            const transcript = event.results[0][0].transcript.trim();
            if (transcript) {
                appendChatMessage(transcript, 'user');
                appState.chat.messages.push({ sender: 'user', text: transcript, timestamp: new Date() });
                processUserMessageWithAI(transcript);
            }
        };
        speechRecognitionInstance.onerror = function(event) {
            console.error("Speech Recognition Error:", event.error, event.message);
            let errorMsg = 'حدث خطأ أثناء محاولة التعرف على الصوت.';
            if (event.error === 'no-speech') errorMsg = 'لم يتم اكتشاف أي كلام. يرجى المحاولة مرة أخرى.';
            else if (event.error === 'audio-capture') errorMsg = 'حدثت مشكلة في التقاط الصوت من الميكروفون.';
            else if (event.error === 'not-allowed') errorMsg = 'تم رفض الإذن باستخدام الميكروفون. يرجى التحقق من إعدادات المتصفح.';
            appendChatMessage(errorMsg, 'bot');
            appState.chat.messages.push({ sender: 'bot', text: errorMsg, timestamp: new Date() });
        };
        speechRecognitionInstance.onstart = function() { 
            appState.chat.isVoiceListening = true; 
            updateVoiceRecognitionButtonUI(); 
        };
        speechRecognitionInstance.onend = function() { 
            appState.chat.isVoiceListening = false; 
            updateVoiceRecognitionButtonUI(); 
        };
    } else {
        console.warn("Speech Recognition API not supported or required DOM elements missing.");
        if (DOMElements.chatModeVoiceBtn) {
            DOMElements.chatModeVoiceBtn.disabled = true;
            DOMElements.chatModeVoiceBtn.title = "خاصية التعرف على الصوت غير مدعومة في هذا المتصفح.";
        }
        if (DOMElements.voiceRecognitionBtn) DOMElements.voiceRecognitionBtn.style.display = 'none';
    }
}

function toggleVoiceRecognition() {
    if (!speechRecognitionInstance) { 
        appendChatMessage('عذرًا، خاصية التعرف على الصوت غير مدعومة حاليًا.', 'bot'); 
        return; 
    }
    if (appState.chat.isVoiceListening) {
        speechRecognitionInstance.stop();
    } else {
        try { 
            speechRecognitionInstance.start(); 
        } catch (e) { 
            console.error("Error starting speech recognition:", e);
            appendChatMessage('لم أتمكن من بدء التعرف على الصوت. يرجى التأكد من أن الميكروفون متاح ويعمل.', 'bot');
            appState.chat.isVoiceListening = false; 
            updateVoiceRecognitionButtonUI();
        }
    }
}

function updateVoiceRecognitionButtonUI() {
    const voiceBtn = DOMElements.voiceRecognitionBtn;
    if (!voiceBtn) return;

    if (appState.chat.isVoiceListening) {
        voiceBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';
        voiceBtn.classList.add('listening');
        voiceBtn.setAttribute('aria-label', 'إيقاف التسجيل الصوتي');
        voiceBtn.setAttribute('aria-pressed', 'true');
    } else {
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceBtn.classList.remove('listening');
        voiceBtn.setAttribute('aria-label', 'بدء التسجيل الصوتي');
        voiceBtn.setAttribute('aria-pressed', 'false');
    }
}

// --- Utility Functions ---
function displayAlert(message, type = 'success', duration = 4600) {
    if (!DOMElements.globalAlertContainer) {
        console.error("Global alert container not found.");
        return;
    }
    // Clear any existing timeout for alerts to prevent premature removal if multiple alerts are shown quickly
    if (appState.ui.alertTimeoutId) {
        clearTimeout(appState.ui.alertTimeoutId);
    }

    const alertElement = document.createElement('div');
    alertElement.className = `message-alert ${type}`; // Base classes
    alertElement.setAttribute('role', type === 'error' ? 'alert' : 'status'); // Appropriate ARIA role

    const icon = document.createElement('i');
    const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');
    icon.className = `fas ${iconClass}`;
    icon.setAttribute('aria-hidden', 'true'); // Icon is decorative

    alertElement.appendChild(icon);
    alertElement.appendChild(document.createTextNode(" " + message)); // Add message text

    DOMElements.globalAlertContainer.prepend(alertElement); // Add new alert at the top

    // Trigger animation
    requestAnimationFrame(() => { // Ensures class is added after element is in DOM for animation
        alertElement.classList.add('slide-in');
    });

    // Set timeout to remove the alert
    appState.ui.alertTimeoutId = setTimeout(() => {
        alertElement.classList.remove('slide-in'); // Prepare for fade out
        alertElement.classList.add('fade-out');
        // Wait for fade-out animation to complete before removing from DOM
        alertElement.addEventListener('animationend', () => {
            if (alertElement.parentElement) { // Check if still part of DOM
                alertElement.remove();
            }
        }, { once: true }); // Listener executes only once
    }, duration - 400); // Start fade-out slightly before full duration
}

function escapeHTML(str) {
    if (typeof str !== 'string') return str; // Return non-strings as is
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

function clearFormErrors(formElement) {
    if (!formElement) return;
    const errorMessages = formElement.querySelectorAll('.form-error-message');
    errorMessages.forEach(msg => msg.textContent = '');
    const invalidInputs = formElement.querySelectorAll('[aria-invalid="true"]');
    invalidInputs.forEach(input => input.setAttribute('aria-invalid', 'false'));
}

// Debounce function (example, not used in current setup but good utility)
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}


 </script> 
</body>
</html>
