<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠØ© - Ù…Ù†ØµØ© Ù†Ù…Ùˆ</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- General Variables & Base Styles --- */
        :root {
            --primary: #2E8B57;
            --primary-dark: #20603c;
            --accent: #ff6347;
            --dark: #1a202c;
            --white: #ffffff;
            --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-3: 0.75rem; --spacing-4: 1rem;
            --spacing-6: 1.5rem; --spacing-8: 2rem; --spacing-16: 4rem;
            --font-size-xs: 0.75rem; --font-size-sm: 0.875rem; --font-size-base: 1rem;
            --font-size-lg: 1.125rem; --font-size-xl: 1.25rem; --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem; --font-size-4xl: 2.25rem; --font-size-5xl: 3rem;
            --border-radius: 0.5rem; --border-radius-lg: 1rem;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease-in-out;
            --font-main: 'Cairo', sans-serif;
            --font-code: 'IBM Plex Sans Arabic', monospace;
            --font-creative: 'Changa', sans-serif;
        }

        [data-theme="light"] {
            --bg-main: #f7fafc;
            --bg-content: var(--white);
            --bg-alt: #edf2f7;
            --text-primary: var(--dark);
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #3cb371 100%);
        }

        [data-theme="dark"] {
            --primary: #38a169;
            --primary-dark: #2f855a;
            --bg-main: #1a202c;
            --bg-content: #2d3748;
            --bg-alt: #171923;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #2f855a 100%);
        }

        [data-theme="high-contrast"] {
            --primary: #ffff00; /* Yellow */
            --primary-dark: #e6e600;
            --accent: #00ffff; /* Cyan */
            --bg-main: #000000;
            --bg-content: #000000;
            --bg-alt: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #ffffff;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #e6e600 100%);
        }
        
        /* Persona-based UI adaptations */
        [data-persona="developer"] { --font-main: var(--font-code); --primary: #3b82f6; --accent: #16a34a; }
        [data-persona="designer"] { --font-main: var(--font-creative); --primary: #8b5cf6; --accent: #ec4899; --border-radius: 1rem; --border-radius-lg: 2rem; }
        [data-persona="marketer"] { --primary: #f97316; --accent: #22c55e; }


        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--spacing-4); }
        h1, h2, h3, h4 { font-weight: 700; color: var(--text-primary); transition: color 0.3s ease; }
        p { color: var(--text-secondary); }
        button, input, select, textarea { font-family: inherit; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: var(--spacing-2); padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--border-radius); font-weight: 600;
            cursor: pointer; transition: var(--transition); border: none;
            box-shadow: var(--shadow);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-alt); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background: var(--border-color); }

        /* --- Page Header --- */
        .page-header {
            background: var(--gradient-primary); color: var(--white);
            padding: var(--spacing-8) 0; margin-bottom: var(--spacing-8);
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
            transition: var(--transition);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-info h1 { font-size: var(--font-size-3xl); margin-bottom: var(--spacing-2); display: flex; align-items: center; gap: var(--spacing-3); color: var(--white); }
        .header-info p { opacity: 0.9; font-size: var(--font-size-lg); color: var(--white); }
        .header-actions { display: flex; align-items: center; gap: var(--spacing-4); }
        .theme-toggle { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: var(--white); width: 44px; height: 44px; border-radius: 50%; font-size: var(--font-size-lg); }

        /* --- Progress Bar --- */
        .progress-container { background: var(--bg-content); border-radius: var(--border-radius-lg); padding: var(--spacing-8); margin-bottom: var(--spacing-8); box-shadow: var(--shadow-md); }
        .progress-bar { display: flex; justify-content: space-between; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 30px; left: 0; right: 0; height: 2px; background: var(--border-color); transform: translateY(-50%); z-index: 1; }
        .progress-step { display: flex; flex-direction: column; align-items: center; gap: var(--spacing-3); position: relative; z-index: 2; flex: 1; text-align: center; }
        .step-circle { width: 60px; height: 60px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xl); color: var(--text-secondary); transition: var(--transition); border: 3px solid var(--bg-content); box-shadow: var(--shadow); }
        .step-title { font-size: var(--font-size-sm); color: var(--text-secondary); font-weight: 600; max-width: 100px; }
        .progress-step.active .step-circle { background: var(--gradient-primary); color: var(--white); transform: scale(1.1); }
        .progress-step.active .step-title { color: var(--primary); }
        .progress-step.completed .step-circle { background: var(--primary); color: var(--white); animation: pop 0.5s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.25); box-shadow: 0 0 15px var(--primary); } 100% { transform: scale(1); } }


        /* --- Step Content --- */
        .content-container { background: var(--bg-content); border-radius: var(--border-radius-lg); padding: var(--spacing-8); box-shadow: var(--shadow-md); min-height: 600px; }
        .step-content { display: none; animation: fadeInUp 0.5s ease; }
        .step-content.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-header { text-align: center; margin-bottom: var(--spacing-8); }
        .step-header h2 { font-size: var(--font-size-2xl); color: var(--text-primary); margin-bottom: var(--spacing-3); display: flex; align-items: center; justify-content: center; gap: var(--spacing-3); }
        .step-header p { color: var(--text-secondary); font-size: var(--font-size-lg); }

        /* --- Forms & Inputs --- */
        .form { max-width: 800px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-8); }
        .form-group { display: flex; flex-direction: column; gap: var(--spacing-2); }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; color: var(--text-primary); }
        .form-group input, .form-group select, .form-group textarea {
            padding: var(--spacing-3) var(--spacing-4); border: 2px solid var(--border-color);
            border-radius: var(--border-radius); font-size: var(--font-size-base);
            transition: var(--transition); background: var(--bg-alt); color: var(--text-primary);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
        .form-actions { display: flex; gap: var(--spacing-4); justify-content: center; margin-top: var(--spacing-8); }

        /* --- File Upload --- */
        .upload-area { border: 3px dashed var(--border-color); border-radius: var(--border-radius-lg); padding: var(--spacing-16); text-align: center; transition: var(--transition); cursor: pointer; background: var(--bg-alt); }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 5%, transparent); }
        .upload-icon { font-size: var(--font-size-5xl); color: var(--text-secondary); margin-bottom: var(--spacing-6); }
        .file-info { background: var(--bg-alt); border-radius: var(--border-radius); padding: var(--spacing-6); margin-top: var(--spacing-6); display: flex; justify-content: space-between; align-items: center; }
        .file-details { display: flex; align-items: center; gap: var(--spacing-4); }
        .file-details i { font-size: var(--font-size-2xl); color: var(--primary); }

        /* --- Loading & Cards --- */
        .loading-state { text-align: center; padding: var(--spacing-16); }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto var(--spacing-6); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state h3 { font-size: var(--font-size-xl); margin-bottom: var(--spacing-3); }
        .loading-state #dynamicLoadingMessage { color: var(--text-secondary); font-size: var(--font-size-base); min-height: 24px; }
        .analysis-details, .evaluation-details { display: grid; grid-template-columns: 1fr; gap: var(--spacing-6); }
        .detail-card { background: var(--bg-alt); border-radius: var(--border-radius); padding: var(--spacing-6); border-right: 4px solid var(--primary); }
        .detail-card h3 { font-size: var(--font-size-lg); color: var(--text-primary); margin-bottom: var(--spacing-4); display: flex; align-items: center; gap: var(--spacing-2); }
        .detail-card ul { list-style: none; padding-right: var(--spacing-4); }
        .detail-card li { padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); }
        .detail-card li:last-child { border-bottom: none; }


        /* --- Challenge Step --- */
        .challenge-container { max-width: 800px; margin: 0 auto; }
        .challenge-box { background: var(--bg-alt); border-radius: var(--border-radius-lg); padding: var(--spacing-8); border-left: 4px solid var(--accent); }
        .challenge-box h3 { color: var(--accent); margin-bottom: var(--spacing-4); }
        .challenge-box p { font-size: var(--font-size-lg); margin-bottom: var(--spacing-6); }

        /* --- Interview --- */
        .interview-container { max-width: 800px; margin: 0 auto; }
        .question-card { background: var(--bg-alt); border-radius: var(--border-radius-lg); padding: var(--spacing-8); border-right: 4px solid var(--primary); }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-6); padding-bottom: var(--spacing-4); border-bottom: 2px solid var(--border-color); }
        .question-timer { display: flex; align-items: center; gap: var(--spacing-2); color: var(--accent); font-weight: 600; }
        .voice-btn { background: var(--accent); color: var(--white); }
        .voice-btn.recording { background: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, #ef4444 70%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, #ef4444 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, #ef4444 0%, transparent); } }
        .real-time-coaching {
            display: flex; gap: var(--spacing-4); margin-top: var(--spacing-2); padding: var(--spacing-2);
            background: color-mix(in srgb, var(--primary) 5%, transparent); border-radius: var(--border-radius);
            font-size: var(--font-size-sm); color: var(--text-secondary);
        }

        /* --- Final Report & Charts --- */
        .report-container { background: var(--bg-alt); border-radius: var(--border-radius-lg); padding: var(--spacing-8); border: 2px solid var(--border-color); }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-4); margin-top: var(--spacing-4); }
        .report-item { background: var(--bg-content); border-radius: var(--border-radius); padding: var(--spacing-4); border-right: 3px solid var(--primary); }
        #finalScoreChartContainer { max-width: 500px; margin: var(--spacing-8) auto; }
        .career-path-explorer { display: flex; flex-direction: column; gap: var(--spacing-4); }
        .career-path-node { background: var(--bg-content); border-radius: var(--border-radius); padding: var(--spacing-4); border-left: 4px solid var(--accent); position: relative; }
        .career-path-node h4 { color: var(--accent); }
        .career-path-node p { font-size: var(--font-size-sm); }
        .disclaimer { font-size: var(--font-size-xs); color: var(--text-secondary); text-align: center; margin-top: var(--spacing-4); padding: var(--spacing-2); background-color: color-mix(in srgb, var(--accent) 10%, transparent); border-radius: var(--border-radius); }
        
        /* --- AI Assistant --- */
        .ai-assistant {
            position: fixed;
            bottom: var(--spacing-6);
            left: var(--spacing-6);
            background: var(--bg-content);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-4);
            box-shadow: var(--shadow-lg);
            max-width: 320px;
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-3);
            transform: translateX(-150%);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        .ai-assistant.show {
            transform: translateX(0);
            opacity: 1;
        }
        .ai-avatar {
            background: var(--gradient-primary);
            color: var(--white);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            flex-shrink: 0;
            transition: background 0.5s ease;
        }
        .ai-message p { margin: 0; font-size: var(--font-size-sm); color: var(--text-secondary); }
        .ai-message strong { color: var(--text-primary); }

        /* --- Notification/Toast & Achievements --- */
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 16px 20px; border-radius: var(--border-radius); color: white;
            font-weight: 600; z-index: 10000; opacity: 0;
            transform: translate(-50%, -100px); transition: all 0.5s ease;
            display: flex; align-items: center; gap: 8px;
            min-width: 300px; box-shadow: var(--shadow-lg);
        }
        .notification.show { opacity: 1; transform: translate(-50%, 0); }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.achievement {
            background: linear-gradient(135deg, #6d28d9, #be185d);
            border-left: 5px solid #fbbf24;
        }
        .achievement-title { font-weight: 800; display: block; font-size: var(--font-size-base); }


        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            opacity: 0; visibility: hidden; transition: var(--transition);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-content);
            padding: var(--spacing-8);
            border-radius: var(--border-radius-lg);
            max-width: 600px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: var(--transition);
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h2 { color: var(--primary); }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; text-align: center; gap: var(--spacing-4); }
            .form-grid { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column; }
            .ai-assistant { left: 50%; transform: translateX(-50%); width: 90%; bottom: var(--spacing-4); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="header-content">
                <div class="header-info">
                    <h1><i class="fas fa-briefcase"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠØ©</h1>
                    <p>ØªØ¬Ø±Ø¨Ø© ØªÙˆØ¸ÙŠÙ Ù…Ø®ØµØµØ© Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ</p>
                </div>
                <div class="header-actions">
                     <button class="theme-toggle btn" id="themeToggleBtn" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <!-- Steps will be generated by JS -->
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-container">
                <!-- Step 1: Basic Info -->
                <div class="step-content" id="step1">
                    <div class="step-header">
                        <h2><i class="fas fa-user-plus"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
                        <p>Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© Ù…Ø¹Ù†Ø§ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
                    </div>
                    <form id="basicInfoForm" class="form">
                        <div class="form-grid">
                            <div class="form-group"><label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label><input type="text" id="fullName" name="fullName" required></div>
                            <div class="form-group"><label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label><input type="email" id="email" name="email" required></div>
                            <div class="form-group"><label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label><input type="tel" id="phone" name="phone" required></div>
                            <div class="form-group"><label for="experience">Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø© *</label><select id="experience" name="experience" required><option value="">Ø§Ø®ØªØ±</option><option value="0-1">Ø£Ù‚Ù„ Ù…Ù† Ø³Ù†Ø©</option><option value="1-3">1-3</option><option value="3-5">3-5</option><option value="5-10">5-10</option><option value="10+">10+</option></select></div>
                            <div class="form-group"><label for="education">Ø§Ù„Ù…Ø¤Ù‡Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ *</label><select id="education" name="education" required><option value="">Ø§Ø®ØªØ±</option><option value="high-school">Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø§Ù…Ø©</option><option value="diploma">Ø¯Ø¨Ù„ÙˆÙ…</option><option value="bachelor">Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³</option><option value="master">Ù…Ø§Ø¬Ø³ØªÙŠØ±</option><option value="phd">Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option></select></div>
                            <div class="form-group"><label for="specialization">Ø§Ù„ØªØ®ØµØµ *</label><input type="text" id="specialization" name="specialization" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·ÙˆØ± Ø¨Ø±Ù…Ø¬ÙŠØ§ØªØŒ Ù…ØµÙ…Ù…ØŒ Ù…Ø³ÙˆÙ‚"></div>
                            <div class="form-group"><label for="expectedSalary">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="number" id="expectedSalary" name="expectedSalary" placeholder="Ù…Ø«Ø§Ù„: 12000"></div>
                            <div class="form-group full-width"><label for="jobDescription">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><textarea id="jobDescription" name="jobDescription" rows="4" placeholder="Ø§Ù„ØµÙ‚ ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙŠ ØªÙ‡Ù…Ùƒ Ù‡Ù†Ø§ Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø®ØµØµ..."></textarea></div>
                        </div>
                        <div class="form-actions"><button type="submit" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ</button></div>
                    </form>
                </div>

                <!-- Step 2: CV Upload -->
                <div class="step-content" id="step2">
                    <div class="step-header"><h2><i class="fas fa-file-upload"></i> Ø±ÙØ¹ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h2><p>Ø§Ø±ÙØ¹ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ù„ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p></div>
                    <div class="upload-container"><div class="upload-area" id="uploadArea"><div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><h3>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</h3><p>ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù„ÙØ§Øª PDF, DOC, DOCX (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)</p><input type="file" id="cvFile" accept=".pdf,.doc,.docx" hidden></div><div class="file-info" id="fileInfo" style="display: none;"><div class="file-details"><i class="fas fa-file-alt"></i><div><div class="file-name" id="fileName"></div><div class="file-size" id="fileSize"></div></div></div><button class="btn btn-secondary" onclick="app.removeFile()"><i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©</button></div></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button><button type="button" class="btn btn-primary" id="analyzeBtn" onclick="app.nextStep()" disabled><i class="fas fa-brain"></i> Ø§Ù„ØªØ§Ù„ÙŠ: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±Ø©</button></div>
                </div>

                <!-- Step 3: AI Analysis -->
                <div class="step-content" id="step3">
                    <div class="step-header"><h2><i class="fas fa-brain"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h2></div>
                    <div class="analysis-container">
                        <div class="loading-state" id="loadingState">
                            <div class="loading-spinner"></div><h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</h3><p id="dynamicLoadingMessage"></p>
                        </div>
                        <div id="analysisResults" style="display: none;">
                            <div id="finalScoreChartContainer"><canvas id="skillsChart"></canvas></div>
                            <div class="analysis-details">
                                <div class="detail-card"><h3><i class="fas fa-user-graduate"></i> Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3><div id="analysisSummary"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-lightbulb"></i> Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h3><div id="cvImprovements"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-id-card"></i> Ù…Ù„Ø®ØµÙƒ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­</h3><div id="professionalSummary"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-briefcase"></i> Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h3><div id="suggestedJobs"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button><button type="button" class="btn btn-primary" id="challengeBtn" onclick="app.nextStep()" disabled><i class="fas fa-puzzle-piece"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„ØªØ­Ø¯ÙŠ</button></div>
                </div>
                
                <!-- Step 4: Interactive Challenge -->
                <div class="step-content" id="step4">
                    <div class="step-header">
                        <h2><i class="fas fa-puzzle-piece"></i> Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</h2>
                        <p>Ù†ÙˆØ¯ Ø£Ù† Ù†Ø±Ù‰ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø£Ø±Ø¶ Ø§Ù„ÙˆØ§Ù‚Ø¹. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ.</p>
                    </div>
                    <div class="challenge-container">
                        <div class="loading-state" id="challengeLoadingState">
                            <div class="loading-spinner"></div><h3>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ­Ø¯ÙŠ Ù…Ø®ØµØµ Ù„Ùƒ...</h3>
                        </div>
                        <div id="challengeContent" style="display:none;">
                             <div class="challenge-box">
                                <h3 id="challengeTitle"></h3>
                                <p id="challengeScenario"></p>
                            </div>
                            <div class="form-group full-width" style="margin-top: 2rem;">
                                <label for="challengeAnswer">Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ:</label>
                                <textarea id="challengeAnswer" name="challengeAnswer" rows="8" placeholder="Ø§ÙƒØªØ¨ Ø­Ù„Ùƒ Ø£Ùˆ Ø®Ø·Ø© Ø¹Ù…Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <button type="button" class="btn btn-primary" id="interviewBtn" onclick="app.nextStep()"><i class="fas fa-comments"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©</button>
                    </div>
                </div>

                <!-- Step 5: Interactive Interview -->
                <div class="step-content" id="step5">
                    <div class="step-header"><h2><i class="fas fa-comments"></i> Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h2><p>Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p></div>
                    <div class="interview-container">
                        <div class="loading-state" id="interviewLoadingState">
                             <div class="loading-spinner"></div><h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©...</h3>
                        </div>
                        <div class="question-card" id="questionCard" style="display:none;">
                            <div class="question-header"><div class="question-number">Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="currentQuestion">1</span> Ù…Ù† <span id="totalQuestions">5</span></div><div class="question-timer"><i class="fas fa-clock"></i><span id="timer">05:00</span></div></div>
                            <div class="question-content"><h3 id="questionText"></h3>
                                <div class="answer-section">
                                    <label for="textAnswer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØªØ§Ø¨ÙŠØ©:</label>
                                    <textarea id="textAnswer" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                                    <div class="real-time-coaching" id="realTimeCoaching" style="display: none;">
                                        <span><i class="fas fa-text-width"></i> Ø§Ù„Ø¥ÙŠØ¬Ø§Ø²: <span id="brevityMeter">--</span></span>
                                        <span><i class="fas fa-brain"></i> ÙƒÙ„Ù…Ø§Øª Ù‚ÙˆÙŠØ©: <span id="powerWordsMeter">0</span></span>
                                    </div>
                                </div>
                                <div class="voice-section"><label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµÙˆØªÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><div class="voice-controls"><button class="voice-btn btn" id="recordBtn" onclick="app.interview.toggleRecording()"><i class="fas fa-microphone"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button><div class="recording-status" id="recordingStatus"></div></div><audio id="audioPlayback" controls style="display: none;"></audio></div></div>
                            <div class="question-actions"><button type="button" class="btn btn-secondary" id="prevQuestionBtn" onclick="app.interview.previousQuestion()" disabled><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button><button type="button" class="btn btn-primary" id="nextQuestionBtn" onclick="app.interview.nextQuestion()"><i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ</button><button type="button" class="btn btn-primary" id="finishInterviewBtn" onclick="app.interview.finishInterview()" style="display: none;"><i class="fas fa-check"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©</button></div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 6: Final Report -->
                <div class="step-content" id="step6">
                    <div class="step-header"><h2><i class="fas fa-chart-line"></i> Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2><p>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ø¹Ù† ØªÙ‚ÙŠÙŠÙ…Ùƒ ÙˆØªÙˆØµÙŠØ§ØªÙ†Ø§ Ù„Ù…Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</p></div>
                    <div class="loading-state" id="reportLoadingState">
                        <div class="loading-spinner"></div><h3>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...</h3>
                    </div>
                    <div class="report-container" id="reportContainer" style="display:none;">
                        <!-- Report content will be injected here -->
                    </div>
                    <div class="form-actions" id="reportActions" style="display:none;">
                        <button type="button" class="btn btn-secondary" onclick="app.downloadReport()"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF)</button>
                        <button type="button" class="btn btn-primary" onclick="app.submitApplication()"><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                        <button type="button" class="btn" style="background-color: var(--accent); color: white;" onclick="app.startNew()"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙŠ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="aiAssistant">
        <div class="ai-avatar" id="aiAvatar"><i class="fas fa-robot"></i></div>
        <div class="ai-message">
            <strong id="aiAssistantName">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ù†Ù…Ùˆ</strong>
            <p id="aiAssistantMessage">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠØ©! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ.</p>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="resumeModal">
        <div class="modal-content">
            <h2><i class="fas fa-history"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚ØŸ</h2>
            <p>Ù„Ù‚Ø¯ ÙˆØ¬Ø¯Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„. Ù‡Ù„ ØªÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØªØŸ</p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="startNewBtn">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn btn-primary" id="resumeBtn">Ù†Ø¹Ù…, Ù…ØªØ§Ø¨Ø¹Ø©</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="interviewModal">
        <div class="modal-content" id="interviewModalContent">
           <!-- Content will be injected by JS -->
        </div>
    </div>


<script>
const App = function() {
    // --- STATE ---
    this.state = {
        currentStep: 1,
        totalSteps: 6,
        theme: 'light',
        themeCycle: ['light', 'dark', 'high-contrast'],
        persona: 'default',
        achievements: [],
        applicationData: {
            basicInfo: {},
            cvFile: null,
            cvContent: '',
            analysisResults: {},
            interactiveChallenge: {
                scenario: null,
                answer: ''
            },
            interview: {
                questions: [],
                currentQuestion: 0,
                answers: [],
                timer: null,
                timeLeft: 300,
            },
            finalReport: {}
        }
    };

    // --- CONFIG ---
    this.config = {
        // ğŸ”´ğŸ”´ğŸ”´ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ù‡Ø°Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø°ÙŠ ØªØ±Ø§Ù‡. 
        // ğŸ”´ğŸ”´ğŸ”´ Ø§Ø³ØªØ¨Ø¯Ù„ 'YOUR_GEMINI_API_KEY' Ø¨Ù…ÙØªØ§Ø­ API Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Google AI Studio Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.
        geminiApiKey: 'AIzaSyCV3Kb2rHMQoyAiYkrAFA82UlcGbYAAC0M', 
        geminiModel: 'gemini-1.5-flash-latest',
        steps: [
            { id: 1, title: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', icon: 'fa-user-plus' },
            { id: 2, title: 'Ø±ÙØ¹ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©', icon: 'fa-file-upload' },
            { id: 3, title: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ', icon: 'fa-brain' },
            { id: 4, title: 'Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ', icon: 'fa-puzzle-piece' },
            { id: 5, title: 'Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©', icon: 'fa-comments' },
            { id: 6, title: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', icon: 'fa-chart-line' },
        ],
        marketInsights: { // Simulated collective learning
            developer: "Ù†ØµÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: 70% Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ† ÙŠØ°ÙƒØ±ÙˆÙ† Git Ùˆ CI/CD ÙÙŠ Ø³ÙŠØ±Ù‡Ù… Ø§Ù„Ø°Ø§ØªÙŠØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¨Ø±Ø§Ø²Ù‡Ø§.",
            designer: "Ù†ØµÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: 90% Ù…Ù† Ø§Ù„Ù…ØµÙ…Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ØªÙ… ØªÙˆØ¸ÙŠÙÙ‡Ù… ÙŠØ±ÙÙ‚ÙˆÙ† Ø±Ø§Ø¨Ø·Ù‹Ø§ Ù„Ù…Ø¹Ø±Ø¶ Ø£Ø¹Ù…Ø§Ù„Ù‡Ù… (Portfolio).",
            marketer: "Ù†ØµÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ù…Ø³ÙˆÙ‚ÙˆÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØ°ÙƒØ±ÙˆÙ† Ù†ØªØ§Ø¦Ø¬ Ø±Ù‚Ù…ÙŠØ© (Ù…Ø«Ù„ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ø³Ø¨Ø© X%) ÙŠØ­ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù‡ØªÙ…Ø§Ù… Ø£ÙƒØ¨Ø±."
        },
        powerWords: ['Ù‚ÙØ¯Øª', 'Ø·ÙˆÙ‘Ø±Øª', 'Ø£Ø¯Ø±Øª', 'Ø­Ù‚Ù‚Øª', 'Ø£Ù†Ø¬Ø²Øª', 'Ø£Ø³Ø³Øª', 'Ø²Ø¯Øª', 'Ø­Ø³Ù‘Ù†Øª', 'Ø®ÙØ¶Øª', 'Ø§Ø¨ØªÙƒØ±Øª', 'led', 'managed', 'developed', 'achieved', 'increased', 'decreased', 'improved', 'founded', 'innovated']
    };
    
    // --- DOM ELEMENTS ---
    this.dom = {};

    // --- INITIALIZATION ---
    this.init = () => {
        // Caching DOM elements
        this.dom.progressBar = document.querySelector('.progress-bar');
        this.dom.themeToggleBtn = document.getElementById('themeToggleBtn');
        this.dom.basicInfoForm = document.getElementById('basicInfoForm');
        this.dom.uploadArea = document.getElementById('uploadArea');
        this.dom.cvFile = document.getElementById('cvFile');
        this.dom.aiAssistant = document.getElementById('aiAssistant');
        this.dom.aiAssistantMessage = document.getElementById('aiAssistantMessage');
        this.dom.resumeModal = document.getElementById('resumeModal');
        this.dom.resumeBtn = document.getElementById('resumeBtn');
        this.dom.startNewBtn = document.getElementById('startNewBtn');
        this.dom.fullNameInput = document.getElementById('fullName');
        this.dom.specializationInput = document.getElementById('specialization');
        this.dom.textAnswerTextarea = document.getElementById('textAnswer');
        this.dom.interviewModal = document.getElementById('interviewModal');
        this.dom.interviewModalContent = document.getElementById('interviewModalContent');
        
        if (this.config.geminiApiKey === 'YOUR_GEMINI_API_KEY') {
            this.showNotification('ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ Gemini API Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.', 'error');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        this.setupEventListeners();
        this.renderProgressBar();
        this.initTheme();
        this.checkForSavedState();
    };

    // --- EVENT LISTENERS ---
    this.setupEventListeners = () => {
        this.dom.themeToggleBtn.addEventListener('click', this.toggleTheme);
        this.dom.basicInfoForm.addEventListener('submit', this.handleBasicInfoSubmit);
        this.dom.fullNameInput.addEventListener('input', (e) => this.personalizeWelcome(e.target.value));
        this.dom.specializationInput.addEventListener('input', (e) => this.adaptiveUI.updatePersona(e.target.value));
        this.dom.textAnswerTextarea.addEventListener('input', this.interview.updateRealTimeCoaching);
        
        this.dom.uploadArea.addEventListener('click', () => this.dom.cvFile.click());
        this.dom.cvFile.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            this.dom.uploadArea.addEventListener(eventName, this.handleDragDrop, false);
        });

        this.dom.resumeBtn.addEventListener('click', this.resumeState);
        this.dom.startNewBtn.addEventListener('click', this.clearStateAndHideModal);
    };

    // --- THEME & PERSONALIZATION ---
    this.initTheme = () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        this.state.theme = savedTheme;
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon();
    };

    this.toggleTheme = () => {
        const currentThemeIndex = this.state.themeCycle.indexOf(this.state.theme);
        const nextThemeIndex = (currentThemeIndex + 1) % this.state.themeCycle.length;
        const nextTheme = this.state.themeCycle[nextThemeIndex];
        
        this.state.theme = nextTheme;
        localStorage.setItem('theme', this.state.theme);
        this.initTheme();
    };
    
    this.updateThemeIcon = () => {
        const icon = this.dom.themeToggleBtn.querySelector('i');
        const themeIcons = {
            light: 'fa-moon',
            dark: 'fa-sun',
            'high-contrast': 'fa-low-vision'
        };
        icon.className = `fas ${themeIcons[this.state.theme]}`;
    };

    this.personalizeWelcome = (name) => {
        const persona = this.state.persona;
        let message = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠØ©! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø¥Ø±Ø´Ø§Ø¯Ùƒ ÙÙŠ Ø±Ø­Ù„ØªÙƒ.";

        if(name.trim() !== '') {
            if(persona === 'developer') {
                message = `System.out.println("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}!"); Ø§Ø³ØªØ¹Ø¯ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯ Ù†Ø­Ùˆ ÙˆØ¸ÙŠÙØªÙƒ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.`;
            } else if (persona === 'designer') {
                message = `ÙŠØ§ ${name}ØŒ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù„Ù†ØµÙ…Ù… Ù…Ø¹Ù‹Ø§ Ù„ÙˆØ­Ø© Ù…Ø´Ø±Ù‚Ø© Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ.`;
            } else if (persona === 'marketer') {
                message = `Ø­Ù…Ù„Ø© ØªÙˆØ¸ÙŠÙ ${name} Ø§Ù†Ø·Ù„Ù‚Øª! Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ù„Ù†Ø­Ù‚Ù‚ Ø£ÙØ¶Ù„ Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ.`;
            } else {
                message = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}! ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ø£Ù† Ø£ÙƒÙˆÙ† Ù…Ø±Ø´Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ….`;
            }
        }
        this.assistantSpeak(message);
    };

    // --- ADAPTIVE UI ---
    this.adaptiveUI = {
        updatePersona: (specialization) => {
            let persona = 'default';
            const spec = specialization.toLowerCase();
            if (spec.includes('Ù…Ø·ÙˆØ±') || spec.includes('Ù…Ø¨Ø±Ù…Ø¬') || spec.includes('developer') || spec.includes('engineer')) {
                persona = 'developer';
            } else if (spec.includes('Ù…ØµÙ…Ù…') || spec.includes('designer') || spec.includes('creative')) {
                persona = 'designer';
            } else if (spec.includes('Ù…Ø³ÙˆÙ‚') || spec.includes('marketer') || spec.includes('ØªØ³ÙˆÙŠÙ‚')) {
                persona = 'marketer';
            }
            
            if (this.state.persona !== persona) {
                this.state.persona = persona;
                document.documentElement.setAttribute('data-persona', persona);
                this.personalizeWelcome(this.dom.fullNameInput.value); // Re-personalize with new persona
            }
        }
    };

    // --- STATE MANAGEMENT ---
    this.saveState = () => {
        try {
            const stateToSave = JSON.parse(JSON.stringify(this.state));
            if (stateToSave.applicationData.cvFile) {
                stateToSave.applicationData.cvFile = {
                    name: this.state.applicationData.cvFile.name,
                    size: this.state.applicationData.cvFile.size,
                    type: this.state.applicationData.cvFile.type,
                };
            }
            localStorage.setItem('appState', JSON.stringify(stateToSave));
        } catch (error) {
            console.error("Failed to save state:", error);
        }
    };

    this.checkForSavedState = () => {
        const savedStateJSON = localStorage.getItem('appState');
        if (savedStateJSON) {
            this.dom.resumeModal.classList.add('show');
        } else {
            this.showStep(1);
        }
    };

    this.resumeState = () => {
        const savedStateJSON = localStorage.getItem('appState');
        if (savedStateJSON) {
            const savedState = JSON.parse(savedStateJSON);
            Object.assign(this.state, savedState);
            this.state.totalSteps = 6; 
            this.initTheme(); // Re-apply theme
            this.adaptiveUI.updatePersona(this.state.applicationData.basicInfo.specialization || '');

            const basicInfo = this.state.applicationData.basicInfo;
            for (const key in basicInfo) {
                const element = document.getElementById(key);
                if (element) element.value = basicInfo[key];
            }
            if (this.state.applicationData.cvFile) {
                this.showFileInfo(this.state.applicationData.cvFile);
                document.getElementById('analyzeBtn').disabled = false;
            }
            this.showStep(this.state.currentStep);
            this.showNotification('ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!', 'success');
        }
        this.dom.resumeModal.classList.remove('show');
    };
    
    this.clearStateAndHideModal = () => {
        localStorage.removeItem('appState');
        this.dom.resumeModal.classList.remove('show');
        window.location.reload(); 
    };

    this.startNew = () => {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
            localStorage.removeItem('appState');
            localStorage.removeItem('submittedApplications');
            window.location.reload();
        }
    };

    // --- GAMIFICATION ---
    this.unlockAchievement = (title, message) => {
        if (this.state.achievements.includes(title)) return; // Don't unlock twice
        this.state.achievements.push(title);
        this.saveState();

        const achievement = document.createElement('div');
        achievement.className = 'notification achievement';
        achievement.innerHTML = `<i class="fas fa-trophy"></i> <div><span class="achievement-title">${title}</span>${message}</div>`;
        document.body.appendChild(achievement);
        setTimeout(() => achievement.classList.add('show'), 100);
        setTimeout(() => {
            achievement.classList.remove('show');
            setTimeout(() => achievement.remove(), 500);
        }, 6000);
    };

    // --- UI & NAVIGATION ---
    this.renderProgressBar = () => {
        this.dom.progressBar.innerHTML = this.config.steps.map(step => `
            <div class="progress-step" data-step="${step.id}">
                <div class="step-circle"><i class="fas ${step.icon}"></i></div>
                <div class="step-title">${step.title}</div>
            </div>
        `).join('');
    };

    this.updateProgressBar = () => {
        document.querySelectorAll('.progress-step').forEach((stepEl) => {
            const stepNumber = parseInt(stepEl.dataset.step, 10);
            stepEl.classList.remove('active', 'completed');
            if (stepNumber < this.state.currentStep) {
                stepEl.classList.add('completed');
            } else if (stepNumber === this.state.currentStep) {
                stepEl.classList.add('active');
            }
        });
    };

    this.showStep = (step) => {
        this.state.currentStep = step;
        document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
        const currentStepElement = document.getElementById(`step${step}`);
        if(currentStepElement) currentStepElement.classList.add('active');
        
        this.updateProgressBar();
        this.assistantSpeakForStep(step);
        this.saveState();

        switch(step) {
            case 3: this.startAnalysis(); break;
            case 4: this.generateChallenge(); break;
            case 5: this.interview.init(); break;
            case 6: this.generateFinalReport(); break;
        }
    };

    this.nextStep = () => {
        if (this.state.currentStep < this.state.totalSteps) {
            if(this.state.currentStep === 1) {
                this.unlockAchievement('Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø£ÙƒÙ…Ù„Øª Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
            }
            if(this.state.currentStep === 4) {
                 this.state.applicationData.interactiveChallenge.answer = document.getElementById('challengeAnswer').value;
                 this.unlockAchievement('Ø§Ù„Ù…ÙÙƒØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ', 'Ø£Ø¬Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠ Ø¨Ø¨Ø±Ø§Ø¹Ø©!');
            }
            this.showStep(this.state.currentStep + 1);
        }
    };

    this.previousStep = () => {
        if (this.state.currentStep > 1) {
            this.showStep(this.state.currentStep - 1);
        }
    };

    // --- STEP 1: BASIC INFO ---
    this.handleBasicInfoSubmit = (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        this.state.applicationData.basicInfo = Object.fromEntries(formData.entries());
        this.nextStep();
    };

    // --- STEP 2: CV UPLOAD ---
    this.handleDragDrop = (e) => { e.preventDefault(); e.stopPropagation(); this.dom.uploadArea.classList.remove('dragover'); if (e.type === 'dragover') { this.dom.uploadArea.classList.add('dragover'); } if (e.type === 'drop') { this.handleFileSelect(e.dataTransfer.files[0]); } };
    this.handleFileSelect = async (file) => { if (!file) return; const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']; if (!allowedTypes.includes(file.type)) { this.showNotification('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ PDF Ø£Ùˆ DOCX.', 'error'); return; } if (file.size > 10 * 1024 * 1024) { this.showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB)', 'error'); return; } this.state.applicationData.cvFile = file; try { this.showNotification('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...', 'success'); if (file.type === 'application/pdf') { this.state.applicationData.cvContent = await this.extractTextFromPDF(file); } else { this.state.applicationData.cvContent = await this.extractTextFromWord(file); } this.showFileInfo(file); document.getElementById('analyzeBtn').disabled = false; this.showNotification('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù„ÙŠÙ„.', 'success'); this.unlockAchievement('Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø£Ù‡Ù…', 'ØªÙ… Ø±ÙØ¹ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„!'); } catch (error) { console.error('Error processing file:', error); this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù.', 'error'); } };
    this.extractTextFromPDF = async (file) => { const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(arrayBuffer).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); text += textContent.items.map(item => item.str).join(' '); } return text; };
    this.extractTextFromWord = async (file) => { const arrayBuffer = await file.arrayBuffer(); const result = await mammoth.extractRawText({ arrayBuffer }); return result.value; };
    this.showFileInfo = (file) => { document.getElementById('fileName').textContent = file.name; document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`; document.getElementById('fileInfo').style.display = 'flex'; document.getElementById('uploadArea').style.display = 'none'; };
    this.removeFile = () => { this.state.applicationData.cvFile = null; this.state.applicationData.cvContent = ''; document.getElementById('fileInfo').style.display = 'none'; document.getElementById('uploadArea').style.display = 'block'; document.getElementById('analyzeBtn').disabled = true; this.dom.cvFile.value = ''; };

    // --- STEP 3: AI ANALYSIS ---
    this.startAnalysis = async () => {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('analysisResults').style.display = 'none';
        
        try {
            const prompt = `
            TASK: Analyze the provided CV text for a candidate with the specialization of "${this.state.applicationData.basicInfo.specialization}".
            IMPORTANT: Your entire response and all its contents MUST be in the Arabic language. Be insightful and encouraging.

            CONTEXT:
            - Candidate's Specialization: ${this.state.applicationData.basicInfo.specialization}
            - Candidate's Years of Experience: ${this.state.applicationData.basicInfo.experience}
            - Target Job Description (if any): """${this.state.applicationData.basicInfo.jobDescription || 'General analysis for their specialization'}"""
            - CV_TEXT (may be in English or Arabic): """${this.state.applicationData.cvContent}"""

            INSTRUCTIONS:
            1. Analyze the CV_TEXT thoroughly. Your output must be ONLY a valid JSON object.
            2. The JSON object MUST have the following structure:
                {
                  "matchScore": <number from 0-100, representing match to job description or general role>,
                  "skillsAnalysis": { "<Top skill 1 in Arabic>": <score1>, "<Top skill 2>": <score2>, ... },
                  "summary": "<A 2-3 sentence encouraging and insightful summary in Arabic>",
                  "improvements": [
                      { "original": "<A specific weak sentence/area from the CV>", "suggestion": "<A specific, rephrased version using action verbs and quantifiable results, in Arabic>" },
                      { "original": "Ù†ØµÙŠØ­Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©", "suggestion": "<A high-level strategic improvement tip in Arabic, like 'Consider adding a project section with links to demonstrate your work visually.'>" }
                  ],
                  "professionalSummary": "<A compelling 3-4 line professional summary tailored to the candidate's profile, written in the first person ('Ø£Ù†Ø§ Ù…ØªØ®ØµØµ...') for them to use, in Arabic>",
                  "suggestedJobs": ["<job_title_1 in Arabic>", "<job_title_2 in Arabic>", "<job_title_3 in Arabic>"]
                }
            3. For "skillsAnalysis", identify the top 5-6 most relevant skills and score them from 0-100.
            4. For "improvements", provide specific, actionable feedback. Instead of 'use numbers', show them how: change 'Managed a team' to 'Led a team of 5 to increase productivity by 15%'.
            5. The tone should be that of a helpful career coach, not a harsh critic.
            `;
            
            const responseText = await this.callGeminiAPI(prompt);
            const analysisData = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, '').trim());
            this.state.applicationData.analysisResults = analysisData;
            this.displayAnalysisResults(analysisData);
            this.unlockAchievement('Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±', 'ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!');

        } catch (error) {
            console.error("AI Analysis Error:", error);
            this.showNotification('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ AI. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©.', 'error');
            this.displayAnalysisResults({
                matchScore: 78,
                skillsAnalysis: { "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª": 85, "Ø§Ù„ØªÙˆØ§ØµÙ„": 90, "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹": 75, "Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª": 88, "Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©": 70 },
                summary: "Ù…Ø±Ø´Ø­ Ù‚ÙˆÙŠ ÙŠØªÙ…ØªØ¹ Ø¨Ø®Ø¨Ø±Ø© Ø¬ÙŠØ¯Ø© ÙˆÙ…Ù‡Ø§Ø±Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ù…ØªØ§Ø²Ø©. Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© ØªØ¸Ù‡Ø± Ø£Ø³Ø§Ø³Ø§Ù‹ Ù‚ÙˆÙŠØ§Ù‹ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¹Ù„ÙŠÙ‡.",
                improvements: [{original: "ÙƒÙ†Øª Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„ÙØ±ÙŠÙ‚.", suggestion: "Ù‚Ù…Øª Ø¨Ù‚ÙŠØ§Ø¯Ø© ÙØ±ÙŠÙ‚ Ù…Ù† 5 Ø£Ø¹Ø¶Ø§Ø¡ØŒ Ù…Ù…Ø§ Ø£Ø¯Ù‰ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 20%."}, {original: "Ù†ØµÙŠØ­Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©", suggestion:"ÙÙƒØ± ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… 'Ù…Ø´Ø§Ø±ÙŠØ¹ Ø±Ø¦ÙŠØ³ÙŠØ©' Ù„ØªØ³Ù„ÙŠØ· Ø§Ù„Ø¶ÙˆØ¡ Ø¹Ù„Ù‰ Ø£Ø¨Ø±Ø² Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ù‚ØµØµÙŠ."}],
                professionalSummary: "Ø£Ù†Ø§ Ù…ØªØ®ØµØµ Ù…ØªÙ…Ø±Ø³ Ø£ØªÙ…ØªØ¹ Ø¨Ø®Ø¨Ø±Ø© ØªØ²ÙŠØ¯ Ø¹Ù† 5 Ø³Ù†ÙˆØ§Øª ÙÙŠ Ù…Ø¬Ø§Ù„ÙŠ. Ù…Ø¹Ø±ÙˆÙ Ø¨Ù‚Ø¯Ø±ØªÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙØ±Ù‚ ÙˆØªØ­Ù‚ÙŠÙ‚ Ù†ØªØ§Ø¦Ø¬ Ù…Ù„Ù…ÙˆØ³Ø©. Ø£Ø³Ø¹Ù‰ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø®Ø¨Ø±Ø§ØªÙŠ ÙÙŠ Ø¯ÙˆØ± Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙŠØ³Ø§Ù‡Ù… ÙÙŠ Ù†Ù…Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©.",
                suggestedJobs: ["Ù…Ø¯ÙŠØ± Ù…Ù†ØªØ¬", "Ù…Ø­Ù„Ù„ Ø£Ø¹Ù…Ø§Ù„", "Ù…Ø³ØªØ´Ø§Ø± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ"]
            });
        } finally {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('challengeBtn').disabled = false;
        }
    };
    
    this.displayAnalysisResults = (data) => {
        document.getElementById('analysisSummary').innerHTML = `<p>${data.summary}</p>`;
        document.getElementById('cvImprovements').innerHTML = `<ul>${data.improvements.map(i => `<li><strong>Ø§Ù„Ø£ØµÙ„/Ø§Ù„Ù†ØµÙŠØ­Ø©:</strong> ${i.original}<br><strong>Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­:</strong> ${i.suggestion}</li>`).join('')}</ul>`;
        document.getElementById('professionalSummary').innerHTML = `<p>${data.professionalSummary}</p>`;
        document.getElementById('suggestedJobs').innerHTML = `<ul>${data.suggestedJobs.map(j => `<li>${j}</li>`).join('')}</ul>`;
        this.renderSkillsChart(data.skillsAnalysis, data.matchScore);
    };

    this.renderSkillsChart = (skillsData, matchScore) => {
        const chartElement = document.getElementById('skillsChart');
        if (Chart.getChart(chartElement)) { Chart.getChart(chartElement).destroy(); }
        new Chart(chartElement.getContext('2d'), {
            type: 'radar',
            data: { labels: Object.keys(skillsData), datasets: [{ label: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª', data: Object.values(skillsData), backgroundColor: 'rgba(46, 139, 87, 0.2)', borderColor: 'rgb(46, 139, 87)', pointBackgroundColor: 'rgb(46, 139, 87)' }] },
            options: { responsive: true, maintainAspectRatio: true, scales: { r: { angleLines: { color: 'rgba(128, 128, 128, 0.2)' }, grid: { color: 'rgba(128, 128, 128, 0.2)' }, pointLabels: { font: { size: 12, family: 'Cairo' }, color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }, ticks: { backdropColor: 'transparent', stepSize: 20 }, suggestedMin: 0, suggestedMax: 100 } }, plugins: { legend: { labels: { font: { family: 'Cairo' }, color: getComputedStyle(document.body).getPropertyValue('--text-primary') } }, title: { display: true, text: `Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${matchScore}%`, font: { size: 16, family: 'Cairo' }, color: getComputedStyle(document.body).getPropertyValue('--text-primary') } } }
        });
    };

    // --- STEP 4: INTERACTIVE CHALLENGE ---
    this.generateChallenge = async () => {
        document.getElementById('challengeLoadingState').style.display = 'block';
        document.getElementById('challengeContent').style.display = 'none';

        try {
            const prompt = `
            TASK: Create a short, practical, work-related challenge scenario for a candidate.
            IMPORTANT: Your entire response and all its contents MUST be in the Arabic language.

            CANDIDATE PROFILE:
            - Specialization: ${this.state.applicationData.basicInfo.specialization}
            - CV Summary: ${this.state.applicationData.analysisResults.summary}
            - Key Skills Identified: ${Object.keys(this.state.applicationData.analysisResults.skillsAnalysis || {}).join(', ')}

            INSTRUCTIONS:
            1. Based on ALL the candidate profile details, create a realistic, single-paragraph scenario that tests one of their key skills in a practical context.
            2. The challenge should be open-ended, asking for steps, a plan, or an approach.
            3. Return ONLY a valid JSON object with no extra text or markdown.
            4. The JSON object must have this structure:
               {
                 "title": "<A short, engaging title for the challenge in Arabic>",
                 "scenario": "<The detailed scenario text in Arabic>"
               }
            `;
            const responseText = await this.callGeminiAPI(prompt);
            const challengeData = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, '').trim());
            this.state.applicationData.interactiveChallenge.scenario = challengeData;
            this.displayChallenge(challengeData);

        } catch (error) {
            console.error("Challenge Generation Error:", error);
            this.showNotification('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¹Ø§Ù….', 'error');
            const fallbackChallenge = {
                title: "Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: Ø¥Ø¯Ø§Ø±Ø© Ø£Ø²Ù…Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©",
                scenario: "ØªØ®ÙŠÙ„ Ø£Ù†Ùƒ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù… Ù…Ø¹ Ù…ÙˆØ¹Ø¯ ØªØ³Ù„ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ ÙŠÙˆÙ…ÙŠÙ†. ÙØ¬Ø£Ø©ØŒ ÙŠØ®Ø¨Ø±Ùƒ Ø¹Ø¶Ùˆ Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ù†Ù‡ Ø³ÙŠØ¶Ø·Ø± Ù„Ù„ØªØºÙŠØ¨ Ù„Ø¸Ø±Ù Ø·Ø§Ø±Ø¦. Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø«Ù„Ø§Ø« Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„ØªÙŠ Ø³ØªØªØ®Ø°Ù‡Ø§ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ù ÙˆØ¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ØŸ"
            };
            this.state.applicationData.interactiveChallenge.scenario = fallbackChallenge;
            this.displayChallenge(fallbackChallenge);
        } finally {
            document.getElementById('challengeLoadingState').style.display = 'none';
            document.getElementById('challengeContent').style.display = 'block';
        }
    };

    this.displayChallenge = (data) => {
        document.getElementById('challengeTitle').textContent = data.title;
        document.getElementById('challengeScenario').textContent = data.scenario;
        document.getElementById('challengeAnswer').value = this.state.applicationData.interactiveChallenge.answer || '';
    };

    // --- STEP 5: INTERVIEW ---
    this.interview = {
        mediaRecorder: null, audioChunks: [], isRecording: false,
        init: async function() {
            const parent = app;
            // Pre-interview warm-up
            const warmupAccepted = await parent.showInterviewModal('warmup');
            if (!warmupAccepted) {
                parent.assistantSpeak("Ù„Ø§ Ø¨Ø£Ø³ØŒ Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©. Ø­Ø¸Ù‹Ø§ Ù…ÙˆÙÙ‚Ù‹Ø§!");
            }
            
            document.getElementById('interviewLoadingState').style.display = 'block';
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('realTimeCoaching').style.display = 'flex';

            const interviewState = parent.state.applicationData.interview;
            
            try {
                const prompt = `
                TASK: Generate 5 diverse and insightful interview questions (behavioral, technical, situational).
                IMPORTANT: Your entire response and all its contents MUST be in the Arabic language.

                CANDIDATE CONTEXT:
                - Specialization: "${parent.state.applicationData.basicInfo.specialization}"
                - CV Analysis Summary: "${parent.state.applicationData.analysisResults.summary}"
                - Key Skills: ${Object.keys(parent.state.applicationData.analysisResults.skillsAnalysis).join(', ')}
                - Candidate's response to the challenge ("${parent.state.applicationData.interactiveChallenge.scenario.title}"): """${parent.state.applicationData.interactiveChallenge.answer}"""

                INSTRUCTIONS:
                1. Generate 5 interview questions in Arabic based on ALL the context provided.
                2. Make the questions smart: one should be a direct follow-up to their challenge answer. Another should probe a potential weakness or area for improvement identified in the CV analysis.
                3. The questions should feel like a real, thoughtful interview, not generic ones.
                4. Return ONLY a valid JSON array of strings. Example: ["Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù„Ù„ØªØ­Ø¯ÙŠØŒ ÙƒÙŠÙ ÙƒÙ†Øª Ø³ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹...ØŸ", "Ø³Ø¤Ø§Ù„ 2", ...]
                `;
                const responseText = await parent.callGeminiAPI(prompt);
                interviewState.questions = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, '').trim());
            } catch (error) {
                console.error("Interview questions generation failed:", error);
                parent.showNotification('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ù…Ø®ØµØµØ©. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ø¦Ù„Ø© Ø¹Ø§Ù…Ø©.', 'error');
                interviewState.questions = [
                    "Ù…Ø§ Ù‡ÙŠ Ø£Ù‡Ù… Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© Ø§Ù„ØªÙŠ ØªÙØªØ®Ø± Ø¨Ù‡Ø§ØŸ", "ØµÙ ØªØ­Ø¯ÙŠÙ‹Ø§ ØµØ¹Ø¨Ù‹Ø§ ÙˆØ§Ø¬Ù‡ØªÙ‡ ÙˆÙƒÙŠÙ ØªØºÙ„Ø¨Øª Ø¹Ù„ÙŠÙ‡.",
                    "Ø£ÙŠÙ† ØªØ±Ù‰ Ù†ÙØ³Ùƒ Ù…Ù‡Ù†ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø³Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø¢Ù†ØŸ", "ÙƒÙŠÙ ØªÙˆØ§ÙƒØ¨ Ø§Ù„ØªØ·ÙˆØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ø¬Ø§Ù„ Ø¹Ù…Ù„ÙƒØŸ",
                    "Ù„Ù…Ø§Ø°Ø§ ØªØ¹ØªÙ‚Ø¯ Ø£Ù†Ùƒ Ø§Ù„Ù…Ø±Ø´Ø­ Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØ©ØŸ"
                ];
            }
            interviewState.answers = new Array(interviewState.questions.length).fill(null).map(() => ({ text: '', audioUrl: null }));
            interviewState.currentQuestion = 0;
            document.getElementById('interviewLoadingState').style.display = 'none';
            document.getElementById('questionCard').style.display = 'block';
            this.displayCurrentQuestion();
        },
        displayCurrentQuestion: function() { const parent = app; const interviewState = parent.state.applicationData.interview; const qIndex = interviewState.currentQuestion; document.getElementById('currentQuestion').textContent = qIndex + 1; document.getElementById('totalQuestions').textContent = interviewState.questions.length; document.getElementById('questionText').textContent = interviewState.questions[qIndex]; document.getElementById('textAnswer').value = interviewState.answers[qIndex]?.text || ''; this.updateNavButtons(); this.resetAudio(); this.updateRealTimeCoaching(); },
        saveCurrentAnswer: function() { const parent = app; const interviewState = parent.state.applicationData.interview; const qIndex = interviewState.currentQuestion; if (!interviewState.answers[qIndex]) { interviewState.answers[qIndex] = { text: '', audioUrl: null }; } interviewState.answers[qIndex].text = document.getElementById('textAnswer').value; parent.saveState(); },
        nextQuestion: function() { const parent = app; const interviewState = parent.state.applicationData.interview; this.saveCurrentAnswer(); if (interviewState.currentQuestion < interviewState.questions.length - 1) { interviewState.currentQuestion++; this.displayCurrentQuestion(); } },
        previousQuestion: function() { const parent = app; const interviewState = parent.state.applicationData.interview; this.saveCurrentAnswer(); if (interviewState.currentQuestion > 0) { interviewState.currentQuestion--; this.displayCurrentQuestion(); } },
        finishInterview: async function() { 
            this.saveCurrentAnswer(); 
            app.unlockAchievement('Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø¨Ø§Ø±Ø¹', 'Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
            const debriefDone = await app.showInterviewModal('debrief');
            app.nextStep(); 
        },
        updateNavButtons: function() { const parent = app; const interviewState = parent.state.applicationData.interview; const qIndex = interviewState.currentQuestion; document.getElementById('prevQuestionBtn').disabled = qIndex === 0; const isLast = qIndex === interviewState.questions.length - 1; document.getElementById('nextQuestionBtn').style.display = isLast ? 'none' : 'inline-flex'; document.getElementById('finishInterviewBtn').style.display = isLast ? 'inline-flex' : 'none'; },
        toggleRecording: async function() { if (this.isRecording) { this.stopRecording(); } else { await this.startRecording(); } },
        startRecording: async function() { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); this.mediaRecorder = new MediaRecorder(stream); this.audioChunks = []; this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data); this.mediaRecorder.onstop = () => { const parent = app; const interviewState = parent.state.applicationData.interview; const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' }); const audioUrl = URL.createObjectURL(audioBlob); if (!interviewState.answers[interviewState.currentQuestion]) { interviewState.answers[interviewState.currentQuestion] = { text: '', audioUrl: null }; } interviewState.answers[interviewState.currentQuestion].audioUrl = audioUrl; document.getElementById('audioPlayback').src = audioUrl; document.getElementById('audioPlayback').style.display = 'block'; document.getElementById('recordingStatus').textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.'; parent.saveState(); }; this.mediaRecorder.start(); this.isRecording = true; const recordBtn = document.getElementById('recordBtn'); recordBtn.classList.add('recording'); recordBtn.innerHTML = '<i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„'; document.getElementById('recordingStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...'; } catch (err) { app.showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.', 'error'); } },
        stopRecording: function() { if (this.mediaRecorder) { this.mediaRecorder.stop(); this.isRecording = false; if (this.mediaRecorder.stream) { this.mediaRecorder.stream.getTracks().forEach(track => track.stop()); } const recordBtn = document.getElementById('recordBtn'); recordBtn.classList.remove('recording'); recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'; } },
        resetAudio: function() { this.stopRecording(); const parent = app; const interviewState = parent.state.applicationData.interview; const audioUrl = interviewState.answers[interviewState.currentQuestion]?.audioUrl; const audioPlayback = document.getElementById('audioPlayback'); if (audioUrl) { audioPlayback.src = audioUrl; audioPlayback.style.display = 'block'; document.getElementById('recordingStatus').textContent = 'ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø­ÙÙˆØ¸.'; } else { audioPlayback.style.display = 'none'; audioPlayback.src = ''; document.getElementById('recordingStatus').textContent = ''; } },
        updateRealTimeCoaching: function() {
            const text = app.dom.textAnswerTextarea.value;
            const wordCount = text.split(/\s+/).filter(Boolean).length;
            let brevityStatus = 'Ù…Ù…ØªØ§Ø²';
            if (wordCount > 100) brevityStatus = 'Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§';
            else if (wordCount > 60) brevityStatus = 'Ø·ÙˆÙŠÙ„';
            document.getElementById('brevityMeter').textContent = brevityStatus;

            const powerWordsFound = text.toLowerCase().split(/\s+/).filter(word => app.config.powerWords.includes(word)).length;
            document.getElementById('powerWordsMeter').textContent = powerWordsFound;
        }
    };

    // --- INTERVIEW MODALS ---
    this.showInterviewModal = (type) => {
        return new Promise(resolve => {
            let content = '';
            if (type === 'warmup') {
                content = `
                    <h2><i class="fas fa-mug-hot"></i> Ø¥Ø­Ù…Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©</h2>
                    <p>Ø£Ø¹Ù„Ù… Ø£Ù† Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø±Ù‡Ù‚Ø©. Ù‚Ø¨Ù„ Ø£Ù† Ù†Ø¨Ø¯Ø£ØŒ Ù…Ø§ Ø±Ø£ÙŠÙƒ ÙÙŠ Ø¥Ø­Ù…Ø§Ø¡ Ø³Ø±ÙŠØ¹ØŸ Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù† Ø´ÙŠØ¡ Ù…Ù…ØªØ¹ ØªØ¹Ù„Ù…ØªÙ‡ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„.</p>
                    <p class="disclaimer">Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡ ÙÙ‚Ø· ÙˆÙ„Ù† ÙŠØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡.</p>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="skipWarmup">ØªØ®Ø·Ù Ø§Ù„Ø¥Ø­Ù…Ø§Ø¡</button>
                        <button class="btn btn-primary" id="startWarmup">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¥Ø­Ù…Ø§Ø¡</button>
                    </div>`;
            } else if (type === 'debrief') {
                content = `
                    <h2><i class="fas fa-award"></i> Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹!</h2>
                    <p>Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­. ÙƒÙŠÙ ØªØ´Ø¹Ø± Ø­ÙŠØ§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒØŸ Ø®Ø° Ù„Ø­Ø¸Ø© Ù„Ù„ØªÙÙƒÙŠØ±.</p>
                    <p class="disclaimer">ØªÙÙƒÙŠØ±Ùƒ ÙÙŠ Ø£Ø¯Ø§Ø¦Ùƒ Ù‡Ùˆ Ø¨Ø­Ø¯ Ø°Ø§ØªÙ‡ Ù…Ù‡Ø§Ø±Ø© Ù…Ù‡Ù…Ø©.</p>
                     <div class="form-actions">
                        <button class="btn btn-primary" id="viewReport">Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ±ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
                    </div>`;
            }

            this.dom.interviewModalContent.innerHTML = content;
            this.dom.interviewModal.classList.add('show');

            const closeModal = (resolution) => {
                this.dom.interviewModal.classList.remove('show');
                resolve(resolution);
            };

            if (type === 'warmup') {
                document.getElementById('skipWarmup').onclick = () => closeModal(false);
                document.getElementById('startWarmup').onclick = () => {
                     this.assistantSpeak('Ø¹Ø¸ÙŠÙ…! Ø®Ø° ÙˆÙ‚ØªÙƒ. Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©.');
                     closeModal(true);
                }
            } else {
                document.getElementById('viewReport').onclick = () => closeModal(true);
            }
        });
    };

    // --- STEP 6: FINAL REPORT ---
    this.generateFinalReport = async () => {
        document.getElementById('reportLoadingState').style.display = 'block';
        document.getElementById('reportContainer').style.display = 'none';
        document.getElementById('reportActions').style.display = 'none';

        try {
            const interviewSummary = this.state.applicationData.interview.answers.map((ans, i) => 
                `Q${i+1}: ${this.state.applicationData.interview.questions[i]}\nA: ${ans.text || '(No text answer)'}`
            ).join('\n---\n');

            const prompt = `
            TASK: Generate a comprehensive, empathetic, and actionable final evaluation report for a job candidate.
            IMPORTANT: Your entire response MUST be in Arabic and structured as a single, valid JSON object.

            CANDIDATE'S FULL DATA:
            - Basic Info: ${JSON.stringify(this.state.applicationData.basicInfo)}
            - CV Analysis: ${JSON.stringify(this.state.applicationData.analysisResults)}
            - Challenge ("${this.state.applicationData.interactiveChallenge.scenario.title}") Answer: """${this.state.applicationData.interactiveChallenge.answer}"""
            - Full Interview Transcript: """${interviewSummary}"""

            INSTRUCTIONS:
            1. Analyze all data to form a holistic, 360-degree view. The tone should be that of a personal career coach.
            2. Return ONLY a valid JSON object with the exact following structure:
            {
                "finalScore": <overall numeric score 0-100 based on all inputs>,
                "strengths": ["<Insightful strength 1 based on evidence, in Arabic>", "<Strength 2>", "<Strength 3>"],
                "improvements": ["<Actionable improvement area 1, in Arabic>", "<Improvement 2>"],
                "personalityAnalysis": {
                    "summary": "<A gentle, non-judgmental analysis of communication style and potential traits (e.g., 'ÙŠÙØ¸Ù‡Ø± Ø£Ø³Ù„ÙˆØ¨Ùƒ Ø§Ù„ÙƒØªØ§Ø¨ÙŠ Ù…ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠ ÙˆØ§Ù„Ù…Ù†Ø¸Ù…...') based on all written text, in Arabic>",
                    "disclaimer": "Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆÙ…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„ØºÙˆÙŠ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙ…Ø«Ù„ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ù†ÙØ³ÙŠØ§Ù‹ Ù‚Ø§Ø·Ø¹Ø§Ù‹."
                },
                "salaryAnalysis": "<A helpful comment in Arabic on the expected salary (${this.state.applicationData.basicInfo.expectedSalary || 'N/A'}) compared to the market for their role and experience, offering advice.>",
                "marketBenchmark": "<A specific statement benchmarking the candidate against the market, e.g., 'Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ [Skill X] ØªØ¶Ø¹Ùƒ Ø¶Ù…Ù† Ø£ÙØ¶Ù„ 20% Ù…Ù† Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.'>",
                "careerRoadmap": [
                    { "path": "<A primary, realistic career path option in Arabic>", "skills": "<Specific skills/certs to develop for this path>" },
                    { "path": "<An alternative, interesting career path option in Arabic>", "skills": "<Specific skills/certs to develop>" }
                ],
                "finalVerdict": "<A concluding, encouraging 2-sentence summary of the candidate's potential and suitability, in Arabic>"
            }
            `;

            const responseText = await this.callGeminiAPI(prompt);
            const reportData = JSON.parse(responseText.replace(/```json/g, '').replace(/```/g, '').trim());
            
            this.state.applicationData.finalReport = reportData;
            this.displayFinalReport(reportData);

        } catch (error) {
            console.error("Report Generation Error:", error);
            this.showNotification('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©.', 'error');
            this.state.applicationData.finalReport = {
                finalScore: 82,
                strengths: ["Ø®Ø¨Ø±Ø© Ø¹Ù…Ù„ÙŠØ© Ù‚ÙˆÙŠØ©", "Ù…Ù‡Ø§Ø±Ø§Øª ØªÙˆØ§ØµÙ„ ÙˆØ§Ø¶Ø­Ø©", "Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø¯Ø±ÙˆØ³Ø© ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©"],
                improvements: ["ØªØ¹Ù…ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙÙŠ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©", "Ø§ÙƒØªØ³Ø§Ø¨ Ø®Ø¨Ø±Ø© ÙÙŠ Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙØ±Ù‚"],
                personalityAnalysis: { summary: "ÙŠØªÙ…ÙŠØ² Ø§Ù„Ù…Ø±Ø´Ø­ Ø¨Ø£Ø³Ù„ÙˆØ¨ ØªÙˆØ§ØµÙ„ÙŠ Ù…Ø¨Ø§Ø´Ø± ÙˆØªØ­Ù„ÙŠÙ„ÙŠØŒ Ù…Ø¹ Ù…ÙŠÙ„ ÙˆØ§Ø¶Ø­ Ù†Ø­Ùˆ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†Ù‡Ø¬ÙŠ.", disclaimer: "Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆÙ…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù„ØºÙˆÙŠ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙ…Ø«Ù„ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ù†ÙØ³ÙŠØ§Ù‹ Ù‚Ø§Ø·Ø¹Ø§Ù‹." },
                salaryAnalysis: "Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ ÙŠÙ‚Ø¹ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙˆØ³Ø· Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù…Ø§Ø«Ù„Ø© ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù…Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù‡ ØªÙˆÙ‚Ø¹Ø§Ù‹ ÙˆØ§Ù‚Ø¹ÙŠØ§Ù‹.",
                marketBenchmark: "Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØªØ¶Ø¹Ùƒ Ø¶Ù…Ù† Ø£ÙØ¶Ù„ 25% Ù…Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù‚Ù…Ù†Ø§ Ø¨ØªØ­Ù„ÙŠÙ„Ù‡Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±.",
                careerRoadmap: [{ path: "Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„", skills: "Ø´Ù‡Ø§Ø¯Ø© PMP, Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª" }, { path: "Ø®Ø¨ÙŠØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…Ù†ØªØ¬Ø§Øª", skills: "Ø£Ø¨Ø­Ø§Ø« Ø§Ù„Ø³ÙˆÙ‚, ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†" }],
                finalVerdict: "Ù…Ø±Ø´Ø­ ÙˆØ§Ø¹Ø¯ Ø¬Ø¯Ø§Ù‹ ÙŠÙ…ØªÙ„Ùƒ Ø£Ø³Ø§Ø³Ø§Ù‹ Ù…ØªÙŠÙ†Ø§Ù‹ ÙˆØ¥Ù…ÙƒØ§Ù†Ø§Øª Ù†Ù…Ùˆ Ø¹Ø§Ù„ÙŠØ©. ÙŠÙˆØµÙ‰ Ø¨Ù‡ Ø¨Ø´Ø¯Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©."
            };
            this.displayFinalReport(this.state.applicationData.finalReport);
        } finally {
            document.getElementById('reportLoadingState').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
            document.getElementById('reportActions').style.display = 'flex';
        }
    };
    
    this.displayFinalReport = (data) => {
        const basicInfo = this.state.applicationData.basicInfo;
        const analysis = this.state.applicationData.analysisResults;
        const reportHTML = `
            <div id="pdf-report">
                <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid var(--primary); padding-bottom: 1rem;">
                    <h2 style="color: var(--primary);">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
                    <p>Ø§Ù„Ù…Ø±Ø´Ø­: ${basicInfo.fullName}</p>
                </div>
                <div class="report-grid">
                    <div class="report-item"><h4><i class="fas fa-bullseye"></i> Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h4><p style="font-size: 1.5rem; font-weight: 700;">${data.finalScore}%</p></div>
                    <div class="report-item"><h4><i class="fas fa-file-signature"></i> ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø³ÙŠØ±Ø©</h4><p>${analysis.matchScore || 'N/A'}%</p></div>
                    <div class="report-item"><h4><i class="fas fa-money-bill-wave"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</h4><p>${data.salaryAnalysis}</p></div>
                </div>
                
                <div class="detail-card" style="margin-top: 1.5rem;">
                    <h3><i class="fas fa-chart-simple"></i> Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚</h3>
                    <p>${data.marketBenchmark}</p>
                </div>

                <div class="report-grid" style="grid-template-columns: 1fr 1fr; margin-top: 1.5rem;">
                     <div class="detail-card">
                        <h3><i class="fas fa-star"></i> Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h3>
                        <ul>${data.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                    </div>
                    <div class="detail-card">
                        <h3><i class="fas fa-arrow-up"></i> Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±</h3>
                        <ul>${data.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
                    </div>
                </div>

                <div class="detail-card" style="margin-top: 1.5rem;">
                    <h3><i class="fas fa-user-secret"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ ÙˆØ§Ù„Ø´Ø®ØµÙŠØ© (ØªØ¬Ø±ÙŠØ¨ÙŠ)</h3>
                    <p>${data.personalityAnalysis.summary}</p>
                    <p class="disclaimer">${data.personalityAnalysis.disclaimer}</p>
                </div>

                <div class="detail-card" style="margin-top: 1.5rem;">
                    <h3><i class="fas fa-road"></i> Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</h3>
                    <div class="career-path-explorer">
                        ${data.careerRoadmap.map(r => `
                            <div class="career-path-node">
                                <h4>${r.path}</h4>
                                <p><strong>Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> ${r.skills}</p>
                            </div>`).join('')}
                    </div>
                </div>

                <div class="detail-card" style="margin-top: 1.5rem; background-color: color-mix(in srgb, var(--primary) 10%, transparent); border-color: var(--primary);">
                    <h3><i class="fas fa-gavel"></i> Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
                    <p>${data.finalVerdict}</p>
                </div>
            </div>
        `;
        document.getElementById('reportContainer').innerHTML = reportHTML;
        this.unlockAchievement('Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©', 'Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØªÙˆØµÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©!');
    };
    
    this.downloadReport = async () => { const { jsPDF } = window.jspdf; const reportElement = document.getElementById('pdf-report'); this.showNotification('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„...', 'success'); const canvas = await html2canvas(reportElement, { scale: 2, useCORS: true, backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-content'), }); const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] }); pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height); pdf.save(`ØªÙ‚Ø±ÙŠØ±-${this.state.applicationData.basicInfo.fullName}.pdf`); };
    this.submitApplication = () => { const allApplications = JSON.parse(localStorage.getItem('submittedApplications')) || []; allApplications.push({ id: Date.now(), submittedAt: new Date().toISOString(), ...this.state.applicationData }); localStorage.setItem('submittedApplications', JSON.stringify(allApplications)); localStorage.removeItem('appState'); this.showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙƒÙ„ Ø§Ù„ØªÙˆÙÙŠÙ‚.', 'success'); setTimeout(() => window.location.reload(), 3000); };

    // --- UTILITIES & API ---
    this.callGeminiAPI = async (prompt) => {
        if (this.config.geminiApiKey === 'YOUR_GEMINI_API_KEY') {
            console.warn("Gemini API key is not set. Throwing a mock error to use fallback data.");
            throw new Error("Gemini API key is not configured.");
        }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.geminiModel}:generateContent?key=${this.config.geminiApiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: [
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData?.error?.message || `HTTP error! status: ${response.status}`;
            throw new Error(`Gemini API Error: ${errorMessage}`);
        }

        const data = await response.json();
        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts[0].text) {
             return data.candidates[0].content.parts[0].text;
        } else {
             const blockReason = data.promptFeedback?.blockReason || data.candidates?.[0]?.finishReason;
             if (blockReason) {
                throw new Error(`Gemini API call was blocked. Reason: ${blockReason}. Review prompt and safety settings.`);
             }
             throw new Error('Invalid response structure from Gemini API. Check the API console.');
        }
    };
    
    this.showNotification = (message, type = 'success') => { const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'times-circle'}"></i> ${message}`; document.body.appendChild(notification); setTimeout(() => notification.classList.add('show'), 100); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, 5000); };
    
    this.assistantSpeakForStep = (step) => {
        const persona = this.state.persona;
        const insight = this.config.marketInsights[persona] || '';
        const messages = {
            1: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù„Ù†Ø¨Ø¯Ø£ Ù…Ø¹Ù‹Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©. Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù†Ùƒ.",
            2: `Ù…Ù…ØªØ§Ø² ÙŠØ§ ${this.state.applicationData.basicInfo.fullName || ''}! Ø§Ù„Ø¢Ù†ØŒ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø­ÙˆØ±ÙŠØ©: Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ©. ØªØ°ÙƒØ±ØŒ Ù‡Ø°Ù‡ ÙØ±ØµØªÙƒ Ù„ØªÙ„Ù…Ø¹. ${insight}`,
            3: "Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ù…Ù„Ù. Ø³Ø£Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±ÙƒØ§ØªÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©. Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ù„Ø­Ø¸Ø§Øª.",
            4: "ØªØ­Ù„ÙŠÙ„ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! Ø§Ù„Ø¢Ù† Ù„Ù†Ø± ÙƒÙŠÙ ØªØ·Ø¨Ù‚ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø£Ø±Ø¶ Ø§Ù„ÙˆØ§Ù‚Ø¹. Ù„Ù‚Ø¯ Ø£Ø¹Ø¯Ø¯Øª Ù„Ùƒ ØªØ­Ø¯ÙŠØ§Ù‹ Ø¹Ù…Ù„ÙŠØ§Ù‹ Ù‚ØµÙŠØ±Ø§Ù‹.",
            5: `Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¯Ø±ÙˆØ³Ø©! Ø§Ù„Ø¢Ù†ØŒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ø§ Ø³Ø¨Ù‚ØŒ Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©. ØªØ°ÙƒØ±ØŒ Ø§Ù„Ù‡Ø¯Ù Ù‡Ùˆ ÙÙ‡Ù… Ø·Ø±ÙŠÙ‚Ø© ØªÙÙƒÙŠØ±Ùƒ. ${persona === 'developer' ? 'ÙÙƒØ± ÙÙŠÙ‡Ø§ ÙƒØ¬Ù„Ø³Ø© pair programming.' : 'ÙÙƒØ± ÙÙŠÙ‡Ø§ ÙƒØ¬Ù„Ø³Ø© Ø¹ØµÙ Ø°Ù‡Ù†ÙŠ.'}`,
            6: "Ù„Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…! Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹. Ø£Ù†Ø§ Ø§Ù„Ø¢Ù† Ø£Ù‚ÙˆÙ… Ø¨ØªØ¬Ù…ÙŠØ¹ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ®Ø§Ø±Ø·Ø© Ø·Ø±ÙŠÙ‚Ùƒ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©."
        };
        if (messages[step]) {
            this.assistantSpeak(messages[step]);
        }
    };

    this.assistantSpeak = (message) => { 
        this.dom.aiAssistantMessage.textContent = message; 
        this.dom.aiAssistant.classList.add('show');
    };
};

// --- Instantiate and run the app ---
const app = new App();
document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>