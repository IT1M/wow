<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شركة ميس للمنتجات الطبية - منصة الذكاء الاصطناعي المتقدمة</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow-primary: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --shadow-hover: 0 15px 40px rgba(102, 126, 234, 0.4);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --bg-primary: #fff;
            --bg-secondary: #f8f9fa;
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --glass-bg: rgba(26, 32, 44, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-primary: rgba(26, 32, 44, 0.9);
            --bg-secondary: rgba(45, 55, 72, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: var(--text-primary); overflow-x: hidden; position: relative; }
        body.dark-mode { background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%); }

        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        .main-container { margin-top: 100px; min-height: 100vh; padding: 2rem; }
        .smart-dashboard { max-width: 1600px; margin: 0 auto; display: grid; grid-template-areas: "tools chat analytics" "insights insights insights" "products products products"; grid-template-columns: 1fr 2fr 1fr; gap: 2rem; margin-bottom: 3rem; }
        
        /* --- Tool Sections General --- */
        .tool-section {
            display: none; /* Hidden by default */
            max-width: 1600px; margin: 0 auto; background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: var(--border-radius); padding: 3rem;
            box-shadow: var(--shadow-primary); animation: fadeIn 0.5s ease-in-out;
        }
        body.dark-mode .tool-section { background: var(--bg-primary); }
        .tool-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--glass-border); padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .tool-section-title { font-size: 2rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .back-to-dashboard-btn { background: var(--primary-gradient); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .back-to-dashboard-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-hover); }
        .tool-form-container, .tool-results-container { padding: 1.5rem; border-radius: 15px; background: var(--bg-secondary); }
        .tool-results-container h4 { margin-bottom: 1rem; color: var(--text-primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;}
        .result-content { margin-top: 1rem; color: var(--text-secondary); line-height: 1.8; white-space: normal; font-family: 'Tajawal', sans-serif; }
        .result-content h1, .result-content h2, .result-content h3, .result-content h4 { color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-family: 'Cairo', sans-serif; }
        .result-content table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: var(--bg-primary); }
        .result-content th, .result-content td { border: 1px solid var(--glass-border); padding: 0.8rem; text-align: right; }
        .result-content th { background-color: rgba(102, 126, 234, 0.1); }
        .result-content ul, .result-content ol { padding-right: 20px; }
        
        /* --- Generic & Reusable Styles --- */
        .panel-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--glass-border); }
        .panel-title { font-size: 1.5rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .tool-item { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; cursor: pointer; transition: var(--transition); width: 100%; text-align: right; font-family: 'Cairo', sans-serif; font-weight: 600; position: relative; overflow: hidden; }
        .tool-item:hover { color: white; transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-hover); }
        .tool-item:disabled { cursor: not-allowed; background: #ccc; color: #666; }
        .tool-item:disabled:hover { transform: none; box-shadow: none; }
        .tool-item i { margin-left: 10px; font-size: 1.3rem; }
        .form-input { width: 100%; padding: 1rem 1.5rem; border: 2px solid transparent; background: var(--bg-primary); border-radius: 25px; font-size: 1rem; outline: none; font-family: 'Cairo', sans-serif; transition: var(--transition); color: var(--text-primary); }
        .form-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); }
        
        .header { background: var(--glass-bg); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); position: fixed; top: 0; width: 100%; z-index: 1000; padding: 1rem 0; transition: var(--transition); }
        .logo { font-size: 2.2rem; font-weight: 900; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
        .ai-tools-panel, .chat-interface { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--border-radius); padding: 2rem; box-shadow: var(--shadow-primary); transition: var(--transition); }
        .ai-tools-panel { grid-area: tools; }
        .chat-interface { grid-area: chat; display: flex; flex-direction: column; height: 700px; }
        .chat-header { background: var(--primary-gradient); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; text-align: center; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; background: var(--bg-secondary); border-radius: 15px; margin-bottom: 1rem; }
        .message { background: var(--bg-primary); padding: 1rem; border-radius: 15px; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); animation: slideIn 0.5s ease; max-width: 85%; color: var(--text-primary); }
        .message.ai { background: var(--primary-gradient); color: white; margin-right: auto; }
        .message.user { background: #e3f2fd; margin-left: auto; }
        body.dark-mode .message.user { background: rgba(74, 85, 104, 0.8); }
        .chat-input-container { display: flex; gap: 1rem; align-items: center; }
        .action-btn { background: var(--primary-gradient); color: white; border: none; padding: 1rem; border-radius: 50%; cursor: pointer; font-size: 1rem; transition: var(--transition); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: var(--transition); }
        body.dark-mode .loading-overlay { background: rgba(0, 0, 0, 0.8); }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .spinner { width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        
        .notification-container { position: fixed; top: 100px; right: 20px; z-index: 1001; max-width: 400px; }
        .notification { background: var(--bg-primary); border-radius: 15px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow-primary); border-left: 4px solid; transform: translateX(120%); animation: slideInRight 0.5s ease forwards; }
        .notification.info { border-left-color: #4facfe; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.error { border-left-color: #ef4444; }

        .tool-content-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(120%); } to { transform: translateX(0); } }

        @media (max-width: 1200px) { .smart-dashboard { grid-template-areas: "chat chat" "tools analytics" "insights insights" "products products"; grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .smart-dashboard { grid-template-areas: "chat" "tools" "analytics" "insights" "products"; grid-template-columns: 1fr; } .main-container { padding: 1rem; margin-top: 80px; } }
        @media (max-width: 480px) { .tool-content-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="loading-overlay active" id="loadingOverlay"><div class="spinner"></div></div>
    <div class="notification-container" id="notificationContainer"></div>
    
    <header class="header" id="header">
        <div class="nav-container"><a href="#" class="logo" onclick="showMainDashboard()"><i class="fas fa-brain"></i> ميس AI</a></div>
    </header>

    <div class="main-container">
        <!-- Main Dashboard (Visible by default) -->
        <div class="smart-dashboard" id="mainDashboard">
            <div class="ai-tools-panel">
                <div class="panel-header"><h3 class="panel-title">أدوات الذكاء الاصطناعي</h3></div>
                <button class="tool-item" onclick="showToolSection('tool-section-report')"><i class="fas fa-chart-line"></i> تقارير تحليلية</button>
                <button class="tool-item" onclick="showToolSection('tool-section-product-analysis')"><i class="fas fa-microscope"></i> تحليل المنتجات</button>
                <button class="tool-item" onclick="showToolSection('tool-section-trends')"><i class="fas fa-chart-area"></i> توقع الاتجاهات</button>
                <button class="tool-item" onclick="showToolSection('tool-section-quality')"><i class="fas fa-shield-alt"></i> تقييم الجودة</button>
                <button class="tool-item" onclick="showToolSection('tool-section-market')"><i class="fas fa-chart-pie"></i> تحليل السوق</button>
                <button class="tool-item" onclick="showToolSection('tool-section-inventory')"><i class="fas fa-boxes"></i> تحسين المخزون</button>
                <button class="tool-item" onclick="showToolSection('tool-section-customer')"><i class="fas fa-users"></i> رؤى العملاء</button>
            </div>
            <div class="chat-interface">
                <div class="chat-header"><h3><i class="fas fa-robot"></i> مساعد ميس الذكي</h3></div>
                <div class="chat-messages" id="chatMessages"><div class="message ai"><strong>🤖 مساعد ميس:</strong> كيف يمكنني مساعدتك اليوم؟</div></div>
                <div class="chat-input-container">
                    <input type="text" class="form-input" id="chatInput" placeholder="اكتب سؤالك هنا..." onkeypress="handleKeyPress(event)">
                    <button class="action-btn" id="sendMessageBtn" onclick="sendMessage()" title="إرسال"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div class="analytics-panel" id="analytics-placeholder" style="grid-area: analytics;"></div>
            <div class="smart-insights" id="insights-placeholder" style="grid-area: insights;"></div>
            <div class="products-section" id="products-placeholder" style="grid-area: products;"></div>
        </div>
        
        <!-- Container for all hidden tool sections -->
        <div id="tool-sections-container">
            <!-- All Tool Sections have the same structure for simplicity and robustness -->
            <!-- 1. Report Generator Section -->
            <div id="tool-section-report" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-chart-line"></i> مولّد التقارير التحليلية</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التقرير</h4>
                        <form id="reportForm" onsubmit="runAITool(event, 'reportForm', 'reportResultArea', buildReportPrompt)">
                            <div class="form-group"><label for="reportType">نوع التقرير:</label><select id="reportType" class="form-input"><option value="تحليل شامل للمبيعات">تحليل المبيعات</option><option value="تقييم شامل للجودة">تقييم الجودة</option><option value="تحليل أداء المخزون">أداء المخزون</option></select></div>
                            <div class="form-group"><label for="reportPeriod">الفترة الزمنية:</label><select id="reportPeriod" class="form-input"><option value="آخر 30 يوم">آخر 30 يوم</option><option value="الربع الأخير">الربع الأخير</option><option value="هذا العام">هذا العام</option></select></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">🚀 إنشاء التقرير</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="reportResultArea"><h4>نتائج التقرير</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>

            <!-- 2. Product Analysis Section -->
            <div id="tool-section-product-analysis" class="tool-section">
                 <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-microscope"></i> تحليل ومقارنة المنتجات</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                 <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التحليل</h4>
                        <form id="productAnalysisForm" onsubmit="runAITool(event, 'productAnalysisForm', 'productAnalysisResultArea', buildProductAnalysisPrompt)">
                             <div class="form-group"><label for="productSelect1">المنتج الأول:</label><select id="productSelect1" class="form-input"></select></div>
                             <div class="form-group"><label for="productSelect2">المنتج الثاني (للمقارنة):</label><select id="productSelect2" class="form-input"></select></div>
                             <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">🔬 تحليل ومقارنة</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="productAnalysisResultArea"><h4>نتائج التحليل</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                 </div>
            </div>

            <!-- Add other sections with the same robust structure -->
            <!-- 3. Trend Prediction -->
            <div id="tool-section-trends" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-chart-area"></i> توقع الاتجاهات</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التوقع</h4>
                        <form id="trendsForm" onsubmit="runAITool(event, 'trendsForm', 'trendsResultArea', buildTrendsPrompt)">
                            <div class="form-group"><label for="trendMarket">القطاع السوقي:</label><select id="trendMarket" class="form-input"></select></div>
                            <div class="form-group"><label for="trendTimeframe">المدى الزمني:</label><select id="trendTimeframe" class="form-input"><option value="6 أشهر">6 أشهر</option><option value="سنة">سنة</option></select></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">🔮 عرض التوقعات</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="trendsResultArea"><h4>تحليل الاتجاهات</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>

            <!-- 4. Quality Assessment -->
            <div id="tool-section-quality" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-shield-alt"></i> تقييم الجودة</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التقييم</h4>
                        <form id="qualityForm" onsubmit="runAITool(event, 'qualityForm', 'qualityResultArea', buildQualityPrompt)">
                            <div class="form-group"><label for="qualityProductSelect">المنتج:</label><select id="qualityProductSelect" class="form-input"></select></div>
                            <div class="form-group"><label for="qualityStandards">المعايير:</label><input type="text" id="qualityStandards" class="form-input" value="ISO 13485, FDA, CE"></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">🛡️ تقييم</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="qualityResultArea"><h4>تقرير الجودة</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>

            <!-- 5. Market Analysis -->
            <div id="tool-section-market" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-chart-pie"></i> تحليل السوق</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التحليل</h4>
                        <form id="marketForm" onsubmit="runAITool(event, 'marketForm', 'marketResultArea', buildMarketPrompt)">
                            <div class="form-group"><label for="marketCategorySelect">قطاع المنتج:</label><select id="marketCategorySelect" class="form-input"></select></div>
                            <div class="form-group"><label for="marketCompetitors">المنافسين:</label><input type="text" id="marketCompetitors" class="form-input" placeholder="شركة أ, شركة ب"></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">📊 تحليل</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="marketResultArea"><h4>تحليل SWOT</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>

            <!-- 6. Inventory Optimization -->
            <div id="tool-section-inventory" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-boxes"></i> تحسين المخزون</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التحسين</h4>
                        <form id="inventoryForm" onsubmit="runAITool(event, 'inventoryForm', 'inventoryResultArea', buildInventoryPrompt)">
                            <div class="form-group"><label for="inventoryProductSelect">المنتج:</label><select id="inventoryProductSelect" class="form-input"></select></div>
                            <div class="form-group"><label for="inventoryLeadTime">وقت التوريد (أيام):</label><input type="number" id="inventoryLeadTime" class="form-input" value="14"></div>
                            <div class="form-group"><label for="inventoryDemand">الطلب الشهري:</label><input type="number" id="inventoryDemand" class="form-input" value="500"></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">📦 حساب</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="inventoryResultArea"><h4>توصيات المخزون</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>

            <!-- 7. Customer Insights -->
            <div id="tool-section-customer" class="tool-section">
                <div class="tool-section-header"><h3 class="tool-section-title"><i class="fas fa-users"></i> رؤى العملاء</h3><button class="back-to-dashboard-btn" onclick="showMainDashboard()">العودة <i class="fas fa-arrow-left"></i></button></div>
                <div class="tool-content-grid">
                    <div class="tool-form-container">
                        <h4>خيارات التحليل</h4>
                        <form id="customerForm" onsubmit="runAITool(event, 'customerForm', 'customerResultArea', buildCustomerPrompt)">
                            <div class="form-group"><label for="customerCategorySelect">فئة المنتج:</label><select id="customerCategorySelect" class="form-input"></select></div>
                            <div class="form-group"><label for="customerSegment">شريحة العملاء:</label><select id="customerSegment" class="form-input"><option value="المستشفيات">المستشفيات</option><option value="العيادات">العيادات</option></select></div>
                            <button type="submit" class="tool-item" style="width:100%; margin-top:1rem;">👥 توليد رؤى</button>
                        </form>
                    </div>
                    <div class="tool-results-container" id="customerResultArea"><h4>شخصية العميل</h4><div class="result-content"><p>النتائج ستظهر هنا.</p></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ===================================================================================
    //  SCRIPT START - Meys AI Platform - v4.0 (Robust & Rate-Limit Proof)
    // ===================================================================================

    // --- CONFIGURATION ---
    const GEMINI_API_KEY = 'AIzaSyBpk8GY5Ya-PPWpWAMrXqJVYc1O8bJDUgU';
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
    
    // --- STATE MANAGEMENT ---
    let isAwaitingApiResponse = false;

    // --- DATA ---
    const productsData = { 'Airway': { name_ar: 'مجرى الهواء', products: [ { name: 'Pharyngeal Airway'}, { name: 'Laryngeal Airway Mask'}]}, 'Anesthesia': { name_ar: 'التخدير', products: [ { name: 'Breathing Filter'}, { name: 'Bacterial & Viral Filters'} ]}, 'Neonatal': { name_ar: 'حديثي الولادة', products: [ { name: 'SIPAP Inflow circuit'}, { name: 'Hat For Neonate'} ] }};

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        initializeParticles();
        populateToolSelects();
        showMainDashboard();
        hideLoading();
    }

    // --- NAVIGATION & UI ---
    function showToolSection(sectionId) {
        document.getElementById('mainDashboard').style.display = 'none';
        document.querySelectorAll('.tool-section').forEach(sec => sec.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';
        window.scrollTo(0, 0);
    }
    function showMainDashboard() {
        document.querySelectorAll('.tool-section').forEach(sec => sec.style.display = 'none');
        document.getElementById('mainDashboard').style.display = 'grid';
    }
    function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
    
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<i class="fas fa-info-circle" style="margin-left: 10px;"></i> ${message}`;
        container.appendChild(notification);
        setTimeout(() => {
            notification.style.transform = 'translateX(120%)';
            setTimeout(() => notification.remove(), 500);
        }, 4000);
    }

    // --- DYNAMIC CONTENT POPULATION ---
    function populateToolSelects() {
        const allProducts = Object.values(productsData).flatMap(cat => cat.products);
        const productOptions = allProducts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        const productOptionsWithEmpty = `<option value="">-- لا شيء --</option>${productOptions}`;
        
        ['productSelect1', 'qualityProductSelect', 'inventoryProductSelect'].forEach(id => {
            document.getElementById(id).innerHTML = productOptions;
        });
        document.getElementById('productSelect2').innerHTML = productOptionsWithEmpty;

        const categoryOptions = Object.values(productsData).map(value => `<option value="${value.name_ar}">${value.name_ar}</option>`).join('');
        ['trendMarket', 'marketCategorySelect', 'customerCategorySelect'].forEach(id => {
            document.getElementById(id).innerHTML = categoryOptions;
        });
    }

    // --- CORE AI & CHAT FUNCTIONS ---
    async function sendMessage() {
        if (isAwaitingApiResponse) {
            showNotification('يرجى الانتظار حتى يكتمل الطلب الحالي.', 'warning');
            return;
        }
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendMessageBtn');
        const message = input.value.trim();
        if (!message) return;

        addMessageToUI(message, 'user');
        input.value = '';
        
        isAwaitingApiResponse = true;
        sendBtn.disabled = true;

        try {
            const prompt = `بصفتك "مساعد ميس الذكي"، أجب على السؤال التالي بإيجاز: "${message}"`;
            const response = await callGeminiAPI(prompt);
            addMessageToUI(response, 'ai');
        } catch (error) {
            addMessageToUI(`عذراً، حدث خطأ: ${error.message}`, 'ai');
        } finally {
            isAwaitingApiResponse = false;
            sendBtn.disabled = false;
        }
    }

    function addMessageToUI(text, sender) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        const cleanText = text.replace(/</g, "<").replace(/>/g, ">");
        messageDiv.innerHTML = sender === 'ai' ? `<strong>🤖 مساعد ميس:</strong> ${cleanText}` : `<strong>👤 أنت:</strong> ${cleanText}`;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    async function callGeminiAPI(prompt) {
        const response = await fetch(GEMINI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const message = errorData.error?.message || `خطأ في الاتصال بالخادم (Status: ${response.status})`;
            // Provide a user-friendly message for quota errors
            if (response.status === 429) {
                throw new Error('تم تجاوز حد الطلبات. يرجى الانتظار دقيقة ثم المحاولة مرة أخرى.');
            }
            throw new Error(message);
        }
        const data = await response.json();
        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
            throw new Error("لم يتم استلام رد صالح من الـ API.");
        }
        return data.candidates[0].content.parts[0].text;
    }

    // --- ROBUST AI TOOL HANDLER ---
    async function runAITool(event, formId, resultAreaId, promptBuilder) {
        event.preventDefault();
        if (isAwaitingApiResponse) {
            showNotification('يرجى الانتظار حتى يكتمل الطلب الحالي.', 'warning');
            return;
        }

        const form = document.getElementById(formId);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        const resultArea = document.getElementById(resultAreaId);
        const resultContent = resultArea.querySelector('.result-content');
        
        // Lock UI
        isAwaitingApiResponse = true;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحليل...';
        resultContent.innerHTML = '<div style="display:flex; justify-content:center; padding: 2rem;"><div class="spinner"></div></div>';

        try {
            const prompt = promptBuilder(form);
            let response = await callGeminiAPI(prompt);
            response = response.replace(/```html/g, '').replace(/```/g, '').trim();
            resultContent.innerHTML = response;
        } catch (error) {
            console.error("AI Tool Error:", error);
            resultContent.innerHTML = `<div style="color:#ef4444; padding: 1rem; border: 1px solid #ef4444; border-radius: 10px;"><h4><i class="fas fa-exclamation-triangle"></i> حدث خطأ</h4><p>${error.message}</p></div>`;
        } finally {
            // Unlock UI
            isAwaitingApiResponse = false;
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    }

    // --- PROMPT BUILDERS ---
    const commonSuffix = "\n\n**ملاحظة: يجب أن تكون الإجابة بتنسيق HTML فقط (بدون ```html). استخدم h3, h4, p, ul, li, table.**";
    function buildReportPrompt(form) { const type = form.querySelector('#reportType').value; const period = form.querySelector('#reportPeriod').value; return `أنشئ تقرير "${type}" عن "${period}".` + commonSuffix; }
    function buildProductAnalysisPrompt(form) { const p1 = form.querySelector('#productSelect1').value; const p2 = form.querySelector('#productSelect2').value; return p2 ? `قارن بين "${p1}" و "${p2}".` : `قدم تحليلًا لـ "${p1}".` + commonSuffix; }
    function buildTrendsPrompt(form) { const market = form.querySelector('#trendMarket').value; const timeframe = form.querySelector('#trendTimeframe').value; return `توقع الاتجاهات في قطاع "${market}" خلال "${timeframe}".` + commonSuffix; }
    function buildQualityPrompt(form) { const product = form.querySelector('#qualityProductSelect').value; const standards = form.querySelector('#qualityStandards').value; return `قيّم جودة "${product}" بناءً على "${standards}".` + commonSuffix; }
    function buildMarketPrompt(form) { const category = form.querySelector('#marketCategorySelect').value; const competitors = form.querySelector('#marketCompetitors').value; return `أنشئ تحليل SWOT لفئة "${category}" ضد المنافسين "${competitors}".` + commonSuffix; }
    function buildInventoryPrompt(form) { const product = form.querySelector('#inventoryProductSelect').value; const leadTime = form.querySelector('#inventoryLeadTime').value; const demand = form.querySelector('#inventoryDemand').value; return `قدم توصيات لمخزون "${product}" (وقت التوريد ${leadTime} يومًا، الطلب الشهري ${demand} وحدة).` + commonSuffix; }
    function buildCustomerPrompt(form) { const category = form.querySelector('#customerCategorySelect').value; const segment = form.querySelector('#customerSegment').value; return `أنشئ شخصية عميل من شريحة "${segment}" تستخدم منتجات فئة "${category}".` + commonSuffix; }

    // --- UTILITIES & EVENT HANDLERS ---
    function handleKeyPress(event) { if (event.key === 'Enter') { document.getElementById('sendMessageBtn').click(); } }
    function initializeParticles() { particlesJS('particles-js', { particles: { number: { value: 40 }, color: { value: "#ffffff" }, shape: { type: "circle" }, opacity: { value: 0.4 }, size: { value: 3, random: true }, line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.3 }, move: { enable: true, speed: 3 } } }); }
    
    </script>
</body>
</html>