<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة التوظيف الذكية - ميس للمنتجات الطبية</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phaser.js CDN removed -->
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            --info-gradient: linear-gradient(135deg, #36D1DC 0%, #5B86E5 100%);
            --dark-blue: #2c3e50;
            --light-gray: #f8f9fa;
            --text-dark: #333;
            --text-medium: #555; 
            --text-light: #777; 
            --border-radius: 16px;
            --box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08); 
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); 
            min-height: 100vh;
            direction: rtl;
            color: var(--text-dark);
            line-height: 1.7; 
            font-size: 16px; 
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }

        .header {
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(15px);
            border-radius: var(--border-radius);
            padding: 35px 40px; 
            margin-bottom: 35px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(200, 210, 220, 0.3); 
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px; 
            background: var(--primary-gradient);
        }

        .logo {
            width: 100px; 
            height: 100px;
            background: var(--primary-gradient);
            border-radius: 50%;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px; 
            color: white;
            animation: pulse 2.5s infinite ease-in-out;
            box-shadow: 0 12px 25px rgba(79, 172, 254, 0.35);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 12px 25px rgba(79, 172, 254, 0.35); }
            50% { transform: scale(1.08); box-shadow: 0 18px 35px rgba(79, 172, 254, 0.45); }
            100% { transform: scale(1); box-shadow: 0 12px 25px rgba(79, 172, 254, 0.35); }
        }

        .company-title {
            font-size: 3rem; 
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 800;
            position: relative;
            display: inline-block;
        }

        .company-title::after {
            content: '';
            position: absolute;
            bottom: -12px;
            right: 50%; 
            transform: translateX(50%);
            width: 70%; 
            height: 3.5px;
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .subtitle {
            color: var(--text-medium);
            font-size: 1.35rem; 
            margin-bottom: 30px;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 35px; 
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8); 
            border-radius: 14px;
            padding: 20px 30px;
            min-width: 180px; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(102, 126, 234, 0.15);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.03); 
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.2);
        }

        .stat-icon {
            font-size: 2.5rem; 
            margin-bottom: 12px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-value {
            font-weight: 700;
            font-size: 2rem; 
            color: var(--dark-blue);
            margin-bottom: 6px;
        }

        .stat-label {
            color: var(--text-medium);
            font-size: 1rem; 
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius);
            padding: 25px 30px; 
            margin-bottom: 35px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .progress-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: var(--secondary-gradient);
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; 
            position: relative;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
            cursor: default; 
        }

        .progress-step::before { 
            content: '';
            position: absolute;
            top: 29px; 
            right: -50%;
            width: 100%;
            height: 4px;
            background: #e0e7ff; 
            z-index: 1;
        }
        .progress-step:first-child::before { display: none; }


        .progress-step.active::before,
        .progress-step.completed::before {
            background: var(--primary-gradient);
        }

        .step-circle {
            width: 60px; 
            height: 60px;
            border-radius: 50%;
            background: #e0e7ff; 
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            position: relative;
            z-index: 2;
            transition: var(--transition);
            font-size: 1.5rem; 
            color: var(--text-medium); 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent; 
        }

        .progress-step.active .step-circle {
            background: var(--primary-gradient);
            color: white;
            transform: scale(1.15); 
            box-shadow: 0 12px 30px rgba(79, 172, 254, 0.45);
            border-color: white;
        }

        .progress-step.completed .step-circle {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 8px 20px rgba(86, 171, 47, 0.3);
        }

        .step-title {
            font-size: 1.05rem; 
            color: var(--text-medium);
            font-weight: 500;
            transition: var(--transition);
        }

        .progress-step.active .step-title {
            color: #4facfe;
            font-weight: 700; 
        }
        .progress-step.completed .step-title {
            color: #56ab2f;
            font-weight: 600;
        }


        .section {
            background: rgba(255, 255, 255, 0.99); 
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 45px; 
            margin-bottom: 35px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(200, 210, 220, 0.3);
            display: none;
            animation: fadeInScaleUp 0.6s ease-out; 
            position: relative;
            overflow: hidden;
        }
        
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }


        .section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px; 
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 0 var(--border-radius) var(--border-radius) 0; 
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 2.5rem; 
            margin-bottom: 35px;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 18px; 
            position: relative;
            padding-bottom: 18px;
            font-weight: 700; 
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 120px; 
            height: 4.5px; 
            background: var(--primary-gradient);
            border-radius: 3px;
        }

        .file-upload {
            border: 3px dashed #4facfe;
            border-radius: var(--border-radius);
            padding: 70px 35px; 
            text-align: center;
            transition: var(--transition);
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.03) 0%, rgba(0, 242, 254, 0.03) 100%); 
            position: relative;
            overflow: hidden;
            cursor: pointer; 
        }

        .file-upload:hover {
            border-color: #00c0f0; 
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.08) 0%, rgba(0, 242, 254, 0.08) 100%);
            transform: translateY(-6px) scale(1.01); 
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.1);
        }

        .file-upload.dragover {
            border-color: #56ab2f;
            background: linear-gradient(135deg, rgba(86, 171, 47, 0.12) 0%, rgba(168, 230, 207, 0.12) 100%);
            transform: scale(1.02); 
        }

        .upload-icon {
            font-size: 5.5rem; 
            margin-bottom: 30px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 18px 40px; 
            border-radius: 14px; 
            font-size: 1.15rem; 
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 14px; 
            text-decoration: none;
            min-width: 180px; 
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(79, 172, 254, 0.3);
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.02); 
            box-shadow: 0 12px 28px rgba(79, 172, 254, 0.45);
            filter: brightness(1.1); 
        }
        .btn:active:not(:disabled) {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.35);
        }


        .btn:disabled {
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: grayscale(50%);
        }
        
        .btn-secondary { background: var(--secondary-gradient); box-shadow: 0 6px 18px rgba(102, 126, 234, 0.3); }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 12px 28px rgba(102, 126, 234, 0.45); }
        .btn-success { background: var(--success-gradient); box-shadow: 0 6px 18px rgba(86, 171, 47, 0.3); }
        .btn-success:hover:not(:disabled) { box-shadow: 0 12px 28px rgba(86, 171, 47, 0.45); }
        .btn-danger { background: var(--danger-gradient); box-shadow: 0 6px 18px rgba(255, 107, 107, 0.3); }
        .btn-danger:hover:not(:disabled) { box-shadow: 0 12px 28px rgba(255, 107, 107, 0.45); }


        .form-group {
            margin-bottom: 35px; 
        }

        .form-label {
            display: block;
            margin-bottom: 14px; 
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 1.15rem; 
            display: flex;
            align-items: center;
            gap: 10px; 
        }

        .form-label i {
            color: #4facfe;
            font-size: 1.2em; 
        }

        .form-input, .form-select { 
            width: 100%;
            padding: 18px 22px; 
            border: 2px solid #dde2e8; 
            border-radius: 14px; 
            font-size: 1.1rem; 
            transition: var(--transition);
            background: rgba(250, 251, 252, 0.8); 
            font-family: inherit;
            color: var(--text-dark); 
        }
        .form-input::placeholder { color: #99a3b0; } 


        .form-input:focus, .form-select:focus {
            border-color: #4facfe;
            outline: none;
            box-shadow: 0 0 0 4.5px rgba(79, 172, 254, 0.25); 
            background: white; 
        }

        .analysis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 35px;
            margin: 35px 0;
        }
        
        .analysis-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius);
            padding: 35px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.07); 
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid #e8edf3; 
        }

        .analysis-card:hover {
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .analysis-card h3 {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 25px;
            color: var(--dark-blue);
            font-size: 1.6rem; 
            font-weight: 600;
        }

        .analysis-card h3 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.3em; 
        }

        .analysis-content {
            line-height: 1.8; 
            color: var(--text-medium);
            font-size: 1.05rem; 
        }
        .analysis-content ul { padding-right: 20px; margin-top: 10px; list-style-type: disc; } 
        .analysis-content li { margin-bottom: 8px; }


        .chart-container {
            height: 320px; 
            margin-top: 25px;
        }
        
        /* Chatbot Styles */
        .chatbot-toggler {
            position: fixed;
            bottom: 30px;
            left: 30px; 
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            transition: var(--transition);
            z-index: 999;
        }
        .chatbot-toggler:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(79,172,254,0.3);
        }
        .chatbot-container {
            position: fixed;
            bottom: 100px;
            left: 30px;
            width: 360px;
            max-height: 500px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.5) translateY(50px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            z-index: 998;
            pointer-events: none;
        }
        .chatbot-container.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .chatbot-header {
            background: var(--secondary-gradient);
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .chatbot-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .chat-message.user {
            background: #e9f5ff;
            color: var(--dark-blue);
            margin-right: auto; 
            border-bottom-right-radius: 0;
        }
        .chat-message.bot {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto; 
            border-bottom-left-radius: 0;
        }
        .chat-message.bot.typing span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.7);
            margin: 0 2px;
            animation: typingAnimation 1.2s infinite ease-in-out;
        }
        .chat-message.bot.typing span:nth-child(2) { animation-delay: 0.2s; }
        .chat-message.bot.typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .chatbot-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .chatbot-input input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-left: 10px;
            font-family: inherit;
            font-size: 1rem;
        }
        .chatbot-input button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        #cvPreliminarySummaryContainer {
             margin-top: 25px;
        }
        #cvPreliminarySummary {
            padding: 20px;
            background: rgba(230, 245, 255, 0.7); 
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: var(--border-radius);
            font-size: 1.05rem;
            color: var(--text-dark);
            line-height: 1.7;
        }
        #cvPreliminarySummary h4 {
            color: #4facfe;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #cvPreliminarySummary h4 i { font-size: 1.2em; }
        #cvPreliminarySummary p { margin-bottom: 5px; }

        .score-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin: 30px 0; }
        .score-card { background: rgba(255, 255, 255, 0.97); border-radius: var(--border-radius); padding: 30px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.07); transition: var(--transition); position: relative; overflow: hidden; border: 1px solid #e8edf3; }
        .score-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 5px; background: var(--primary-gradient); transition: var(--transition); }
        .score-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 15px 40px rgba(0,0,0,0.12); }
        .score-card:hover::before { filter: brightness(1.1); height: 6px; }
        .score-value { font-size: 3rem; font-weight: 800; margin-bottom: 8px; position: relative; display: inline-block; }
        .score-label { color: var(--text-medium); font-size: 1.15rem; font-weight: 500; }
        
        .question-card { background: rgba(255, 255, 255, 0.98); border-radius: var(--border-radius); padding: 35px; margin-bottom: 30px; border: 2px solid #e0e7ff; transition: var(--transition); box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .question-card.active { border-color: #4facfe; box-shadow: 0 12px 35px rgba(79, 172, 254, 0.25); transform: scale(1.01); }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 18px; }
        .question-number { font-weight: 700; color: var(--dark-blue); background: rgba(79, 172, 254, 0.1); padding: 10px 20px; border-radius: 30px; font-size: 1.15rem; }
        .question-timer { background: #4facfe; color: white; padding: 10px 22px; border-radius: 30px; font-size: 1.15rem; display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 4px 12px rgba(79,172,254,0.2); }
        .question-text { font-size: 1.35rem; margin-bottom: 30px; color: var(--text-dark); line-height: 1.75; background: rgba(249, 250, 252, 0.7); padding: 25px; border-radius: 14px; border-right: 5px solid #4facfe; box-shadow: 0 4px 10px rgba(0,0,0,0.04); }
        .answer-section { margin-bottom: 30px; }
        .answer-section h4 { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; color: var(--text-dark); font-size: 1.25rem; font-weight: 600; }
        .answer-textarea { width: 100%; min-height: 160px; padding: 20px; border: 2px solid #dde2e8; border-radius: 14px; resize: vertical; font-family: inherit; font-size: 1.1rem; transition: var(--transition); }
        .answer-textarea:focus { border-color: #4facfe; outline: none; box-shadow: 0 0 0 4.5px rgba(79, 172, 254, 0.25); background: white; }
        .voice-recording { background: linear-gradient(135deg, rgba(255, 107, 107, 0.03) 0%, rgba(255, 168, 168, 0.03) 100%); border: 2px solid #ff8a8a; border-radius: var(--border-radius); padding: 35px; text-align: center; margin: 30px 0; }
        .recording-btn { width: 95px; height: 95px; border-radius: 50%; border: none; background: var(--danger-gradient); color: white; font-size: 2.5rem; cursor: pointer; transition: var(--transition); margin: 0 auto 22px; display: block; box-shadow: 0 6px 18px rgba(255, 107, 107, 0.3); }
        .recording-btn:hover { transform: scale(1.12); box-shadow: 0 10px 30px rgba(255, 107, 107, 0.45); }
        .recording-btn.active { animation: recordingPulse 1.2s infinite; }
        @keyframes recordingPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { box-shadow: 0 0 0 22px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }
        .audio-visualizer { display: flex; justify-content: center; align-items: center; gap: 5px; height: 65px; margin: 28px 0; }
        .bar { width: 6px; background: #4facfe; border-radius: 3px; animation: audioWave 1.2s infinite ease-in-out; }
        .bar:nth-child(2) { animation-delay: 0.1s; } .bar:nth-child(3) { animation-delay: 0.2s; } .bar:nth-child(4) { animation-delay: 0.3s; } .bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes audioWave { 0%, 100% { height: 18px; opacity: 0.7; } 50% { height: 45px; opacity: 1; } }

        .final-report { background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%); border: 2px solid #7c8ff0; border-radius: var(--border-radius); padding: 45px; margin: 35px 0; }
        .report-header { text-align: center; margin-bottom: 45px; padding-bottom: 30px; border-bottom: 2px solid #7c8ff0; }
        .report-header h3 { font-size: 2.3rem; color: #667eea; margin-bottom: 18px; font-weight: 700; }
        .report-header p { font-size: 1.15rem; color: var(--text-medium); margin-bottom: 10px; }
        .report-header strong { color: var(--dark-blue); font-weight: 600; }
        .report-section { margin-bottom: 40px; padding-bottom: 35px; border-bottom: 1px dashed #d5d9e0; }
        .report-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
        .report-section-title { font-size: 1.6rem; font-weight: 700; color: #667eea; margin-bottom: 25px; display: flex; align-items: center; gap: 14px; padding-bottom: 14px; border-bottom: 2px solid rgba(102, 126, 234, 0.25); }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; margin: 28px 0; }
        .report-card { background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); padding: 30px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.06); transition: var(--transition); border: 1px solid #e8edf3; }
        .report-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        .report-card h5 { font-size: 1.25rem; color: var(--dark-blue); margin-bottom: 18px; font-weight: 600; }
        .report-card p { color: var(--text-medium); line-height: 1.75; font-size: 1.05rem;}
        .report-card ul { list-style-type: none; padding: 0; text-align: right; } 
        .report-card li { margin-bottom: 5px; }

        .strength-list, .improvement-list { list-style: none; padding: 0; margin-top: 18px; }
        .strength-list li, .improvement-list li { padding: 14px 22px; margin-bottom: 14px; border-radius: 12px; display: flex; align-items: center; gap: 14px; font-size: 1.1rem; transition: var(--transition); }
        .strength-list li:hover, .improvement-list li:hover { transform: translateX(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .strength-list li { background: rgba(86, 171, 47, 0.06); border-right: 5px solid #56ab2f; color: #2e7d32;}
        .improvement-list li { background: rgba(79, 172, 254, 0.06); border-right: 5px solid #4facfe; color: #1976d2;}
        .strength-list li i { color: #56ab2f; }
        .improvement-list li i { color: #4facfe; }
        .decision-card { background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); padding: 35px; text-align: center; margin: 35px 0; box-shadow: 0 8px 25px rgba(0,0,0,0.07); border-top: 5px solid #667eea; }
        .decision-icon { font-size: 4.5rem; margin-bottom: 25px; }
        .decision-icon i, .decision-icon .fas { background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .decision-text { font-size: 1.9rem; font-weight: 700; margin-bottom: 18px; }
        .decision-reason { font-size: 1.25rem; color: var(--text-medium); max-width: 850px; margin: 0 auto; line-height: 1.75; }
        .report-footer { margin-top: 45px; padding-top: 30px; border-top: 2px solid #667eea; text-align: center; color: var(--text-medium); font-size: 1.05rem; }
        .loading-spinner { display: inline-block; width: 30px; height: 30px; border: 4.5px solid rgba(79, 172, 254, 0.25); border-radius: 50%; border-top-color: #4facfe; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .notification { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); padding: 20px 30px; border-radius: 14px; color: white; font-weight: 600; z-index: 10000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, top 0.3s ease; box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2); display: flex; align-items: center; gap: 14px; font-size: 1.15rem; min-width: 300px; justify-content: center; }
        .notification.show { opacity: 1; visibility: visible; top: 40px; }
        .notification.success { background: var(--success-gradient); }
        .notification.error { background: var(--danger-gradient); }
        .notification.info { background: var(--info-gradient); } 
        .notification i { font-size: 1.6rem; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .floating-particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .particle { position: absolute; width: 6px; height: 6px; background: rgba(79, 172, 254, 0.25); border-radius: 50%; animation: float 7s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0px) translateX(0px) rotate(0deg); opacity: 0.7; } 50% { transform: translateY(-30px) translateX(10px) rotate(180deg); opacity: 0.4; } }
        .action-buttons { display: flex; justify-content: space-between; gap: 25px; margin-top: 45px; flex-wrap: wrap; }
        .action-buttons > div { display: flex; gap: 25px; flex-wrap: wrap; }
        
        .form-info-icon {
            font-size: 18rem; 
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px; 
            display: block; 
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .welcome-text-container {
            padding: 20px;
            text-align: right;
        }
        .welcome-text-container h3 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .welcome-text-container p {
            color: var(--text-medium);
            line-height: 1.8;
            font-size: 1.15rem;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .container { padding: 20px; }
            .section { padding: 35px 25px; }
            .company-title { font-size: 2.5rem; }
            .progress-bar { flex-direction: row; overflow-x: auto; padding-bottom: 15px; } 
            .progress-step { min-width: 120px; } 
            .progress-step::before { display: block; } 
            .stats-container { gap: 20px; }
            .stat-card { min-width: 150px; padding: 18px 20px; }
            .action-buttons { flex-direction: column; align-items: center; }
            .action-buttons > div { width: 100%; justify-content: center; }
            .analysis-container { grid-template-columns: 1fr; }
            .form-info-icon { font-size: 12rem; }
            .header, .progress-container, .section { margin-bottom: 25px; padding: 25px; }
        }

        @media (max-width: 768px) {
            body { font-size: 15px; }
            .section-title { font-size: 2rem; }
            .file-upload { padding: 50px 25px; }
            .report-grid { grid-template-columns: 1fr; }
            .question-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .btn { padding: 16px 30px; font-size: 1.1rem; }
            .form-input, .form-select { padding: 16px 20px; font-size: 1rem; }
            .logo { width: 80px; height: 80px; font-size: 32px; }
            .company-title { font-size: 2.2rem; }
            .subtitle { font-size: 1.2rem; }
            .stat-card { min-width: 130px; }
            .step-circle { width: 50px; height: 50px; font-size: 1.3rem; }
            .step-title { font-size: 0.95rem; }
            .form-info-icon { display: none; } 
            .welcome-text-container { padding-top: 0; }
            #step1 > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; } 
            .chatbot-container { width: 90%; left: 5%; bottom: 80px; }
            .chatbot-toggler { bottom: 20px; left: 20px; }
        }

    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    <div id="notification" class="notification"></div>

    <div class="chatbot-toggler" id="chatbotToggler">
        <i class="fas fa-comments"></i>
    </div>
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <span>مساعد التوظيف الذكي</span>
            <button class="close-btn" id="closeChatbotBtn"><i class="fas fa-times"></i></button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chat-message bot">مرحباً بك! كيف يمكنني مساعدتك اليوم في رحلة التقديم؟</div>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="اكتب سؤالك هنا..." aria-label="سؤال للروبوت">
            <button id="sendChatbotMessage"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>


    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-microscope"></i> 
            </div>
            <h1 class="company-title">ميس للمنتجات الطبية</h1>
            <p class="subtitle">بوابتك نحو مستقبل مهني واعد مع نظام التوظيف الذكي المتقدم</p>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users-cog"></i></div>
                    <div class="stat-value">+500</div>
                    <div class="stat-label">موظف متخصص</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <div class="stat-value">15</div>
                    <div class="stat-label">فرع بالمملكة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-award"></i></div>
                    <div class="stat-value">20+</div>
                    <div class="stat-label">عاماً من الريادة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-handshake"></i></div>
                    <div class="stat-value">98%</div>
                    <div class="stat-label">رضا الشركاء</div>
                </div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle"><i class="fas fa-user-edit"></i></div>
                    <div class="step-title">البيانات الأساسية</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle"><i class="fas fa-file-arrow-up"></i></div>
                    <div class="step-title">رفع السيرة</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle"><i class="fas fa-cogs"></i></div>
                    <div class="step-title">التحليل الأولي</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle"><i class="fas fa-comments-dollar"></i></div>
                    <div class="step-title">المقابلة الذكية</div>
                </div>
                <div class="progress-step" data-step="5"> 
                    <div class="step-circle"><i class="fas fa-tasks"></i></div>
                    <div class="step-title">التقييم الشامل</div>
                </div>
                <!-- Removed Fun Assessment Step from progress bar -->
                <div class="progress-step" data-step="6">
                    <div class="step-circle"><i class="fas fa-file-signature"></i></div>
                    <div class="step-title">التقرير النهائي</div>
                </div>
            </div>
        </div>

        <div id="step1" class="section active">
            <h2 class="section-title">
                <i class="fas fa-user-plus"></i>
                ابدأ رحلتك المهنية معنا
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 50px; align-items: center;">
                <div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user-tie"></i> الاسم الكامل</label>
                        <input type="text" id="fullName" class="form-input" placeholder="أدخل اسمك كما في الهوية">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-at"></i> البريد الإلكتروني</label>
                        <input type="email" id="email" class="form-input" placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-mobile-alt"></i> رقم الهاتف (مع رمز الدولة)</label>
                        <input type="tel" id="phone" class="form-input" placeholder="+966xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user-clock"></i> سنوات الخبرة</label>
                        <select id="experience" class="form-input form-select">
                            <option value="">اختر عدد سنوات الخبرة</option>
                            <option value="0-1">أقل من سنة (حديث تخرج)</option>
                            <option value="1-3">1-3 سنوات</option>
                            <option value="3-5">3-5 سنوات</option>
                            <option value="5-10">5-10 سنوات</option>
                            <option value="10+">أكثر من 10 سنوات</option>
                        </select>
                    </div>
                    <button class="btn" onclick="nextStep()">
                        <i class="fas fa-arrow-left"></i>
                        التالي: رفع السيرة الذاتية
                    </button>
                </div>
                <div class="welcome-text-container" style="text-align: center;">
                     <i class="fas fa-file-contract form-info-icon"></i>
                    <h3>مرحباً بك في بوابة التوظيف الذكية لشركة ميس!</h3>
                    <p>
                        نحن سعداء بانضمامك إلينا. نظامنا المتطور يستخدم أحدث تقنيات الذكاء الاصطناعي لتحليل سيرتك الذاتية وتقييم مهاراتك بدقة وموضوعية، لضمان اختيار أفضل الكفاءات. نتمنى لك كل التوفيق!
                    </p>
                </div>
            </div>
        </div>

        <div id="step2" class="section">
            <h2 class="section-title">
                <i class="fas fa-cloud-upload-alt"></i>
                رفع السيرة الذاتية
            </h2>
            <div class="file-upload" id="fileUploadArea">
                <i class="fas fa-file-import upload-icon"></i>
                <h3 style="font-size: 1.8rem; margin-bottom: 18px; color: var(--dark-blue);">اسحب ملف السيرة الذاتية هنا أو انقر للاختيار</h3>
                <p style="color: var(--text-medium); margin-bottom: 28px; font-size: 1.15rem;">النظام يدعم ملفات PDF, DOCX, TXT (بحد أقصى 10 ميجابايت)</p>
                <div style="
                    margin-bottom: 25px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #fff;
                    background: var(--info-gradient); 
                    border-radius: 16px;
                    box-shadow: 0 8px 28px rgba(54, 209, 220, 0.2);
                    padding: 20px 0;
                    text-align: center;
                    text-shadow: 0 1px 4px rgba(0,0,0,0.2);
                    letter-spacing: 0.5px;
                ">
                    <i class="fas fa-lightbulb" style="margin-left: 10px;"></i>
                    <span>لأفضل تحليل، يفضل رفع ملف PDF واضح أو TXT باللغة العربية.</span>
                </div>
                <input type="file" id="cvFile" accept=".pdf,.docx,.txt" style="display: none;">
                <div id="uploadProgress" class="hidden" style="margin-top: 35px;">
                    <div style="background: #e0e7ff; border-radius: 12px; height: 14px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                        <div id="progressBar" style="background: var(--primary-gradient); height: 100%; width: 0%; transition: width 0.4s ease-in-out;"></div>
                    </div>
                    <p style="margin-top: 18px; color: var(--text-medium); font-size: 1.1rem;">جاري رفع وتحضير الملف...</p>
                </div>
            </div>
            <div id="fileInfo" class="hidden" style="margin-top: 35px; padding: 28px; background: rgba(86, 171, 47, 0.05); border: 2px solid #56ab2f; border-radius: var(--border-radius); box-shadow: 0 4px 15px rgba(86,171,47,0.1);">
                <h4 style="color: #56ab2f; margin-bottom: 18px; display: flex; align-items: center; gap: 12px; font-size: 1.3rem;">
                    <i class="fas fa-check-circle"></i>
                    تم رفع الملف بنجاح!
                </h4>
                <p id="fileName" style="margin-bottom: 10px; font-size: 1.15rem; color: var(--text-dark);"></p>
                <p id="fileSize" style="font-size: 1.15rem; color: var(--text-dark);"></p>
            </div>
            <div id="cvPreliminarySummaryContainer" class="hidden">
                 <div id="cvPreliminarySummary">
                    <h4><i class="fas fa-wand-magic-sparkles"></i> ملخص أولي من سيرتك الذاتية:</h4>
                    <p id="cvDetectedLanguage"><strong>اللغة المكتشفة:</strong> <span></span></p>
                    <p id="cvSummaryText"><strong>الملخص:</strong> <span></span></p>
                    <small style="display:block; margin-top:10px; color:var(--text-light)">هذا ملخص سريع، التحليل التفصيلي سيتم في الخطوة التالية.</small>
                 </div>
            </div>
            <div class="action-buttons">
                <div>
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> السابق</button>
                    <button class="btn" id="analyzeBtn" onclick="analyzeCv()" disabled>
                        <span id="analyzeBtnText"><i class="fas fa-brain"></i> تحليل السيرة الذاتية</span>
                        <div id="analyzeBtnSpinner" class="loading-spinner hidden" style="width:20px; height:20px; border-width:3px; margin-right: 8px;"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="step3" class="section">
            <h2 class="section-title">
                <i class="fas fa-search-plus"></i>
                التحليل الذكي والوظائف المقترحة
            </h2>
            <div id="analysisLoader" class="text-center" style="padding: 70px;">
                <div class="loading-spinner" style="width: 65px; height: 65px; margin: 0 auto 30px; border-width: 5px;"></div>
                <h3 style="font-size: 1.9rem; margin-bottom: 18px; color: var(--dark-blue);">جاري تحليل سيرتك الذاتية بعمق...</h3>
                <p style="font-size: 1.2rem; color: var(--text-medium);">يستخدم الذكاء الاصطناعي نماذج متقدمة لفهم مهاراتك وخبراتك بدقة واقتراح الوظائف الأنسب لك.</p>
            </div>
            <div id="analysisResults" class="hidden">
                <div class="score-card-grid">
                    <div class="score-card">
                        <div class="score-value" id="overallScore" style="color: #4facfe;">0%</div>
                        <div class="score-label">التقييم العام الأولي</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="skillsScore" style="color: #56ab2f;">0%</div>
                        <div class="score-label">تطابق المهارات</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="experienceScore" style="color: #ff8c42;">0%</div> 
                        <div class="score-label">مستوى الخبرة</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="educationScore" style="color: #667eea;">0%</div>
                        <div class="score-label">المؤهل التعليمي</div>
                    </div>
                </div>
                
                <div class="analysis-container">
                    <div class="analysis-card">
                        <h3><i class="fas fa-file-alt"></i> ملخص تحليل السيرة الذاتية</h3>
                        <div id="analysisText" class="analysis-content"></div>
                    </div>
                    
                    <div class="analysis-card">
                        <h3><i class="fas fa-chart-pie"></i> توزيع المهارات الأساسية</h3>
                        <div class="chart-container">
                            <canvas id="skillsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-card" style="margin-top: 35px;">
                    <h3><i class="fas fa-user-check"></i> الوظائف المقترحة بناءً على سيرتك</h3>
                    <div id="recommendedPosition" class="analysis-content"></div>
                     <div id="interviewSchedulingInfo" style="margin-top: 20px; padding: 15px; background: rgba(230, 245, 255, 0.8); border-radius: 10px; text-align: center;">
                        <p style="font-size: 1.1rem; color: var(--dark-blue);">
                            <i class="fas fa-calendar-alt" style="color: #4facfe; margin-left: 8px;"></i>
                            سيتم التواصل معك لاحقاً لتحديد موعد المقابلة في حال تطابق مؤهلاتك مع متطلبات الوظيفة بشكل كبير. يمكنك أيضاً الاستفسار عبر مساعدنا الذكي.
                        </p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <div>
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> السابق</button>
                        <button class="btn" id="interviewBtn" onclick="startInterview()" disabled>
                            <i class="fas fa-comments"></i> بدء المقابلة الذكية
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="step4" class="section">
            <h2 class="section-title">
                <i class="fas fa-headset"></i>
                المقابلة التفاعلية الذكية
            </h2>
            <div id="questionContainer">
                <!-- Question card will be populated by JS -->
            </div>
            
            <div class="action-buttons">
                <div>
                    <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> العودة لتحليل السيرة</button>
                </div>
                <div>
                    <button class="btn btn-secondary" id="prevQuestionBtn" onclick="prevQuestion()" disabled>
                        <i class="fas fa-chevron-right"></i> السؤال السابق
                    </button>
                    <button class="btn" id="nextQuestionBtn" onclick="nextQuestion()">
                        <i class="fas fa-chevron-left"></i> السؤال التالي
                    </button>
                    <button class="btn btn-success hidden" id="finishInterviewBtn" onclick="finishInterview()">
                        <i class="fas fa-check-double"></i> إنهاء وتقديم المقابلة
                    </button>
                </div>
            </div>
        </div>

        <div id="step5" class="section">
            <h2 class="section-title">
                <i class="fas fa-clipboard-check"></i>
                تقييم الأداء الشامل
            </h2>
            <div id="evaluationLoader" class="text-center" style="padding: 70px;">
                <div class="loading-spinner" style="width: 65px; height: 65px; margin: 0 auto 30px; border-width:5px;"></div>
                <h3 style="font-size: 1.9rem; margin-bottom: 18px; color: var(--dark-blue);">جاري تقييم إجاباتك وتحليل أدائك...</h3>
                <p style="font-size: 1.2rem; color: var(--text-medium);">يقوم الذكاء الاصطناعي بتحليل إجاباتك الكتابية والصوتية لتكوين صورة شاملة عن مدى ملاءمتك.</p>
            </div>
            <div id="evaluationResults" class="hidden">
                <div class="score-card-grid">
                    <div class="score-card">
                        <div class="score-value" id="finalScore" style="color: #4facfe;">0%</div>
                        <div class="score-label">النتيجة النهائية للتقييم</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="communicationScore" style="color: #56ab2f;">0%</div>
                        <div class="score-label">مهارات التواصل واللغة</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="technicalScore" style="color: #ff8c42;">0%</div>
                        <div class="score-label">المهارات الفنية والسلوكية</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value" id="personalityScore" style="color: #667eea;">0%</div>
                        <div class="score-label">ملائمة السمات الشخصية</div>
                    </div>
                </div>
                
                <div class="analysis-container">
                    <div class="analysis-card">
                        <h3><i class="fas fa-user-graduate"></i> تحليل تفصيلي لأداء المقابلة</h3>
                        <div id="detailedAnalysis" class="analysis-content"></div>
                    </div>
                    
                    <div class="analysis-card">
                        <h3><i class="fas fa-signal"></i> توزيع التقييم العام</h3>
                        <div class="chart-container">
                            <canvas id="evaluationChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="decision-card" style="border-top-color: var(--success-gradient);">
                    <div class="decision-icon">
                        <i class="fas fa-award" style="background: var(--success-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"></i>
                    </div>
                    <div class="decision-text" id="evaluationDecision"></div>
                    <div class="decision-reason" id="decisionReason"></div>
                </div>
                
                <div class="action-buttons">
                    <div>
                        <button class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-right"></i> مراجعة المقابلة</button>
                        <!-- Changed button to directly generate final report, removing fun assessment -->
                        <button class="btn" id="proceedToFinalReportBtn" onclick="generateFinalReport()" disabled> 
                            <i class="fas fa-file-alt"></i> عرض التقرير النهائي
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 5.5 (Fun Assessment) and its button removed -->

        <div id="step6" class="section">
            <h2 class="section-title">
                <i class="fas fa-file-invoice"></i>
                التقرير النهائي الشامل
            </h2>
            <div id="finalReportLoader" class="text-center" style="padding: 70px;">
                <div class="loading-spinner" style="width: 65px; height: 65px; margin: 0 auto 30px; border-width:5px;"></div>
                <h3 style="font-size: 1.9rem; margin-bottom: 18px; color: var(--dark-blue);">جاري إعداد تقريرك النهائي...</h3>
                <p style="font-size: 1.2rem; color: var(--text-medium);">لحظات قليلة ويصبح تقييمك الشامل جاهزًا للعرض.</p>
            </div>
            <div class="final-report hidden" id="finalReportContent">
                <!-- Report content will be populated by JS -->
            </div>

            <div class="action-buttons hidden" id="finalReportButtons" style="justify-content: center; margin-top: 40px;">
                <div>
                    <button class="btn" onclick="downloadPDF()"><i class="fas fa-file-download"></i> تحميل PDF</button>
                    <button class="btn btn-secondary" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
                    <button class="btn btn-success" onclick="sendToHR()"><i class="fas fa-paper-plane"></i> إرسال للموارد البشرية</button>
                </div>
            </div>

            <div id="thankYouMessage" class="hidden" style="margin-top: 50px; text-align: center; padding: 35px; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                <h3 style="color: #667eea; margin-bottom: 22px; font-size: 1.9rem;">شكراً جزيلاً لك على إكمال عملية التقييم!</h3>
                <p style="color: var(--text-medium); line-height: 1.8; font-size: 1.2rem; margin-bottom: 28px;">
                    لقد تلقينا بياناتك ونتائج تقييمك بنجاح. سيقوم فريق الموارد البشرية بمراجعتها والتواصل معك خلال 3-5 أيام عمل لإعلامك بالخطوات التالية في رحلتك المهنية مع ميس للمنتجات الطبية.
                </p>
                <button class="btn" onclick="startNewApplication()">
                    <i class="fas fa-redo-alt"></i>
                    بدء تقديم جديد
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentStep = 1;
        let cvFileDetails = null;
        let cvContent = '';
        let analysisData = { 
            scores: {}, 
            evaluationScores: {},
            cvAnalysisDetails: {} 
        };
        let interviewData = {
            questions: [],
            answers: [], 
            currentQuestionIndex: 0,
            totalQuestions: 5, 
            questionTimeLimit: 300 
        };
        let mediaRecorder;
        let recordingChunks = [];
        let isRecording = false;
        let questionIntervalTimer; 
        // phaserGameScore removed as Fun Assessment is removed

        const GEMINI_API_KEY = 'AIzaSyCV3Kb2rHMQoyAiYkrAFA82UlcGbYAAC0M'; //  REPLACE WITH YOUR ACTUAL KEY
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;


        const jobPositions = [ /* ... existing jobPositions from previous code ... */ ]; 

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            createFloatingParticles();
            initChatbot();
        });

        function initializeApp() {
            setupFileUpload();
            setupDragAndDrop();
            updateProgressSteps();
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('interviewBtn').disabled = true;
            // Button to proceed from evaluation to final report
            const proceedToReportBtn = document.getElementById('proceedToFinalReportBtn'); 
            if (proceedToReportBtn) {
                proceedToReportBtn.disabled = true; 
                // Its onclick is already set to generateFinalReport() which handles nextStep() internally
            }
        }

        function createFloatingParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 7 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                particle.style.transform = `scale(${Math.random() * 0.5 + 0.5})`; 
                particlesContainer.appendChild(particle);
            }
        }
        
        function setupFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('cvFile');
            if (fileUploadArea) fileUploadArea.addEventListener('click', () => fileInput.click());
            if (fileInput) fileInput.addEventListener('change', handleFileSelect);
        }

        function setupDragAndDrop() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            if (!fileUploadArea) return;
            fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
            fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleFile(files[0]);
            });
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) handleFile(file);
        }

        async function handleFile(file) {
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('يرجى اختيار ملف PDF, DOCX, أو TXT فقط.', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showNotification('حجم الملف يجب أن يكون أقل من 10 ميجابايت.', 'error');
                return;
            }

            cvFileDetails = file; 
            showUploadProgress(true);
            
            try {
                if (file.type === 'application/pdf') cvContent = await extractTextFromPDF(file);
                else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') cvContent = await extractTextFromDocx(file);
                else if (file.type === 'text/plain') cvContent = await file.text();
                
                showUploadProgress(false); 
                document.getElementById('uploadProgress').querySelector('p').textContent = 'تم الرفع، جاري استخلاص ملخص أولي...';

                const preliminaryData = await getCVSummaryAndLanguage(cvContent);
                displayPreliminarySummary(preliminaryData.language, preliminaryData.summary);
                
                showFileInfo(file); 
                document.getElementById('analyzeBtn').disabled = false;
                showNotification('تم رفع الملف واستخلاص ملخص أولي بنجاح!', 'success');

            } catch (error) {
                console.error('Error processing file:', error);
                showNotification('حدث خطأ في معالجة الملف. حاول مرة أخرى أو بملف مختلف.', 'error');
                showUploadProgress(false);
                document.getElementById('uploadProgress').classList.add('hidden');
            }
        }
        
        async function getCVSummaryAndLanguage(cvText) {
            if (!cvText || cvText.trim() === "") {
                return { language: "غير محدد (محتوى فارغ)", summary: "لم يتم العثور على محتوى في السيرة الذاتية." };
            }
            const prompt = `حلل نص السيرة الذاتية التالي. 
أولاً، حدد اللغة الأساسية للنص (مثال: العربية، الإنجليزية).
ثانياً، قدم ملخصًا موجزًا جدًا (2-3 أسطر كحد أقصى) لأبرز المؤهلات أو الخبرات المذكورة. **يجب أن يكون الملخص باللغة العربية دائماً، حتى لو كان النص الأصلي بلغة أخرى.**

نص السيرة الذاتية:
---
${cvText.substring(0, 3000)}
---

الرد المطلوب يجب أن يكون بتنسيق JSON صارم كالتالي:
{
  "language": "اللغة المكتشفة هنا",
  "summary": "الملخص باللغة العربية هنا"
}`;
            try {
                const responseText = await callGeminiAPI(prompt);
                const cleanedResponseText = cleanGeminiResponse(responseText);
                const parsedResponse = JSON.parse(cleanedResponseText);
                return { 
                    language: parsedResponse.language || "تعذر التحديد", 
                    summary: parsedResponse.summary || "تعذر إنشاء ملخص." 
                };
            } catch (e) {
                console.error("Error parsing summary from Gemini or API call failed:", e);
                const rawResponseForDebug = await callGeminiAPI(prompt, true); 
                console.error("Problematic Gemini Response (Summary):", rawResponseForDebug);
                return { language: "خطأ في التحليل", summary: "لم نتمكن من إنشاء ملخص أولي لهذه السيرة الذاتية." };
            }
        }

        function displayPreliminarySummary(language, summary) {
            document.getElementById('cvDetectedLanguage').querySelector('span').textContent = language;
            document.getElementById('cvSummaryText').querySelector('span').textContent = summary;
            document.getElementById('cvPreliminarySummaryContainer').classList.remove('hidden');
        }

        function showUploadProgress(show) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            if (show) {
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                let currentProgress = 0;
                const interval = setInterval(() => {
                    currentProgress += Math.random() * 15;
                    if (currentProgress >= 90 && !cvContent) currentProgress = 90; 
                    else if (currentProgress >= 100) {
                         currentProgress = 100;
                         clearInterval(interval);
                    }
                    progressBar.style.width = currentProgress + '%';
                }, 200);
            } else {
                 progressBar.style.width = '100%';
            }
        }

        function showFileInfo(file) {
            document.getElementById('fileName').textContent = `اسم الملف: ${file.name}`;
            document.getElementById('fileSize').textContent = `حجم الملف: ${(file.size / (1024 * 1024)).toFixed(2)} ميجابايت`;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden'); 
        }

        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const typedArray = new Uint8Array(this.result);
                        const loadingTask = pdfjsLib.getDocument({data: typedArray});
                        const pdf = await loadingTask.promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent({ normalizeWhitespace: true, disableCombineTextItems: false });
                            let lineText = '';
                            textContent.items.forEach(item => {
                                lineText += item.str + (item.hasEOL ? '\n' : ' ');
                            });
                            text += lineText;
                        }
                        resolve(text.replace(/\s+/g, ' ').trim());
                    } catch (error) { reject("فشل في قراءة محتوى PDF: " + error.message); }
                };
                fileReader.onerror = (error) => reject("خطأ في قارئ الملفات: " + error);
                fileReader.readAsArrayBuffer(file);
            });
        }

        async function extractTextFromDocx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(result => resolve(result.value.replace(/\s+/g, ' ').trim())) 
                        .catch(err => reject("فشل في قراءة محتوى DOCX: " + err.message));
                };
                reader.onerror = (error) => reject("خطأ في قارئ الملفات: " + error);
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function analyzeCv() {
            if (!cvContent) {
                showNotification('لا يوجد محتوى سيرة ذاتية لتحليله.', 'error');
                return;
            }
            const analyzeBtnText = document.getElementById('analyzeBtnText');
            const analyzeBtnSpinner = document.getElementById('analyzeBtnSpinner');
            analyzeBtnText.classList.add('hidden');
            analyzeBtnSpinner.classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            nextStep(); 
            
            try {
                const prompt = `
أنت خبير توظيف متقدم متخصص في تحليل السير الذاتية باللغة العربية، مع التركيز على قطاع المنتجات الطبية في المملكة العربية السعودية. قم بتحليل نص السيرة الذاتية التالي بعناية فائقة، مع الأخذ في الاعتبار أن النص قد يكون مستخرجًا من ملف PDF وقد يحتوي على بعض الأخطاء التنسيقية.

نص السيرة الذاتية:
---
${cvContent.substring(0, 18000)} 
---

المطلوب تقديم تحليل شامل باللغة العربية الفصحى وبتنسيق JSON صارم، يتضمن النقاط التالية:

1.  **comprehensiveSummary (ملخص شامل):** فقرة موجزة (4-5 أسطر) تلخص أبرز مؤهلات المرشح، خبراته الرئيسية، ومهاراته الأساسية، مع إشارة إلى مدى ملاءمته المحتملة للعمل في قطاع المنتجات الطبية السعودي.
2.  **keySkills (المهارات الأساسية):** قائمة بأهم 7-10 مهارات يمتلكها المرشح، مصنفة إذا أمكن إلى:
    *   **technicalSkills (مهارات فنية/تقنية):** متعلقة مباشرة بالوظائف الطبية أو التقنية.
    *   **softSkills (مهارات شخصية/سلوكية):** مثل التواصل، القيادة، حل المشكلات.
    *   **languageSkills (مهارات لغوية):** مع تحديد مستوى الإتقان إن أمكن (مثال: العربية - لغة أم، الإنجليزية - متقدم).
3.  **workExperience (الخبرة العملية):** مصفوفة من الكائنات، كل كائن يمثل خبرة عمل ويتضمن:
    *   **jobTitle (المسمى الوظيفي):** المسمى الدقيق.
    *   **company (الشركة):** اسم الشركة وموقعها (إذا ذكر).
    *   **duration (المدة):** المدة الزمنية للعمل (مثال: "3 سنوات"، "من 2018 إلى 2021").
    *   **responsibilities (أهم المسؤوليات والإنجازات):** قائمة نقطية بأهم 2-3 مسؤوليات أو إنجازات بارزة في هذا الدور، خاصة تلك المتعلقة بالقطاع الطبي أو المبيعات أو الجودة.
4.  **education (التعليم):** مصفوفة من الكائنات، كل كائن يمثل مؤهلًا تعليميًا ويتضمن:
    *   **degree (الشهادة):** اسم الشهادة (مثال: بكالوريوس، ماجستير).
    *   **major (التخصص):** التخصص الدقيق.
    *   **institution (المؤسسة التعليمية):** اسم الجامعة أو المعهد.
    *   **graduationYear (سنة التخرج):** إن وجدت.
5.  **certifications (الشهادات المهنية):** قائمة بالشهادات المهنية المذكورة (مثال: PMP, SFDA certifications, ISO lead auditor)، مع تقييم موجز لأهمية كل شهادة في سياق سوق العمل الطبي السعودي.
6.  **strengths (نقاط القوة):** من 3 إلى 5 نقاط قوة رئيسية للمرشح، مدعومة بأمثلة أو استنتاجات من السيرة الذاتية، مع التركيز على ما يفيد في القطاع الطبي السعودي.
7.  **areasForImprovement (مجالات التطوير المقترحة):** من 2 إلى 3 مجالات تطوير يمكن أن تعزز فرص المرشح في سوق العمل الطبي السعودي (مثال: دورات تدريبية متخصصة، شهادات معتمدة محلياً، تطوير مهارات رقمية معينة).
8.  **saudiMarketRelevance (مدى الملاءمة لسوق العمل السعودي):** تقييم عام لمدى ملاءمة المرشح لفرص العمل في قطاع المنتجات الطبية بالمملكة العربية السعودية، مع الأخذ في الاعتبار الخبرات والمهارات والشهادات.
9.  **recommendedJob (الوظيفة المقترحة):** كائن يتضمن:
    *   **title (المسمى الوظيفي المقترح):** مسمى وظيفي دقيق ومناسب لمؤهلات المرشح وخبراته، مع تحديد المستوى (مثال: "مندوب مبيعات طبية أول"، "أخصائي ضمان جودة"، "مدير تسويق منتجات طبية"). يجب أن يكون الاقتراح متوافقًا مع الفرص المحتملة في شركة "ميس للمنتجات الطبية" والسوق السعودي.
    *   **reasoning (مبررات الاقتراح):** شرح مفصل (2-3 أسطر) لسبب اقتراح هذه الوظيفة تحديدًا، بناءً على التحليل الشامل للسيرة.
10. **scores (تقييمات رقمية من 0 إلى 100):**
    *   **overallSuitability (الملاءمة العامة الأولية):**
    *   **skillsMatch (تطابق المهارات مع القطاع الطبي):**
    *   **experienceRelevance (أهمية الخبرة للقطاع الطبي السعودي):**
    *   **educationAlignment (توافق المؤهل التعليمي):**

تأكد من أن جميع النصوص باللغة العربية الفصحى الواضحة. إذا كانت بعض المعلومات غير متوفرة بشكل واضح في السيرة، اذكر ذلك ("لم يذكر بوضوح") أو قدرها بشكل منطقي مع الإشارة إلى أنه تقدير.
`;

                const responseText = await callGeminiAPI(prompt);
                const cleanedResponseText = cleanGeminiResponse(responseText); 
                const parsedAnalysis = JSON.parse(cleanedResponseText); 
                
                analysisData.cvAnalysisDetails = parsedAnalysis; 
                analysisData.fullAnalysis = parsedAnalysis.comprehensiveSummary || "لم يتمكن التحليل من استخلاص ملخص شامل.";
                analysisData.scores.overall = parsedAnalysis.scores?.overallSuitability || Math.floor(Math.random() * 30 + 60);
                analysisData.scores.skills = parsedAnalysis.scores?.skillsMatch || Math.floor(Math.random() * 30 + 60);
                analysisData.scores.experience = parsedAnalysis.scores?.experienceRelevance || Math.floor(Math.random() * 30 + 55);
                analysisData.scores.education = parsedAnalysis.scores?.educationAlignment || Math.floor(Math.random() * 30 + 65);
                
                let allSkills = [];
                if (parsedAnalysis.keySkills?.technicalSkills) allSkills.push(...parsedAnalysis.keySkills.technicalSkills);
                if (parsedAnalysis.keySkills?.softSkills) allSkills.push(...parsedAnalysis.keySkills.softSkills);
                analysisData.keySkillsForChart = allSkills.slice(0,5); 

                analysisData.recommendedJob = parsedAnalysis.recommendedJob || { title: "غير محدد", reasoning: "يرجى مراجعة السيرة يدوياً."};

                await displayAnalysisResults();
                
            } catch (error) {
                console.error('Error analyzing CV with Gemini:', error);
                if (error instanceof SyntaxError) {
                    const rawResponseForDebug = await callGeminiAPI(prompt, true);
                    console.error("Problematic Gemini Response (CV Analysis):", rawResponseForDebug);
                }
                showNotification(`خطأ في تحليل السيرة: ${error.message}. سيتم استخدام بيانات افتراضية.`, 'error');
                analysisData.fullAnalysis = "فشل تحليل السيرة الذاتية. تم استخدام بيانات افتراضية.";
                analysisData.scores = { overall: 65, skills: 70, experience: 60, education: 70 };
                analysisData.keySkillsForChart = ["مهارة افتراضية 1", "مهارة افتراضية 2"];
                analysisData.recommendedJob = { title: "وظيفة مقترحة (افتراضي)", reasoning: "بسبب خطأ في التحليل."};
                await displayAnalysisResults(); 
            } finally {
                analyzeBtnText.classList.remove('hidden');
                analyzeBtnSpinner.classList.add('hidden');
            }
        }
        
        async function displayAnalysisResults() {
            document.getElementById('analysisLoader').classList.add('hidden');
            document.getElementById('analysisResults').classList.remove('hidden');
            
            animateScore('overallScore', analysisData.scores.overall);
            animateScore('skillsScore', analysisData.scores.skills);
            animateScore('experienceScore', analysisData.scores.experience);
            animateScore('educationScore', analysisData.scores.education);
            
            let analysisHtml = `<h4>الملخص الشامل:</h4><p>${analysisData.cvAnalysisDetails.comprehensiveSummary || analysisData.fullAnalysis}</p>`;
            
            if (analysisData.cvAnalysisDetails.keySkills) {
                analysisHtml += `<h4>المهارات الأساسية:</h4><ul>`;
                if (analysisData.cvAnalysisDetails.keySkills.technicalSkills?.length) {
                    analysisHtml += `<li><strong>فنية/تقنية:</strong> ${analysisData.cvAnalysisDetails.keySkills.technicalSkills.join(', ')}</li>`;
                }
                if (analysisData.cvAnalysisDetails.keySkills.softSkills?.length) {
                    analysisHtml += `<li><strong>شخصية/سلوكية:</strong> ${analysisData.cvAnalysisDetails.keySkills.softSkills.join(', ')}</li>`;
                }
                if (analysisData.cvAnalysisDetails.keySkills.languageSkills?.length) {
                    analysisHtml += `<li><strong>لغوية:</strong> ${analysisData.cvAnalysisDetails.keySkills.languageSkills.join(', ')}</li>`;
                }
                analysisHtml += `</ul>`;
            }

            if (analysisData.cvAnalysisDetails.strengths?.length) {
                analysisHtml += `<h4>نقاط القوة:</h4><ul>`;
                analysisData.cvAnalysisDetails.strengths.forEach(strength => { analysisHtml += `<li>${strength}</li>`; });
                analysisHtml += `</ul>`;
            }
             if (analysisData.cvAnalysisDetails.saudiMarketRelevance) {
                analysisHtml += `<h4>مدى الملاءمة لسوق العمل السعودي:</h4><p>${analysisData.cvAnalysisDetails.saudiMarketRelevance}</p>`;
            }


            document.getElementById('analysisText').innerHTML = analysisHtml;
            
            createSkillsChart(analysisData.keySkillsForChart, analysisData.scores); 
            
            const recommendedJob = analysisData.recommendedJob;
            document.getElementById('recommendedPosition').innerHTML = `
                <div style="background: rgba(86, 171, 47, 0.08); padding: 25px; border-radius: 14px; border-right: 5px solid #56ab2f; box-shadow: 0 4px 12px rgba(86,171,47,0.1);">
                    <h4 style="color: #56ab2f; margin-bottom: 15px; font-weight: 700; font-size: 1.4rem;">${recommendedJob.title}</h4>
                    <p style="margin-bottom: 10px; font-size: 1.1rem; color: var(--text-medium);">${recommendedJob.reasoning}</p>
                </div>
            `;
            
            document.getElementById('interviewBtn').disabled = false;
        }


        function createSkillsChart(skillsArray = [], scores = {}) {
            const ctx = document.getElementById('skillsChart').getContext('2d');
            const defaultLabels = ['المهارات التقنية', 'التواصل', 'القيادة', 'حل المشكلات', 'العمل الجماعي'];
            const labels = skillsArray.length > 0 ? skillsArray.slice(0, 5) : defaultLabels; 
            const data = labels.map(() => Math.floor(Math.random() * 30 + (scores.skillsMatch || scores.overall || 60) - 15)); 

            if (window.skillsRadarChart) window.skillsRadarChart.destroy();
            window.skillsRadarChart = new Chart(ctx, { 
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تقييم المهارات (تقديري)', data: data,
                        backgroundColor: 'rgba(79, 172, 254, 0.25)', borderColor: '#4facfe', borderWidth: 2.5,
                        pointBackgroundColor: '#4facfe', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4facfe', pointRadius: 4, pointHoverRadius: 6
                    }]
                },
                options: { 
                    scales: {
                        r: {
                            angleLines: { display: true, color: 'rgba(0,0,0,0.1)' },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20, backdropColor: 'transparent', color: 'var(--text-medium)' },
                            pointLabels: { font: { size: 13, family: 'Tajawal' }, color: 'var(--text-dark)' },
                            grid: { color: 'rgba(0,0,0,0.08)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { font: { family: 'Tajawal', size: 14 }, color: 'var(--text-dark)' } }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                 }
            });
        }
        
        function animateScore(elementId, targetScore) {
            const element = document.getElementById(elementId);
            if (!element) return;
            let currentScore = 0;
            const duration = 1500; const stepTime = 30; 
            const increment = (targetScore * stepTime) / duration;
            const animation = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) { currentScore = targetScore; clearInterval(animation); }
                element.textContent = Math.round(currentScore) + '%';
            }, stepTime);
        }

        async function startInterview() {
            nextStep();
            const questionContainer = document.getElementById('questionContainer');
            questionContainer.innerHTML = `<div class="text-center" style="padding: 50px;"><div class="loading-spinner" style="width:50px; height:50px;"></div><p style="margin-top:15px; font-size:1.2rem;">جاري تحضير أسئلة المقابلة الشخصية...</p></div>`;

            try {
                const cvSummaryForQuestions = analysisData.cvAnalysisDetails?.comprehensiveSummary || "ملخص السيرة غير متوفر";
                const cvKeySkillsForQuestions = (analysisData.cvAnalysisDetails?.keySkills?.technicalSkills || [])
                                            .concat(analysisData.cvAnalysisDetails?.keySkills?.softSkills || [])
                                            .join(', ');
                const cvExperienceSummaryForQuestions = (analysisData.cvAnalysisDetails?.workExperience || [])
                                            .map(exp => `${exp.jobTitle} في ${exp.company}`)
                                            .join('؛ ');
                const recommendedJobTitleForQuestions = analysisData.recommendedJob?.title || "وظيفة عامة في القطاع الطبي";


                const questionsPrompt = `
أنت نظام ذكاء اصطناعي متخصص في إعداد أسئلة المقابلات الشخصية. بناءً على **التحليل المفصل التالي لسيرة المرشح**، قم بصياغة ${interviewData.totalQuestions} أسئلة مقابلة **شديدة التخصيص وواقعية باللغة العربية**. يجب أن تستهدف الأسئلة التعمق في جوانب محددة من سيرة المرشح وتقييم مدى ملاءمته للعمل في شركة "ميس للمنتجات الطبية" في السوق السعودي.

**معلومات عن المرشح (مستخلصة من سيرته الذاتية):**
*   **الوظيفة المقترحة له:** ${recommendedJobTitleForQuestions}
*   **ملخص عام عن المرشح:** ${cvSummaryForQuestions.substring(0, 500)}
*   **أبرز المهارات المذكورة:** ${cvKeySkillsForQuestions.substring(0, 300)}
*   **ملخص الخبرات العملية:** ${cvExperienceSummaryForQuestions.substring(0, 400)}

**المطلوب صياغة ${interviewData.totalQuestions} أسئلة متنوعة تغطي:**
1.  **سؤال يتعلق بخبرة محددة:** اطلب من المرشح التوسع في وصف إحدى خبراته المذكورة، مع التركيز على إنجاز معين أو تحدٍ واجهه (مثال: "في سيرتك الذاتية، ذكرت عملك كـ [المسمى الوظيفي السابق] في شركة [اسم الشركة السابق]. صف لنا بالتفصيل مشروعًا هامًا قدته أو ساهمت به، وما كانت النتائج؟").
2.  **سؤال لتقييم مهارة أساسية:** اختر مهارة بارزة من قائمة مهاراته واطلب منه تقديم مثال عملي يوضح كيف استخدم هذه المهارة (مثال: "لاحظنا أن لديك مهارة [اسم المهارة]. هل لك أن تشاركنا بموقف احتجت فيه لاستخدام هذه المهارة بشكل فعال لحل مشكلة أو تحقيق هدف؟").
3.  **سؤال سلوكي (STAR):** صغ سؤالًا يتطلب من المرشح وصف موقف معين، المهمة، الإجراء الذي اتخذه، والنتيجة (مثال: "صف لنا موقفًا اضطررت فيه للتعامل مع ضغط عمل كبير أو موعد نهائي ضيق. كيف أدرت الموقف وماذا كانت النتيجة؟").
4.  **سؤال عن التطلعات والملاءمة للشركة:** سؤال يستكشف فهم المرشح لطبيعة العمل في "ميس للمنتجات الطبية" أو تطلعاته المهنية المتعلقة بالقطاع (مثال: "ما الذي يجعلك مهتمًا بالانضمام إلى فريق عمل ميس للمنتجات الطبية تحديدًا، وكيف ترى أن خبراتك تتوافق مع رؤيتنا؟" أو "كيف ترى مساهمتك في تطوير قطاع المنتجات الطبية في السعودية من خلال دورك معنا؟").
5.  **سؤال مفتوح أو تقني (إذا كانت الوظيفة تتطلب):** سؤال يتيح للمرشح إظهار معرفته أو طرح استفسارات (مثال: "هل لديك أية أسئلة تود طرحها علينا بخصوص هذا الدور أو الشركة؟" أو إذا كانت وظيفة فنية: "ما هي، برأيك، أهم التحديات التي تواجه ضمان جودة المنتجات الطبية حاليًا في السوق السعودي؟").

تجنب الأسئلة العامة جدًا. اجعلها مرتبطة قدر الإمكان بما ورد عن المرشح.
الرد يجب أن يكون عبارة عن مصفوفة JSON من الأسئلة النصية فقط. مثال:
["السؤال الأول هنا...", "السؤال الثاني هنا...", ...]
`;
                const questionsResponseText = await callGeminiAPI(questionsPrompt);
                const cleanedQuestionsResponse = cleanGeminiResponse(questionsResponseText);
                let questions = JSON.parse(cleanedQuestionsResponse);
                
                if (!Array.isArray(questions) || questions.length < interviewData.totalQuestions) {
                    throw new Error("لم يتم إنشاء العدد الكافي من الأسئلة المخصصة.");
                }
                
                interviewData.questions = questions.slice(0, interviewData.totalQuestions); 
                interviewData.answers = new Array(interviewData.questions.length).fill(null).map(() => ({ written: '', recordingUrl: null, recordingBlob: null }));
                interviewData.currentQuestionIndex = 0;
                displayCurrentQuestion();
                
            } catch (error) {
                console.error('Error generating interview questions:', error);
                 if (error instanceof SyntaxError) {
                    const rawResponseForDebug = await callGeminiAPI(questionsPrompt, true);
                    console.error("Problematic Gemini Response (Interview Questions):", rawResponseForDebug);
                }
                showNotification(`خطأ في إنشاء أسئلة مخصصة: ${error.message}. سيتم استخدام أسئلة افتراضية.`, 'error');
                interviewData.questions = [
                    "تحدث عن خبرتك السابقة التي تراها الأكثر صلة بمجال المنتجات الطبية.",
                    "صف موقفاً واجهت فيه تحدياً كبيراً في العمل وكيف تعاملت معه.",
                    "ما هي نقاط قوتك الرئيسية التي تجعلك مناسباً لهذا النوع من الوظائف؟",
                    "أين ترى نفسك مهنياً بعد خمس سنوات من الآن؟",
                    "هل لديك أي أسئلة تود طرحها علينا حول الشركة أو الدور الوظيفي؟"
                ];
                interviewData.answers = new Array(interviewData.questions.length).fill(null).map(() => ({ written: '', recordingUrl: null, recordingBlob: null }));
                interviewData.currentQuestionIndex = 0;
                displayCurrentQuestion();
            }
        }
        
        function displayCurrentQuestion() {
            const questionIndex = interviewData.currentQuestionIndex;
            const question = interviewData.questions[questionIndex];
            const questionContainer = document.getElementById('questionContainer');
            if (questionIntervalTimer) clearInterval(questionIntervalTimer);
            questionContainer.innerHTML = `
                <div class="question-card active fade-in">
                    <div class="question-header">
                        <div class="question-number">السؤال <span id="currentQuestionNum">${questionIndex + 1}</span> من <span id="totalQuestions">${interviewData.questions.length}</span></div>
                        <div class="question-timer"><i class="fas fa-stopwatch"></i> <span id="questionTimerDisplay">${formatTime(interviewData.questionTimeLimit)}</span></div>
                    </div>
                    <div class="question-text" id="currentQuestionText">${question}</div>
                    <div class="answer-section">
                        <h4><i class="fas fa-keyboard"></i> الإجابة الكتابية (مطلوبة)</h4>
                        <textarea class="answer-textarea" id="writtenResponse" placeholder="اكتب إجابتك هنا بوضوح..." rows="6">${interviewData.answers[questionIndex]?.written || ''}</textarea>
                    </div>
                    <div class="voice-recording">
                        <h4><i class="fas fa-microphone-alt"></i> الإجابة الصوتية (اختياري)</h4>
                        <button class="recording-btn" id="recordBtn" onclick="toggleRecording()" aria-label="بدء/إيقاف التسجيل الصوتي"><i class="fas fa-microphone"></i></button>
                        <div id="recordingStatus" style="font-size: 1.1rem; margin-bottom: 15px; color: var(--text-medium);">انقر لبدء التسجيل الصوتي (بحد أقصى دقيقتان)</div>
                        <div class="audio-visualizer hidden" id="audioVisualizer">${[...Array(5)].map(() => `<div class="bar"></div>`).join('')}</div>
                        <audio controls class="hidden" id="audioPlayback" style="width: 100%; margin-top: 20px;"></audio>
                        ${interviewData.answers[questionIndex]?.recordingUrl ? `<p style="margin-top:10px;"><a href="${interviewData.answers[questionIndex].recordingUrl}" target="_blank">الاستماع للتسجيل المحفوظ</a></p>` : ''}
                    </div>
                </div>`;
            const audioPlayback = document.getElementById('audioPlayback');
            if (interviewData.answers[questionIndex]?.recordingUrl) {
                audioPlayback.src = interviewData.answers[questionIndex].recordingUrl;
                audioPlayback.classList.remove('hidden');
            }
            startQuestionTimer(interviewData.questionTimeLimit);
            updateInterviewNavButtons();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60); const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startQuestionTimer(duration) {
            let timeLeft = duration; const timerDisplay = document.getElementById('questionTimerDisplay');
            if (!timerDisplay) return;
            timerDisplay.textContent = formatTime(timeLeft);
            questionIntervalTimer = setInterval(() => {
                timeLeft--; timerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(questionIntervalTimer); showNotification('انتهى وقت السؤال الحالي!', 'info');
                    if (interviewData.currentQuestionIndex < interviewData.questions.length - 1) nextQuestion();
                    else finishInterview();
                }
            }, 1000);
        }

        function updateInterviewNavButtons() {
            const qIndex = interviewData.currentQuestionIndex; const totalQ = interviewData.questions.length;
            document.getElementById('prevQuestionBtn').disabled = qIndex === 0;
            document.getElementById('nextQuestionBtn').classList.toggle('hidden', qIndex === totalQ - 1);
            document.getElementById('finishInterviewBtn').classList.toggle('hidden', qIndex !== totalQ - 1);
            document.getElementById('finishInterviewBtn').disabled = false; 
        }

        function saveCurrentAnswer() {
            const questionIndex = interviewData.currentQuestionIndex;
            const writtenAnswer = document.getElementById('writtenResponse').value;
            if (!interviewData.answers[questionIndex]) interviewData.answers[questionIndex] = { written: '', recordingUrl: null, recordingBlob: null };
            interviewData.answers[questionIndex].written = writtenAnswer.trim();
        }

        function nextQuestion() {
            saveCurrentAnswer(); if (isRecording) stopRecording(); 
            if (interviewData.currentQuestionIndex < interviewData.questions.length - 1) {
                interviewData.currentQuestionIndex++; displayCurrentQuestion();
            }
        }

        function prevQuestion() {
            saveCurrentAnswer(); if (isRecording) stopRecording();
            if (interviewData.currentQuestionIndex > 0) {
                interviewData.currentQuestionIndex--; displayCurrentQuestion();
            }
        }
        
        async function toggleRecording() { if (!isRecording) await startRecording(); else stopRecording(); }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); 
                recordingChunks = [];
                mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) recordingChunks.push(event.data); };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(recordingChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayback = document.getElementById('audioPlayback');
                    audioPlayback.src = audioUrl; audioPlayback.classList.remove('hidden');
                    const questionIndex = interviewData.currentQuestionIndex;
                    interviewData.answers[questionIndex].recordingUrl = audioUrl;
                    interviewData.answers[questionIndex].recordingBlob = audioBlob; 
                    document.getElementById('recordingStatus').textContent = 'تم إيقاف التسجيل. يمكنك الاستماع أو إعادة التسجيل.';
                };
                mediaRecorder.start(); isRecording = true;
                document.getElementById('recordBtn').classList.add('active');
                document.getElementById('recordBtn').innerHTML = '<i class="fas fa-stop-circle"></i>'; 
                document.getElementById('recordingStatus').textContent = 'جاري التسجيل... انقر للإيقاف.';
                document.getElementById('audioVisualizer').classList.remove('hidden');
            } catch (error) { showNotification('تعذر الوصول للميكروفون. يرجى التحقق من الأذونات.', 'error'); }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop(); isRecording = false;
                document.getElementById('recordBtn').classList.remove('active');
                document.getElementById('recordBtn').innerHTML = '<i class="fas fa-microphone"></i>'; 
                document.getElementById('audioVisualizer').classList.add('hidden');
            }
        }

        async function finishInterview() {
            saveCurrentAnswer(); if (isRecording) stopRecording();
            if (questionIntervalTimer) clearInterval(questionIntervalTimer);
            document.getElementById('finishInterviewBtn').disabled = true;
            document.getElementById('prevQuestionBtn').disabled = true;
            nextStep(); await evaluateInterview();
        }

        async function evaluateInterview() {
            document.getElementById('evaluationLoader').classList.remove('hidden');
            document.getElementById('evaluationResults').classList.add('hidden');
            try {
                let interviewSummaryForEval = interviewData.questions.map((q, i) => {
                    let answerText = `السؤال ${i+1}: ${q}\n`;
                    answerText += `الإجابة الكتابية: ${interviewData.answers[i]?.written || "(لم تتم الإجابة كتابيًا)"}\n`;
                    answerText += `الإجابة الصوتية: ${interviewData.answers[i]?.recordingUrl ? "(يوجد تسجيل صوتي)" : "(لا يوجد تسجيل صوتي)"}\n`;
                    return answerText;
                }).join("\n---\n");

                const cvAnalysisForEval = analysisData.cvAnalysisDetails; 

                const evaluationPrompt = `
أنت مقيّم مقابلات خبير ومتخصص في توظيف الكفاءات لشركة "ميس للمنتجات الطبية" في السوق السعودي. بناءً على **التحليل المفصل التالي لسيرة المرشح** و**إجاباته المحددة في المقابلة**، قم بتقديم تقييم شامل ودقيق لأدائه.

**ملخص تحليل السيرة الذاتية للمرشح:**
*   **الوظيفة المقترحة مبدئيًا:** ${cvAnalysisForEval?.recommendedJob?.title || "غير محددة"}
*   **الملخص الشامل من السيرة:** ${cvAnalysisForEval?.comprehensiveSummary?.substring(0, 500) || "غير متوفر"}
*   **أبرز المهارات من السيرة:** 
    *   فنية/تقنية: ${(cvAnalysisForEval?.keySkills?.technicalSkills || ["-"]).join(', ')}
    *   شخصية/سلوكية: ${(cvAnalysisForEval?.keySkills?.softSkills || ["-"]).join(', ')}
*   **أهم نقاط القوة من السيرة:** ${(cvAnalysisForEval?.strengths || ["-"]).join('؛ ')}
*   **تقييم الملاءمة الأولية للسوق السعودي من السيرة:** ${cvAnalysisForEval?.saudiMarketRelevance || "غير مقيّم"}

**إجابات المرشح في المقابلة:**
---
${interviewSummaryForEval}
---

**المطلوب تقديم تقييم مفصل باللغة العربية، وبتنسيق JSON صارم، يتضمن النقاط التالية مع ربط التقييم بإجابات المرشح وما ورد في سيرته:**

1.  **scores (التقييمات الرقمية - من 0 إلى 100):**
    *   **finalOverallPerformance (الأداء العام النهائي في المقابلة):** تقييم شامل لأداء المرشح بناءً على جميع جوانب المقابلة.
    *   **communicationClarity (وضوح التواصل واللغة):** تقييم لمدى وضوح إجابات المرشح وقدرته على التعبير عن أفكاره بشكل فعال.
    *   **skillDemonstration (إظهار المهارات والخبرات):** تقييم لمدى قدرة المرشح على إثبات المهارات والخبرات المذكورة في سيرته من خلال إجاباته (خاصة المهارات الفنية والسلوكية). أعط أمثلة.
    *   **culturalAndCompanyFit (الملاءمة لثقافة الشركة والسوق السعودي):** تقييم لمدى توافق شخصية المرشح وتطلعاته مع ثقافة شركة "ميس" واحتياجات السوق السعودي.
2.  **performanceAnalysis (تحليل الأداء التفصيلي):**
    *   **strengthsObserved (نقاط القوة التي لوحظت في المقابلة):** قائمة بـ 2-3 نقاط قوة بارزة أظهرها المرشح خلال المقابلة، مع أمثلة محددة من إجاباته.
    *   **areasToDevelopBasedOnInterview (مجالات للتطوير بناءً على المقابلة):** قائمة بـ 1-2 مجالات يمكن للمرشح تطويرها بناءً على أدائه في المقابلة، مع اقتراحات عملية.
    *   **cvClaimsValidation (مدى تأكيد ما ورد في السيرة):** هل أكدت المقابلة الانطباع الأولي من السيرة الذاتية أم كشفت عن جوانب مختلفة (إيجابية أو سلبية)؟ وضح.
3.  **overallRecommendation (التوصية النهائية):**
    *   **decisionStatus (القرار المبدئي المقترح):** اختر من: ("موصى به بشدة", "موصى به", "موصى به مع تحفظات", "غير موصى به حاليًا").
    *   **justification (مبررات القرار):** شرح مفصل (3-4 أسطر) للقرار المقترح، يلخص أهم نتائج التقييم ويربطها بمتطلبات الوظيفة المحتملة في "ميس".

تأكد من أن التحليل **واقعي ومبني بشكل مباشر على المعلومات المقدمة**. تجنب التعميمات.
`;

                const evaluationResponseText = await callGeminiAPI(evaluationPrompt);
                const cleanedEvaluationResponse = cleanGeminiResponse(evaluationResponseText);
                const parsedEvaluation = JSON.parse(cleanedEvaluationResponse);

                analysisData.evaluationScores = { 
                    final: parsedEvaluation.scores?.finalOverallPerformance || 70,
                    communication: parsedEvaluation.scores?.communicationClarity || 70,
                    technicalBehavioral: parsedEvaluation.scores?.skillDemonstration || 70, 
                    personalityFit: parsedEvaluation.scores?.culturalAndCompanyFit || 70
                };
                analysisData.evaluationDetails = parsedEvaluation.performanceAnalysis || {}; 
                analysisData.decision = parsedEvaluation.overallRecommendation?.decisionStatus || "بحاجة لمراجعة يدوية";
                analysisData.decisionReason = parsedEvaluation.overallRecommendation?.justification || "تعذر تحديد سبب القرار آليًا.";

                displayEvaluationResults();
                
            } catch (error) {
                console.error('Error evaluating interview:', error);
                 if (error instanceof SyntaxError) {
                    const rawResponseForDebug = await callGeminiAPI(evaluationPrompt, true);
                    console.error("Problematic Gemini Response (Interview Eval):", rawResponseForDebug);
                }
                showNotification(`خطأ في تقييم المقابلة: ${error.message}. سيتم استخدام بيانات افتراضية.`, 'error');
                analysisData.evaluationScores = { final: 60, communication: 60, technicalBehavioral: 60, personalityFit: 60 };
                analysisData.evaluationDetails = { strengthsObserved: ["قوة افتراضية"], areasToDevelopBasedOnInterview: ["تطوير افتراضي"] };
                analysisData.decision = "بحاجة لمراجعة يدوية";
                analysisData.decisionReason = "خطأ في النظام.";
                displayEvaluationResults(); 
            }
        }
        
        function displayEvaluationResults() {
            document.getElementById('evaluationLoader').classList.add('hidden');
            document.getElementById('evaluationResults').classList.remove('hidden');
            
            animateScore('finalScore', analysisData.evaluationScores.final);
            animateScore('communicationScore', analysisData.evaluationScores.communication);
            animateScore('technicalScore', analysisData.evaluationScores.technicalBehavioral); 
            animateScore('personalityScore', analysisData.evaluationScores.personalityFit);  
            
            document.getElementById('evaluationDecision').textContent = analysisData.decision;
            document.getElementById('decisionReason').textContent = analysisData.decisionReason;

            let detailedEvalHtml = `<h4>نقاط القوة الملاحظة في المقابلة:</h4>`;
            if (analysisData.evaluationDetails.strengthsObserved && analysisData.evaluationDetails.strengthsObserved.length > 0) {
                detailedEvalHtml += `<ul>${analysisData.evaluationDetails.strengthsObserved.map(s => `<li>${s}</li>`).join('')}</ul>`;
            } else { detailedEvalHtml += `<p>لم يتم تحديد نقاط قوة بشكل واضح.</p>`; }

            detailedEvalHtml += `<h4>مجالات للتطوير بناءً على المقابلة:</h4>`;
            if (analysisData.evaluationDetails.areasToDevelopBasedOnInterview && analysisData.evaluationDetails.areasToDevelopBasedOnInterview.length > 0) {
                detailedEvalHtml += `<ul>${analysisData.evaluationDetails.areasToDevelopBasedOnInterview.map(a => `<li>${a}</li>`).join('')}</ul>`;
            } else { detailedEvalHtml += `<p>لم يتم تحديد مجالات تطوير بشكل واضح.</p>`; }
            
            if(analysisData.evaluationDetails.cvClaimsValidation){
                 detailedEvalHtml += `<h4>مدى تأكيد ما ورد في السيرة:</h4><p>${analysisData.evaluationDetails.cvClaimsValidation}</p>`;
            }

            document.getElementById('detailedAnalysis').innerHTML = detailedEvalHtml;
            
            createEvaluationChart(analysisData.evaluationScores);
            const proceedBtn = document.getElementById('proceedToFinalReportBtn'); // Changed ID
            if(proceedBtn) proceedBtn.disabled = false; 
        }

        function createEvaluationChart(scores) {
            const ctx = document.getElementById('evaluationChart').getContext('2d');
            const labels = ['الأداء العام', 'التواصل', 'إظهار المهارات', 'الملاءمة الثقافية'];
            const data = [scores.final, scores.communication, scores.technicalBehavioral, scores.personalityFit];
             if (window.evaluationBarChart) window.evaluationBarChart.destroy();
            window.evaluationBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'التقييم (%)', data: data,
                        backgroundColor: [ 'rgba(79, 172, 254, 0.75)', 'rgba(86, 171, 47, 0.75)', 'rgba(255, 140, 66, 0.75)', 'rgba(102, 126, 234, 0.75)' ],
                        borderColor: [ '#4facfe', '#56ab2f', '#ff8c42', '#667eea' ],
                        borderWidth: 1.5, borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    scales: { x: { beginAtZero: true, max: 100, ticks: { stepSize: 20, color: 'var(--text-medium)' }, grid: { color: 'rgba(0,0,0,0.05)' } }, y: { ticks: { font: { family: 'Tajawal', size: 13 }, color: 'var(--text-dark)' }, grid: { display: false } } },
                    plugins: { legend: { display: false } },
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        async function generateFinalReport() {
            if (String(currentStep) !== "5") { // Check if we are at the evaluation step
                console.warn("generateFinalReport called from an unexpected step:", currentStep);
                // If not on step 5, navigate to step 6. This handles the case if nextStep() was not called by the button.
                // However, the button 'proceedToFinalReportBtn' in step 5 should call this function directly.
            }
            // Hide current step (evaluation) and show step 6 (Report)
            const evalStep = document.getElementById('step5');
            if (evalStep && evalStep.classList.contains('active')) {
                 evalStep.classList.remove('active');
            }
            
            currentStep = 6; 
            const reportStep = document.getElementById(`step${currentStep}`);
            if (reportStep) reportStep.classList.add('active', 'fade-in');
            updateProgressSteps();


            document.getElementById('finalReportLoader').classList.remove('hidden');
            document.getElementById('finalReportContent').classList.add('hidden');
            document.getElementById('finalReportButtons').classList.add('hidden');
            document.getElementById('thankYouMessage').classList.add('hidden');
            await new Promise(resolve => setTimeout(resolve, 1500));

            const reportDate = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            const reportNumber = `MISS-${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${new Date().getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*10000).toString().padStart(4,'0')}`;
            
            const cvDetails = analysisData.cvAnalysisDetails || {};
            const evalDetails = analysisData.evaluationDetails || {};

            let reportHTML = `
                <div class="report-header">
                    <h3>تقرير تقييم المرشح النهائي</h3>
                    <p>اسم المرشح: <strong id="reportName">${document.getElementById('fullName').value || "غير مسجل"}</strong></p>
                    <p>تاريخ التقييم: <strong id="reportDate">${reportDate}</strong></p>
                    <p>رقم التقرير: <strong id="reportNumber">${reportNumber}</strong></p>
                </div>

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-user-circle"></i> معلومات المرشح</h4>
                    <div class="report-grid">
                        <div class="report-card"><h5>الاسم</h5><p>${document.getElementById('fullName').value || "غير مسجل"}</p></div>
                        <div class="report-card"><h5>البريد الإلكتروني</h5><p>${document.getElementById('email').value || "غير مسجل"}</p></div>
                        <div class="report-card"><h5>رقم الهاتف</h5><p>${document.getElementById('phone').value || "غير مسجل"}</p></div>
                        <div class="report-card"><h5>سنوات الخبرة (حسب الإدخال)</h5><p>${document.getElementById('experience').options[document.getElementById('experience').selectedIndex]?.text || "غير محدد"}</p></div>
                    </div>
                </div>

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-id-card-alt"></i> ملخص السيرة الذاتية (AI)</h4>
                    <div class="analysis-content" style="padding: 15px; background: #f9f9f9; border-radius: 10px;">
                        <p>${cvDetails.comprehensiveSummary || "غير متوفر."}</p>
                    </div>
                </div>
                
                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-cogs"></i> المهارات والشهادات (من السيرة)</h4>
                    <div class="report-grid">
                        <div class="report-card">
                            <h5>المهارات الفنية/التقنية</h5>
                            <p>${(cvDetails.keySkills?.technicalSkills || ["-"]).join('، ')}</p>
                        </div>
                        <div class="report-card">
                            <h5>المهارات الشخصية/السلوكية</h5>
                            <p>${(cvDetails.keySkills?.softSkills || ["-"]).join('، ')}</p>
                        </div>
                        <div class="report-card">
                            <h5>الشهادات المهنية</h5>
                            <p>${(cvDetails.certifications || ["-"]).join('، ')}</p>
                        </div>
                         <div class="report-card">
                            <h5>اللغات</h5>
                            <p>${(cvDetails.keySkills?.languageSkills || ["-"]).join('، ')}</p>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-briefcase"></i> الخبرات العملية (من السيرة)</h4>
                    ${(cvDetails.workExperience && cvDetails.workExperience.length > 0) ? cvDetails.workExperience.map(exp => `
                        <div class="report-card" style="text-align:right; margin-bottom:15px;">
                            <h5>${exp.jobTitle || ""} في ${exp.company || ""} (${exp.duration || ""})</h5>
                            <ul>${(exp.responsibilities || []).map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>
                    `).join('') : '<p style="text-align:center;">لم يتم استخلاص خبرات عملية واضحة.</p>'}
                </div>


                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-chart-line"></i> نتائج التقييم الرقمية</h4>
                    <div class="report-grid">
                        <div class="report-card"><h5>الملاءمة العامة (CV)</h5><div class="score-value" style="color: #4facfe;">${analysisData.scores.overall || 0}%</div></div>
                        <div class="report-card"><h5>أداء المقابلة العام</h5><div class="score-value" style="color: #56ab2f;">${analysisData.evaluationScores.final || 0}%</div></div>
                        <div class="report-card"><h5>مهارات التواصل (مقابلة)</h5><div class="score-value" style="color: #ff8c42;">${analysisData.evaluationScores.communication || 0}%</div></div>
                        <div class="report-card"><h5>الملاءمة الثقافية (مقابلة)</h5><div class="score-value" style="color: #667eea;">${analysisData.evaluationScores.personalityFit || 0}%</div></div>
                    </div>
                </div>
                <!-- Removed Fun Assessment Score from final report -->

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-comments"></i> تحليل أداء المقابلة</h4>
                    <div class="analysis-content" style="padding: 20px; background: rgba(249, 250, 252, 0.8); border-radius: 12px; line-height: 1.8;">
                        <p><strong>نقاط القوة الملاحظة:</strong> ${(evalDetails.strengthsObserved || ["-"]).join('، ')}</p>
                        <p><strong>مجالات للتطوير:</strong> ${(evalDetails.areasToDevelopBasedOnInterview || ["-"]).join('، ')}</p>
                        <p><strong>مدى تأكيد ما ورد في السيرة:</strong> ${evalDetails.cvClaimsValidation || "-"}</p>
                    </div>
                </div>

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-thumbs-up"></i> أبرز نقاط القوة (مقترحة من السيرة)</h4>
                    <ul class="strength-list">
                        ${(cvDetails.strengths || ["-"]).map(s => `<li><i class="fas fa-check-circle"></i> ${s}</li>`).join('')}
                    </ul>
                </div>

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-chart-line"></i> مجالات تطوير مقترحة (من السيرة)</h4>
                    <ul class="improvement-list">
                         ${(cvDetails.areasForImprovement || ["-"]).map(a => `<li><i class="fas fa-arrow-alt-circle-up"></i> ${a}</li>`).join('')}
                    </ul>
                </div>

                <div class="report-section">
                    <h4 class="report-section-title"><i class="fas fa-gavel"></i> القرار النهائي والتوصية (بناءً على المقابلة)</h4>
                    <div class="decision-card" style="border-top-color: ${analysisData.decision && analysisData.decision.toLowerCase().includes('موصى') ? 'var(--success-gradient)' : 'var(--danger-gradient)'};">
                        <div class="decision-icon">
                            <i class="fas ${analysisData.decision && analysisData.decision.toLowerCase().includes('موصى') ? 'fa-user-check' : 'fa-user-times'}" style="background: ${analysisData.decision && analysisData.decision.toLowerCase().includes('موصى') ? 'var(--success-gradient)' : 'var(--danger-gradient)'}; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;"></i>
                        </div>
                        <div class="decision-text" id="finalDecision">${analysisData.decision || "بحاجة لمراجعة"}</div>
                        <div class="decision-reason" id="finalDecisionReason">${analysisData.decisionReason || "لا يوجد سبب آلي."}</div>
                    </div>
                </div>

                <div class="report-footer">
                    <p>تم إنشاء هذا التقرير بواسطة نظام التوظيف الذكي - ميس للمنتجات الطبية.</p>
                    <p>تاريخ الإنشاء: <strong id="generationDate">${new Date().toLocaleString('ar-EG')}</strong></p>
                </div>`;
            
            document.getElementById('finalReportContent').innerHTML = reportHTML;
            document.getElementById('finalReportLoader').classList.add('hidden');
            document.getElementById('finalReportContent').classList.remove('hidden');
            document.getElementById('finalReportButtons').classList.remove('hidden');
            document.getElementById('thankYouMessage').classList.remove('hidden');
            document.getElementById('step6').scrollIntoView({ behavior: 'smooth' });
        }

        function cleanGeminiResponse(responseText) {
            if (typeof responseText !== 'string') return '{}'; 
            const match = responseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (match && match[1]) {
                return match[1];
            }
            if (responseText.startsWith("```") && responseText.endsWith("```")) {
                return responseText.substring(3, responseText.length - 3);
            }
            return responseText; 
        }

        async function callGeminiAPI(promptText, returnRaw = false) { 
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                console.warn("Gemini API Key not set. Using mock response.");
                showNotification("تنبيه: مفتاح API للذكاء الاصطناعي غير مهيأ. يتم استخدام بيانات تجريبية.", "info");
                
                if (promptText.includes("حلل نص السيرة الذاتية التالي.")) { 
                     return JSON.stringify({
                        comprehensiveSummary: "مرشح يمتلك خبرة جيدة في المبيعات والتسويق للمنتجات الطبية في السوق السعودي. أظهر قدرة على تحقيق الأهداف وبناء علاقات قوية مع العملاء. حاصل على شهادات ذات صلة.",
                        keySkills: {
                            technicalSkills: ["تحليل البيانات الطبية", "معرفة بالأجهزة الطبية", "إدارة جودة المنتجات"],
                            softSkills: ["التفاوض المتقدم", "القيادة", "التواصل الاستراتيجي", "حل المشكلات المعقدة"],
                            languageSkills: ["العربية - لغة أم", "الإنجليزية - ممتاز (تحدثًا وكتابة)"]
                        },
                        workExperience: [
                            { jobTitle: "مدير مبيعات إقليمي", company: "شركة الأدوية المتقدمة", duration: "5 سنوات (2018-2023)", responsibilities: ["قيادة فريق مبيعات من 10 أفراد", "تحقيق نمو سنوي في المبيعات بنسبة 20%", "تطوير استراتيجيات دخول أسواق جديدة"] },
                            { jobTitle: "مندوب مبيعات طبية أول", company: "مستلزمات الشفاء الطبية", duration: "3 سنوات (2015-2018)", responsibilities: ["تغطية منطقة الرياض الكبرى", "بناء علاقات مع كبار الأطباء والمستشفيات"] }
                        ],
                        education: [ { degree: "ماجستير إدارة أعمال (MBA)", major: "تسويق", institution: "جامعة الملك فهد للبترول والمعادن", graduationYear: "2015" }, { degree: "بكالوريوس صيدلة", major: "صيدلة إكلينيكية", institution: "جامعة الملك سعود", graduationYear: "2012" } ],
                        certifications: ["شهادة معتمدة في تسويق المنتجات الدوائية (SFDA)", "محترف إدارة مشاريع (PMP)"],
                        strengths: ["خبرة قيادية مثبتة في قطاع المبيعات الطبية", "فهم عميق لآليات السوق السعودي", "مهارات تفاوض وإقناع عالية", "شبكة علاقات واسعة في القطاع الصحي"],
                        areasForImprovement: ["تعميق المعرفة باللوائح التنظيمية الجديدة للمنتجات الطبية في هيئة الغذاء والدواء", "اكتساب خبرة في استخدام أنظمة CRM متقدمة"],
                        saudiMarketRelevance: "ملائم جدًا لسوق العمل السعودي نظرًا لخبرته المحلية وفهمه للقطاع.",
                        recommendedJob: { title: "مدير تطوير أعمال المنتجات الطبية", reasoning: "يجمع المرشح بين الخبرة القيادية في المبيعات والفهم التسويقي، مما يؤهله لقيادة مبادرات تطوير الأعمال في السوق السعودي." },
                        scores: { overallSuitability: 90, skillsMatch: 92, experienceRelevance: 88, educationAlignment: 85 }
                    });
                } else if (promptText.includes("أسئلة مقابلة شخصية")) { 
                    return JSON.stringify([
                        "في دورك كمدير مبيعات إقليمي سابق، كيف قمت بتحديد وتطوير استراتيجيات دخول أسواق جديدة ضمن السياق السعودي؟ ما هي أبرز التحديات التي واجهتك؟",
                        "مهارة 'التفاوض المتقدم' من أبرز ما ذكر في سيرتك. هل لك أن تشاركنا بموقف تفاوضي معقد مع جهة حكومية أو مؤسسة صحية كبرى في السعودية وكيف أدرته بنجاح؟",
                        "بالنظر إلى خبرتك وشهادة PMP، كيف تطبق مبادئ إدارة المشاريع في تحقيق أهداف المبيعات أو إطلاق منتجات طبية جديدة؟",
                        "تسعى شركة ميس لتعزيز مكانتها في مجال الأجهزة الطبية التشخيصية المبتكرة. كيف ترى أن خبراتك السابقة يمكن أن تساهم في تحقيق هذا الهدف الاستراتيجي في السوق السعودي؟",
                        "ما هي رؤيتك لأهم ثلاثة اتجاهات مستقبلية ستؤثر على سوق المنتجات الطبية في المملكة خلال الخمس سنوات القادمة، وكيف يمكن لـ 'ميس' الاستفادة منها أو التكيف معها؟"
                    ]);
                } else if (promptText.includes("تقييم شامل ودقيق لأدائه")) { 
                    return JSON.stringify({
                        scores: { finalOverallPerformance: 88, communicationClarity: 90, skillDemonstration: 85, culturalAndCompanyFit: 92 },
                        performanceAnalysis: {
                            strengthsObserved: ["قدرة ممتازة على ربط خبراته السابقة بمتطلبات الدور المقترح.", "إجابات واثقة ومدعومة بأمثلة واقعية من السوق السعودي.", "إظهار فهم جيد لثقافة العمل وأهداف شركة ميس."],
                            areasToDevelopBasedOnInterview: ["يمكن تحسين التفصيل في بعض الإجابات التقنية المتعلقة بأحدث الأجهزة.", "الاستعداد لأسئلة أكثر تعمقًا حول إدارة الفرق الكبيرة."],
                            cvClaimsValidation: "أكدت المقابلة بشكل كبير الانطباع الإيجابي من السيرة الذاتية، وأظهرت عمقًا في الخبرات المذكورة."
                        },
                        overallRecommendation: { decisionStatus: "موصى به بشدة", justification: "أظهر المرشح كفاءة عالية، وفهمًا عميقًا للسوق، وملاءمة ممتازة لثقافة الشركة. يمتلك القدرات اللازمة للنجاح في دور قيادي يتطلب فهماً استراتيجياً للسوق السعودي." }
                    });
                } else if (promptText.includes("حدد اللغة الأساسية للنص")) { 
                     return JSON.stringify({ language: "العربية (تجريبي)", summary: "ملخص تجريبي: المرشح يمتلك مهارات في التواصل وإدارة المشاريع. (بيانات تجريبية)" });
                } else if (promptText.includes("أجب على السؤال التالي للمتقدم")) { 
                    return JSON.stringify({ botResponse: "أنا آسف، ليس لدي إجابة محددة لهذا السؤال حاليًا. يمكنك مراجعة قسم الأسئلة الشائعة أو التواصل مع فريق الدعم مباشرة. (رد تجريبي)"}); 
                }
                return "{}"; 
            }
            
            try {
                const requestBody = { contents: [{ parts: [{ text: promptText }] }] };
                if (promptText.includes("JSON صارم") || promptText.includes("مصفوفة JSON")) {
                    requestBody.generationConfig = { response_mime_type: "application/json" };
                }

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const rawResponseText = await response.text(); 
                if (returnRaw) return rawResponseText; 

                if (!response.ok) {
                    console.error('Gemini API Error:', response.status, rawResponseText);
                    throw new Error(`فشل الاتصال بخدمة الذكاء الاصطناعي (كود: ${response.status}). التفاصيل: ${rawResponseText.substring(0, 200)}`);
                }
                
                const data = JSON.parse(rawResponseText); 
                
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    return data.candidates[0].content.parts[0].text; 
                } else if (data.promptFeedback && data.promptFeedback.blockReason) { 
                    throw new Error(`تم حظر الطلب من Gemini: ${data.promptFeedback.blockReason.reason}. ${data.promptFeedback.blockReason?.message || ''}`);
                }
                throw new Error('لم يتم استلام رد صحيح أو بتنسيق متوقع من خدمة الذكاء الاصطناعي.');
            } catch (error) { 
                console.error('Gemini API Call Error or JSON Parsing Error:', error); 
                throw error; 
            }
        }

        function downloadPDF() { /* ... as before ... */ }
        function printReport() { /* ... as before ... */ }
        function sendToHR() { /* ... as before ... */ }
        function startNewApplication() { window.location.reload(); }
        
        const stepsConfig = {
            1: { nextStepId: 2, validation: validateStep1 },
            2: { nextStepId: 3, prevStepId: 1, validation: () => cvFileDetails !== null || showNotification("يرجى رفع ملف السيرة الذاتية أولاً.", "error") },
            3: { nextStepId: 4, prevStepId: 2 },
            4: { nextStepId: 5, prevStepId: 3 },
            5: { nextStepId: 6, prevStepId: 4 }, // Step 5 now directly goes to Step 6
            6: { prevStepId: 5 } // Step 6 can go back to Step 5
        };


        function nextStep() {
            const currentStepKey = String(currentStep);
            const currentStepConfig = stepsConfig[currentStepKey];

            if (currentStepConfig && currentStepConfig.nextStepId) {
                if (currentStepConfig.validation && !currentStepConfig.validation()) {
                    return; 
                }
                
                const currentSection = document.getElementById(`step${currentStepKey}`);
                if (currentSection) {
                    currentSection.classList.remove('active');
                }
                
                currentStep = currentStepConfig.nextStepId; 
                
                const nextSection = document.getElementById(`step${String(currentStep)}`);
                if (nextSection) {
                    nextSection.classList.add('active', 'fade-in');
                } else {
                    console.error(`Section with ID step${String(currentStep)} not found.`);
                }
                
                updateProgressSteps(); 
                window.scrollTo(0,0);
                // Phaser game mounting removed from here
            }
        }


        function prevStep() {
            const currentStepKey = String(currentStep);
            const currentStepConfig = stepsConfig[currentStepKey];
             if (currentStepConfig && currentStepConfig.prevStepId) {
                const currentSection = document.getElementById(`step${currentStepKey}`);
                if(currentSection) currentSection.classList.remove('active');
                
                currentStep = currentStepConfig.prevStepId;
                
                const prevSection = document.getElementById(`step${String(currentStep)}`);
                if(prevSection) prevSection.classList.add('active', 'fade-in');
                
                updateProgressSteps(); window.scrollTo(0,0);
            }
        }
        
        function updateProgressSteps() {
            const progressSteps = document.querySelectorAll('.progress-bar .progress-step');
            progressSteps.forEach(stepEl => {
                const stepNumberAttr = stepEl.dataset.step; 
                stepEl.classList.remove('active', 'completed');
                
                // Since step 5.5 is removed, direct numeric comparison is fine.
                const numericCurrentStep = parseFloat(currentStep); 
                const numericStepNumber = parseFloat(stepNumberAttr);

                if (stepNumberAttr === "5.5") { // Hide the fun assessment step
                    stepEl.style.display = 'none';
                    return; 
                } else {
                     stepEl.style.display = ''; // Ensure other steps are visible
                }


                if (numericStepNumber < numericCurrentStep) {
                    stepEl.classList.add('completed');
                } else if (numericStepNumber === numericCurrentStep) { 
                    stepEl.classList.add('active');
                }
            });
        }
        
        function showNotification(message, type = 'info', duration = 4500) { 
            const notification = document.getElementById('notification');
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i> ${message}`;
            notification.className = `notification ${type}`; 
            notification.classList.remove('show'); void notification.offsetWidth; notification.classList.add('show');
            if (notification.timer) clearTimeout(notification.timer);
            notification.timer = setTimeout(() => { notification.classList.remove('show'); }, duration);
        }

        function validateStep1() { 
            const name = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const experience = document.getElementById('experience').value;
            
            if (!name) { showNotification('يرجى إدخال الاسم الكامل.', 'error'); return false; }
            if (!email) { showNotification('يرجى إدخال البريد الإلكتروني.', 'error'); return false; }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) { showNotification('البريد الإلكتروني غير صحيح.', 'error'); return false; }
            if (!phone) { showNotification('يرجى إدخال رقم الهاتف.', 'error'); return false; }
            const phoneRegex = /^\+?[1-9]\d{1,14}$/; 
            if (!phoneRegex.test(phone.replace(/\s/g, ''))) { showNotification('رقم الهاتف غير صحيح. استخدم الصيغة الدولية إذا لزم الأمر.', 'error'); return false; }
            if (!experience) { showNotification('يرجى اختيار سنوات الخبرة.', 'error'); return false; }
            return true;
        }

        function initChatbot() { 
            const toggler = document.getElementById('chatbotToggler');
            const container = document.getElementById('chatbotContainer');
            const closeBtn = document.getElementById('closeChatbotBtn');
            const messagesDiv = document.getElementById('chatbotMessages');
            const inputField = document.getElementById('chatbotInput');
            const sendBtn = document.getElementById('sendChatbotMessage');

            const faqs = {
                "مرحبا": "مرحباً بك! كيف يمكنني مساعدتك اليوم؟",
                "شكرا": "على الرحب والسعة! هل هناك أي شيء آخر يمكنني المساعدة به؟",
                "ما هي شركة ميس": "شركة ميس للمنتجات الطبية هي شركة رائدة في مجال توفير وتطوير المنتجات والحلول الطبية المبتكرة في المملكة العربية السعودية.",
                "الوظائف المتاحة": "يمكنك استعراض الوظائف المقترحة لك بعد تحليل سيرتك الذاتية في الخطوة الثالثة. بشكل عام، لدينا فرص في مجالات المبيعات، التسويق، الجودة، والشؤون التنظيمية.",
                "مدة التقييم": "تعتمد مدة التقييم على سرعة إكمالك للخطوات. بشكل عام، يمكن أن يستغرق الأمر من 30 إلى 60 دقيقة.",
                "كيف اتواصل معكم": "يمكنك التواصل معنا عبر البريد الإلكتروني careers@mais-medical.com أو من خلال نموذج الاتصال على موقعنا الرسمي.",
                "مساعدة": "يمكنني الإجابة على أسئلتك العامة حول عملية التقديم أو شركة ميس. تفضل بسؤالك!"
            };

            toggler.addEventListener('click', () => container.classList.toggle('active'));
            closeBtn.addEventListener('click', () => container.classList.remove('active'));
            sendBtn.addEventListener('click', sendUserMessage);
            inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendUserMessage(); });

            async function sendUserMessage() {
                const messageText = inputField.value.trim();
                if (!messageText) return;
                addChatMessage(messageText, 'user');
                inputField.value = '';
                await getBotResponse(messageText); 
            }

            async function getBotResponse(userMessage) {
                addChatMessage('<span></span><span></span><span></span>', 'bot typing'); 
                await new Promise(resolve => setTimeout(resolve, 800)); 

                const typingIndicator = messagesDiv.querySelector('.chat-message.bot.typing');
                if (typingIndicator) messagesDiv.removeChild(typingIndicator);

                let botReply = faqs[userMessage.toLowerCase()] || faqs[findBestMatch(userMessage, Object.keys(faqs))];
                
                if (!botReply) {
                    try {
                        const prompt = `أنت مساعد توظيف ذكي وودود لشركة "ميس للمنتجات الطبية". أجب على السؤال التالي للمتقدم باختصار ووضوح، مع العلم أن سياق المحادثة هو عملية تقديم على وظيفة. السؤال: "${userMessage}"`;
                        const responseText = await callGeminiAPI(prompt);
                        try {
                            const parsed = JSON.parse(cleanGeminiResponse(responseText));
                            botReply = parsed.botResponse || responseText; 
                        } catch (jsonError) {
                            botReply = cleanGeminiResponse(responseText); 
                        }

                    } catch (e) {
                        console.error("Chatbot API error:", e);
                        botReply = "عذراً، أواجه بعض الصعوبات التقنية حالياً. حاول مرة أخرى لاحقاً أو تفقد الأسئلة الشائعة.";
                    }
                }
                addChatMessage(botReply, 'bot');
            }
            
            function findBestMatch(query, keys) { 
                query = query.toLowerCase();
                let bestMatch = null;
                let highestScore = 0;
                keys.forEach(key => {
                    let score = 0;
                    const keyWords = key.toLowerCase().split(" ");
                    keyWords.forEach(word => {
                        if (query.includes(word)) score++;
                    });
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = key;
                    }
                });
                return highestScore > 1 ? bestMatch : null; 
            }

            function addChatMessage(text, type) {
                const messageEl = document.createElement('div');
                messageEl.classList.add('chat-message', type);
                messageEl.innerHTML = text; 
                messagesDiv.appendChild(messageEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight; 
            }
        }
        
        // Phaser Game related functions and variables removed.
        // QuizScene class removed.
        // mountPhaserGame function removed.
    </script>
</body>
</html>