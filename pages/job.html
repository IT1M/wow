<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- General Variables & Base Styles --- */
        :root {
            --primary: #005a9c;
            --primary-dark: #003a6c;
            --accent: #e87722;
            --accent-light: #ffb366;
            --bg-main: #f5f8fa;
            --bg-content: #ffffffcc;
            --bg-alt: #e6f0fa88;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e6e6e6;
            --gradient-primary: linear-gradient(135deg, #005a9c 0%, #e87722 100%);
            --font-main: 'Cairo', sans-serif;
            --font-code: 'IBM Plex Sans Arabic', monospace;
            --font-creative: 'Changa', sans-serif;
            --spacing-1: 0.25rem; 
            --spacing-2: 0.5rem; 
            --spacing-3: 0.75rem; 
            --spacing-4: 1rem;
            --spacing-6: 1.5rem; 
            --spacing-8: 2rem; 
            --spacing-12: 3rem;
            --spacing-16: 4rem;
            --font-size-xs: 0.75rem; 
            --font-size-sm: 0.875rem; 
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem; 
            --font-size-xl: 1.25rem; 
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem; 
            --font-size-4xl: 2.25rem; 
            --font-size-5xl: 3rem;
            --border-radius: 0.5rem; 
            --border-radius-lg: 1rem;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease-in-out;
        }

        [data-theme="light"] {
            --bg-main: #f7fafc;
            --bg-content: var(--white);
            --bg-alt: #edf2f7;
            --text-primary: var(--dark);
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #3cb371 100%);
        }

        [data-theme="dark"] {
            --primary: #38a169;
            --primary-dark: #2f855a;
            --bg-main: #1a202c;
            --bg-content: #2d3748;
            --bg-alt: #171923;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #2f855a 100%);
        }

        [data-theme="high-contrast"] {
            --primary: #ffff00; /* Yellow */
            --primary-dark: #e6e600;
            --accent: #00ffff; /* Cyan */
            --bg-main: #000000;
            --bg-content: #000000;
            --bg-alt: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #ffffff;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, #e6e600 100%);
        }
        
        /* Persona-based UI adaptations */
        [data-persona="developer"] { --font-main: var(--font-code); --primary: #3b82f6; --accent: #16a34a; }
        [data-persona="designer"] { --font-main: var(--font-creative); --primary: #8b5cf6; --accent: #ec4899; --border-radius: 1rem; --border-radius-lg: 2rem; }
        [data-persona="marketer"] { --primary: #f97316; --accent: #22c55e; }


        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--spacing-4); }
        h1, h2, h3, h4 { font-weight: 700; color: var(--text-primary); transition: color 0.3s ease; }
        p { color: var(--text-secondary); }
        a.btn { text-decoration: none; }
        button, input, select, textarea { font-family: inherit; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: var(--spacing-2); 
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--border-radius); 
            font-weight: 600;
            cursor: pointer; 
            transition: var(--transition); 
            border: none;
            box-shadow: var(--shadow);
            font-size: var(--font-size-base);
            width: 100%;
            margin: var(--spacing-2) 0;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-alt); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background: var(--border-color); }

        /* --- Page Header --- */
        .page-header {
            background: var(--gradient-primary); 
            color: var(--white);
            padding: var(--spacing-4) 0; 
            margin-bottom: var(--spacing-4);
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
            transition: var(--transition);
        }
        .header-content { 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            text-align: center;
            padding: 0 var(--spacing-2);
        }
        .header-info { 
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .company-logo {
            width: 120px;
            height: auto;
            margin-bottom: var(--spacing-3);
        }
        .header-info h1 { 
            font-size: var(--font-size-xl); 
            margin-bottom: var(--spacing-2); 
            display: flex; 
            align-items: center; 
            gap: var(--spacing-2); 
            color: var(--white); 
            justify-content: center;
        }
        .header-info p { 
            opacity: 0.9; 
            font-size: var(--font-size-sm); 
            color: var(--white); 
            margin-bottom: var(--spacing-3);
            max-width: 80%;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: var(--spacing-2); 
            flex-wrap: wrap;
            justify-content: center;
            margin-top: var(--spacing-2);
        }
        .theme-toggle { 
            background: rgba(255, 255, 255, 0.2); 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            color: var(--white); 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-size: var(--font-size-lg); 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-btn {
            font-size: var(--font-size-sm);
            padding: var(--spacing-2) var(--spacing-3);
        }

        /* --- Progress Bar --- */
        .progress-container { 
            background: var(--bg-content); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-3); 
            margin-bottom: var(--spacing-4); 
            box-shadow: var(--shadow-md); 
            overflow-x: auto;
        }
        .progress-bar { 
            display: flex; 
            justify-content: space-between; 
            position: relative;
            min-width: 500px;
        }
        .progress-bar::before { 
            content: ''; 
            position: absolute; 
            top: 20px; 
            left: 0; 
            right: 0; 
            height: 2px; 
            background: var(--border-color); 
            transform: translateY(-50%); 
            z-index: 1; 
        }
        .progress-step { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: var(--spacing-2); 
            position: relative; 
            z-index: 2; 
            flex: 1; 
            text-align: center; 
            min-width: 70px;
        }
        .step-circle { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: var(--font-size-base); 
            color: var(--text-secondary); 
            transition: var(--transition); 
            border: 3px solid var(--bg-content); 
            box-shadow: var(--shadow); 
        }
        .step-title { 
            font-size: var(--font-size-xs); 
            color: var(--text-secondary); 
            font-weight: 600; 
            max-width: 70px;
            line-height: 1.3;
        }
        .progress-step.active .step-circle { background: var(--gradient-primary); color: var(--white); transform: scale(1.1); }
        .progress-step.active .step-title { color: var(--primary); }
        .progress-step.completed .step-circle { background: var(--primary); color: var(--white); animation: pop 0.5s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.25); box-shadow: 0 0 15px var(--primary); } 100% { transform: scale(1); } }


        /* --- Step Content --- */
        .content-container { 
            background: var(--bg-content); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-4); 
            box-shadow: var(--shadow-md); 
            min-height: auto;
            margin-bottom: var(--spacing-8);
        }
        .step-content { display: none; animation: fadeInUp 0.5s ease; }
        .step-content.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-header { text-align: center; margin-bottom: var(--spacing-4); }
        .step-header h2 { 
            font-size: var(--font-size-xl); 
            color: var(--text-primary); 
            margin-bottom: var(--spacing-2); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--spacing-2); 
        }
        .step-header p { 
            color: var(--text-secondary); 
            font-size: var(--font-size-base); 
            margin-bottom: var(--spacing-3);
        }

        /* --- Forms & Inputs --- */
        .form { max-width: 800px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-4); margin-bottom: var(--spacing-4); }
        .form-group { display: flex; flex-direction: column; gap: var(--spacing-2); }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; color: var(--text-primary); font-size: var(--font-size-sm); }
        .form-group input, .form-group select, .form-group textarea {
            padding: var(--spacing-3); 
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius); 
            font-size: var(--font-size-base);
            transition: var(--transition); 
            background: var(--bg-alt); 
            color: var(--text-primary);
            width: 100%;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); 
        }
        .form-actions { 
            display: flex; 
            flex-direction: column;
            gap: var(--spacing-2); 
            justify-content: center; 
            margin-top: var(--spacing-4); 
        }

        /* --- File Upload --- */
        .upload-area { 
            border: 2px dashed var(--border-color); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-6); 
            text-align: center; 
            transition: var(--transition); 
            cursor: pointer; 
            background: var(--bg-alt); 
            margin: var(--spacing-3) 0;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 5%, transparent); }
        .upload-icon { font-size: var(--font-size-3xl); color: var(--text-secondary); margin-bottom: var(--spacing-3); }
        .file-info { 
            background: var(--bg-alt); 
            border-radius: var(--border-radius); 
            padding: var(--spacing-3); 
            margin-top: var(--spacing-4); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .file-details { 
            display: flex; 
            align-items: center; 
            gap: var(--spacing-2); 
            flex: 1;
            min-width: 200px;
        }
        .file-details i { font-size: var(--font-size-xl); color: var(--primary); }
        .file-name { font-weight: 600; font-size: var(--font-size-sm); }
        .file-size { font-size: var(--font-size-xs); color: var(--text-secondary); }

        /* --- Loading & Cards --- */
        .loading-state { text-align: center; padding: var(--spacing-8) var(--spacing-4); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto var(--spacing-4); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state h3 { font-size: var(--font-size-lg); margin-bottom: var(--spacing-2); }
        .loading-state #dynamicLoadingMessage { color: var(--text-secondary); font-size: var(--font-size-base); min-height: 24px; }
        .analysis-details, .evaluation-details { display: grid; grid-template-columns: 1fr; gap: var(--spacing-4); }
        .detail-card { 
            background: var(--bg-alt); 
            border-radius: var(--border-radius); 
            padding: var(--spacing-4); 
            border-right: 4px solid var(--primary); 
            margin-bottom: var(--spacing-3);
        }
        .detail-card h3 { 
            font-size: var(--font-size-base); 
            color: var(--text-primary); 
            margin-bottom: var(--spacing-3); 
            display: flex; 
            align-items: center; 
            gap: var(--spacing-2); 
        }
        .detail-card ul { list-style: none; padding-right: var(--spacing-3); }
        .detail-card li { padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: var(--font-size-sm); }
        .detail-card li:last-child { border-bottom: none; }


        /* --- Challenge Step --- */
        .challenge-container { max-width: 800px; margin: 0 auto; }
        .challenge-box { 
            background: var(--bg-alt); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-4); 
            border-left: 4px solid var(--accent); 
            margin-bottom: var(--spacing-4);
        }
        .challenge-box h3 { color: var(--accent); margin-bottom: var(--spacing-3); font-size: var(--font-size-lg); }
        .challenge-box p { font-size: var(--font-size-base); margin-bottom: var(--spacing-4); }

        /* --- Interview --- */
        .interview-container { max-width: 800px; margin: 0 auto; }
        .question-card { 
            background: var(--bg-alt); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-4); 
            border-right: 4px solid var(--primary); 
        }
        .question-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: var(--spacing-4); 
            padding-bottom: var(--spacing-3); 
            border-bottom: 2px solid var(--border-color); 
            flex-wrap: wrap;
        }
        .question-timer { 
            display: flex; 
            align-items: center; 
            gap: var(--spacing-2); 
            color: var(--accent); 
            font-weight: 600; 
            font-size: var(--font-size-sm);
        }
        .voice-btn { 
            background: var(--accent); 
            color: var(--white); 
            width: 100%;
            margin: var(--spacing-2) 0;
        }
        .voice-btn.recording { background: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, #ef4444 70%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, #ef4444 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, #ef4444 0%, transparent); } }
        .real-time-coaching {
            display: flex; 
            flex-wrap: wrap;
            gap: var(--spacing-3); 
            margin-top: var(--spacing-2); 
            padding: var(--spacing-2);
            background: color-mix(in srgb, var(--primary) 5%, transparent); 
            border-radius: var(--border-radius);
            font-size: var(--font-size-sm); 
            color: var(--text-secondary);
        }
        .real-time-coaching span {
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
        }

        /* --- Final Report & Charts --- */
        .report-container { 
            background: var(--bg-alt); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-4); 
            border: 2px solid var(--border-color); 
        }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-3); margin-top: var(--spacing-3); }
        .report-item { 
            background: var(--bg-content); 
            border-radius: var(--border-radius); 
            padding: var(--spacing-3); 
            border-right: 3px solid var(--primary); 
            text-align: center; 
        }
        .report-item p { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: var(--spacing-1) 0; }
        #finalScoreChartContainer { max-width: 100%; margin: var(--spacing-4) auto; height: 300px; }
        .career-path-explorer { display: flex; flex-direction: column; gap: var(--spacing-3); }
        .career-path-node { 
            background: var(--bg-content); 
            border-radius: var(--border-radius); 
            padding: var(--spacing-3); 
            border-left: 4px solid var(--accent); 
            position: relative; 
            margin-bottom: var(--spacing-2);
        }
        .career-path-node h4 { color: var(--accent); font-size: var(--font-size-base); }
        .career-path-node p { font-size: var(--font-size-sm); margin: 0; }
        .disclaimer { 
            font-size: var(--font-size-xs); 
            color: var(--text-secondary); 
            text-align: center; 
            margin-top: var(--spacing-3); 
            padding: var(--spacing-2); 
            background-color: color-mix(in srgb, var(--accent) 10%, transparent); 
            border-radius: var(--border-radius); 
        }
        
        /* --- AI Assistant --- */
        .ai-assistant {
            position: fixed;
            bottom: var(--spacing-2);
            left: var(--spacing-2);
            right: var(--spacing-2);
            background: var(--bg-content);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-2);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-1);
            transform: translateY(100%);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
            max-height: 90px;
            min-height: 48px;
            font-size: 0.85rem;
            overflow-y: auto;
        }
        .ai-assistant.show {
            transform: translateY(0);
            opacity: 1;
        }
        .ai-avatar {
            background: var(--gradient-primary);
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            transition: background 0.5s ease;
        }
        .ai-message p { 
            margin: 0; 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            line-height: 1.3;
        }
        .ai-message strong { 
            color: var(--text-primary); 
            display: block;
            margin-bottom: var(--spacing-1);
        }
        @media (max-width: 600px) {
            .ai-assistant {
                left: 1vw;
                right: 1vw;
                max-width: 98vw;
                min-width: 0;
                padding: var(--spacing-1);
                font-size: 0.8rem;
                max-height: 60px;
            }
            .ai-avatar {
                width: 22px;
                height: 22px;
                font-size: 0.9rem;
            }
        }

        /* --- Notification/Toast & Achievements --- */
        .notification {
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            padding: 12px 16px; 
            border-radius: var(--border-radius); 
            color: white;
            font-weight: 600; 
            z-index: 10000; 
            opacity: 0;
            transform: translate(-50%, -100px); 
            transition: all 0.5s ease;
            display: flex; 
            align-items: center; 
            gap: 8px;
            min-width: 280px; 
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            font-size: var(--font-size-sm);
        }
        .notification.show { opacity: 1; transform: translate(-50%, 0); }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.achievement {
            background: linear-gradient(135deg, #6d28d9, #be185d);
            border-left: 5px solid #fbbf24;
        }
        .achievement-title { font-weight: 800; display: block; font-size: var(--font-size-base); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 2000;
            opacity: 0; 
            visibility: hidden; 
            transition: var(--transition);
            padding: var(--spacing-3);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-content);
            padding: var(--spacing-4);
            border-radius: var(--border-radius-lg);
            width: 100%;
            text-align: center;
            transform: scale(0.9);
            transition: var(--transition);
            max-width: 500px;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h2 { 
            color: var(--primary); 
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-3);
        }
        .modal-content .form-group textarea {
             background-color: var(--bg-alt); 
             color: var(--text-primary); 
             border: 2px solid var(--border-color); 
             width: 100%;
             min-height: 120px;
        }

        /* --- Preloader --- */
        #preloader {
            position: fixed;
            z-index: 99999;
            inset: 0;
            background: #005a9c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.7s cubic-bezier(.77,0,.18,1), visibility 0.7s;
        }
        #preloader.hide {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        .preloader-logo img {
            width: 110px;
            filter: drop-shadow(0 0 30px #e87722cc);
            animation: logo-pulse 1.5s infinite alternate;
        }
        @keyframes logo-pulse {
            0% { filter: drop-shadow(0 0 10px #e87722cc); }
            100% { filter: drop-shadow(0 0 40px #e87722); }
        }
        .preloader-bar {
            width: 220px;
            height: 8px;
            background: #fff2;
            border-radius: 8px;
            margin-top: 2rem;
            overflow: hidden;
        }
        .preloader-progress {
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #e87722 30%, #ffb366 100%);
            border-radius: 8px;
            animation: preloader-bar-move 2.2s cubic-bezier(.77,0,.18,1) forwards;
        }
        @keyframes preloader-bar-move {
            0% { width: 0; }
            80% { width: 90%; }
            100% { width: 100%; }
        }
        .preloader-orbs {
            position: absolute;
            top: 10%; left: 0; right: 0;
            display: flex; justify-content: center; gap: 2rem;
        }
        .preloader-orbs .orb {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(135deg, #e87722 60%, #fff0 100%);
            opacity: 0.7;
            animation: orb-move 1.5s infinite alternate;
        }
        .preloader-orbs .orb1 { animation-delay: 0s; }
        .preloader-orbs .orb2 { animation-delay: 0.5s; }
        .preloader-orbs .orb3 { animation-delay: 1s; }
        @keyframes orb-move {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-18px) scale(1.2); }
        }
        /* --- Animated Orbs BG --- */
        .animated-orbs-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }
        .orb-bg {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.18;
            animation: orb-bg-float 12s infinite alternate;
        }
        .orb-bg1 {
            width: 320px; height: 320px;
            background: radial-gradient(circle, #005a9c 60%, #fff0 100%);
            top: 10%; left: 5%;
            animation-delay: 0s;
        }
        .orb-bg2 {
            width: 220px; height: 220px;
            background: radial-gradient(circle, #e87722 60%, #fff0 100%);
            bottom: 15%; right: 10%;
            animation-delay: 3s;
        }
        .orb-bg3 {
            width: 180px; height: 180px;
            background: radial-gradient(circle, #005a9c 60%, #fff0 100%);
            bottom: 30%; left: 30%;
            animation-delay: 6s;
        }
        @keyframes orb-bg-float {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-30px) scale(1.08); }
        }
        /* --- Glassmorphic Effect --- */
        .glassmorphic {
            background: linear-gradient(135deg, #fff8 60%, #e6f0fa88 100%);
            box-shadow: 0 8px 32px 0 #005a9c22;
            backdrop-filter: blur(14px) saturate(1.2);
            border: 1.5px solid #e8772233;
        }
        /* --- Blur-to-clear Animation --- */
        .blur-to-clear {
            filter: blur(8px);
            opacity: 0.7;
            animation: blur-clear 1.2s cubic-bezier(.77,0,.18,1) 0.2s forwards;
        }
        @keyframes blur-clear {
            to { filter: blur(0); opacity: 1; }
        }
        /* --- Glow Button --- */
        .btn-primary, .btn-primary:focus {
            background: var(--gradient-primary);
            color: #fff;
            box-shadow: 0 0 16px 0 #e87722cc, 0 2px 8px #005a9c33;
            border: none;
            transition: box-shadow 0.3s;
        }
        .btn-primary:hover {
            box-shadow: 0 0 32px 0 #e87722cc, 0 2px 16px #005a9c33;
        }
        /* --- Staggered Form Fields --- */
        .form-group {
            opacity: 0;
            transform: translateY(30px);
            animation: stagger-in 0.7s cubic-bezier(.77,0,.18,1) forwards;
        }
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }
        .form-group:nth-child(6) { animation-delay: 0.6s; }
        .form-group:nth-child(7) { animation-delay: 0.7s; }
        .form-group:nth-child(8) { animation-delay: 0.8s; }
        @keyframes stagger-in {
            to { opacity: 1; transform: none; }
        }
        /* --- Glowing Input Focus --- */
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px #e8772244;
        }
        /* --- Upload Area Hover --- */
        .upload-area {
            border: 2.5px dashed var(--accent);
            background: linear-gradient(135deg, #fff8 60%, #e8772211 100%);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            box-shadow: 0 0 24px #e87722cc;
            background: linear-gradient(135deg, #e8772211 60%, #fff8 100%);
        }
        /* --- Brain Glow & Spin --- */
        .brain-glow {
            display: inline-block;
            position: relative;
        }
        .brain-spin {
            animation: brain-spin 2.5s linear infinite;
            filter: drop-shadow(0 0 12px #e87722cc);
        }
        @keyframes brain-spin {
            100% { transform: rotate(360deg); }
        }
        /* --- Final Score Counter --- */
        .final-score-counter {
            font-size: 2.5rem;
            color: var(--accent);
            font-weight: bold;
            text-align: center;
            margin: 1.5rem 0 0.5rem 0;
            letter-spacing: 2px;
            text-shadow: 0 0 18px #e8772288;
            display: none;
        }
        /* --- Responsive & Mobile --- */
        @media (max-width: 600px) {
            .container { padding: 0 0.5rem; }
            .page-header, .content-container, .glassmorphic { border-radius: 0.7rem; }
            .header-content { flex-direction: column; gap: 1rem; }
            .main-content { padding: 0; }
            .form-grid { grid-template-columns: 1fr; }
            .step-header h2 { font-size: 1.1rem; }
            .btn, .btn-primary, .btn-secondary { font-size: 0.95rem; }
            .ai-assistant { max-width: 98vw; left: 1vw; right: 1vw; }
            .animated-orbs-bg { display: none; }
        }
        /* --- Parallax Effect for BG Orbs --- */
        body {
            /* ...existing code... */
            background: var(--bg-main);
            /* ...existing code... */
            overflow-x: hidden;
        }
        /* --- تحسينات عامة --- */
        .content-container, .report-container, .challenge-container, .interview-container {
            border-radius: 1.2rem;
        }
        /* ...keep other existing styles... */
    </style>
</head>
<body>
    <!-- شاشة التحميل المبدئية -->
    <div id="preloader">
        <div class="preloader-orbs">
            <div class="orb orb1"></div>
            <div class="orb orb2"></div>
            <div class="orb orb3"></div>
        </div>
        <div class="preloader-logo">
            <img src="https://www2.0zz0.com/2025/07/11/04/899155430.png" alt="Mais Logo">
        </div>
        <div class="preloader-bar">
            <div class="preloader-progress"></div>
        </div>
    </div>
    <!-- عناصر orbs للخلفية -->
    <div class="animated-orbs-bg">
        <div class="orb-bg orb-bg1"></div>
        <div class="orb-bg orb-bg2"></div>
        <div class="orb-bg orb-bg3"></div>
    </div>
    <div class="container">
        <header class="page-header glassmorphic">
            <div class="header-content">
                <div class="header-info">
                    <img src="https://www2.0zz0.com/2025/07/11/04/899155430.png" alt="Mais Co. Logo" class="company-logo">
                    <h1 class="blur-to-clear"><i class="fas fa-briefcase"></i> بوابة التوظيف الذكية</h1>
                    <p>   إنطلق لمستقبلك الوظيفي وقم بإجراء مقابلتك الوظيفية خلال ٣ دقائق رقيمياً مع الذكاء الاصطناعي - Mais Co.</p>
                </div>
                <div class="header-actions">
                     <a href="admin.html" target="_blank" class="btn btn-secondary admin-btn"><i class="fas fa-user-shield"></i> تسجيل الدخول</a>
                     <button class="theme-toggle btn" id="themeToggleBtn" aria-label="تبديل المظهر">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <!-- Steps will be generated by JS -->
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-container glassmorphic">
                <!-- Step 1: Basic Info -->
                <div class="step-content" id="step1">
                    <div class="step-header">
                        <h2><i class="fas fa-user-plus"></i> البيانات الأساسية</h2>
                        <p>ابدأ رحلتك المهنية معنا بإدخال بياناتك الأساسية</p>
                    </div>
                    <form id="basicInfoForm" class="form">
                        <div class="form-grid">
                            <div class="form-group"><label for="fullName">الاسم الكامل *</label><input type="text" id="fullName" name="fullName" required></div>
                            <div class="form-group"><label for="email">البريد الإلكتروني *</label><input type="email" id="email" name="email" required></div>
                            <div class="form-group"><label for="phone">رقم الهاتف *</label><input type="tel" id="phone" name="phone" required></div>
                            <div class="form-group"><label for="experience">سنوات الخبرة *</label><select id="experience" name="experience" required><option value="">اختر</option><option value="0-1">أقل من سنة</option><option value="1-3">1-3</option><option value="3-5">3-5</option><option value="5-10">5-10</option><option value="10+">10+</option></select></div>
                            <div class="form-group"><label for="education">المؤهل التعليمي *</label><select id="education" name="education" required><option value="">اختر</option><option value="high-school">ثانوية عامة</option><option value="diploma">دبلوم</option><option value="bachelor">بكالوريوس</option><option value="master">ماجستير</option><option value="phd">دكتوراه</option></select></div>
                            <div class="form-group"><label for="specialization">التخصص *</label><input type="text" id="specialization" name="specialization" required placeholder="مثال: مطور برمجيات، مصمم، مسوق"></div>
                            <div class="form-group"><label for="expectedSalary">الراتب الشهري المتوقع (اختياري)</label><input type="number" id="expectedSalary" name="expectedSalary" placeholder="مثال: 12000"></div>
                            <div class="form-group"><label for="jobDescription">الوصف الوظيفي (اختياري)</label><textarea id="jobDescription" name="jobDescription" rows="4" placeholder="الصق وصف الوظيفة التي تهمك هنا لتحليل مخصص..."></textarea></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-arrow-left"></i> التالي</button>
                        </div>
                    </form>
                </div>

                <!-- Step 2: CV Upload -->
                <div class="step-content" id="step2">
                    <div class="step-header"><h2><i class="fas fa-file-upload"></i> رفع السيرة الذاتية</h2><p>ارفع سيرتك الذاتية ليتم تحليلها بالذكاء الاصطناعي</p></div>
                    <div class="upload-container">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                            <h3>اسحب ملف السيرة الذاتية هنا أو انقر للاختيار</h3>
                            <p>يدعم النظام ملفات PDF, DOC, DOCX, TXT, MD (بحد أقصى 10 ميجابايت)</p>
                            <input type="file" id="cvFile" accept=".pdf,.doc,.docx,.txt,.md" hidden>
                        </div>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <div class="file-details">
                                <i class="fas fa-file-alt"></i>
                                <div>
                                    <div class="file-name" id="fileName"></div>
                                    <div class="file-size" id="fileSize"></div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="app.removeFile()"><i class="fas fa-trash"></i> إزالة</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> السابق</button>
                        <button type="button" class="btn btn-primary" id="analyzeBtn" onclick="app.nextStep()" disabled><i class="fas fa-brain"></i> التالي: تحليل السيرة</button>
                    </div>
                </div>

                <!-- Step 3: Analysis -->
                <div class="step-content" id="step3">
                    <div class="step-header">
                        <h2><span class="brain-glow"><i class="fas fa-brain brain-spin"></i></span> التحليل الذكي للسيرة الذاتية</h2>
                    </div>
                    <div class="analysis-container">
                        <div class="loading-state" id="loadingState">
                            <div class="loading-spinner"></div>
                            <h3>جاري التحليل...</h3>
                            <p id="dynamicLoadingMessage"></p>
                        </div>
                        <div id="analysisResults" style="display: none;">
                            <div id="finalScoreChartContainer"><canvas id="skillsChart"></canvas></div>
                            <div class="analysis-details">
                                <div class="detail-card"><h3><i class="fas fa-user-graduate"></i> ملخص التحليل</h3><div id="analysisSummary"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-lightbulb"></i> اقتراحات لتحسين السيرة الذاتية</h3><div id="cvImprovements"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-id-card"></i> ملخصك الاحترافي المقترح</h3><div id="professionalSummary"></div></div>
                                <div class="detail-card"><h3><i class="fas fa-briefcase"></i> الوظائف المقترحة</h3><div id="suggestedJobs"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> السابق</button>
                        <button type="button" class="btn btn-primary" id="challengeBtn" onclick="app.nextStep()" disabled><i class="fas fa-puzzle-piece"></i> التالي: التحدي</button>
                    </div>
                </div>
                
                <!-- Step 4: Challenge -->
                <div class="step-content" id="step4">
                    <div class="step-header">
                        <h2><i class="fas fa-puzzle-piece"></i> التحدي التفاعلي</h2>
                        <p>نود أن نرى مهاراتك على أرض الواقع. أجب على السيناريو التالي.</p>
                    </div>
                    <div class="challenge-container">
                        <div class="loading-state" id="challengeLoadingState">
                            <div class="loading-spinner"></div>
                            <h3>جاري إعداد تحدي مخصص لك...</h3>
                        </div>
                        <div id="challengeContent" style="display:none;">
                             <div class="challenge-box">
                                <h3 id="challengeTitle"></h3>
                                <p id="challengeScenario"></p>
                            </div>
                            <div class="form-group full-width" style="margin-top: 1rem;">
                                <label for="challengeAnswer">إجابتك على التحدي:</label>
                                <textarea id="challengeAnswer" name="challengeAnswer" rows="6" placeholder="اكتب حلك أو خطة عملك هنا..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.previousStep()"><i class="fas fa-arrow-right"></i> السابق</button>
                        <button type="button" class="btn btn-primary" id="interviewBtn" onclick="app.nextStep()"><i class="fas fa-comments"></i> التالي: المقابلة</button>
                    </div>
                </div>

                <!-- Step 5: Interview -->
                <div class="step-content" id="step5">
                    <div class="step-header"><h2><i class="fas fa-comments"></i> المقابلة التفاعلية</h2><p>أجب على الأسئلة التالية لإكمال عملية التقييم</p></div>
                    <div class="interview-container">
                        <div class="loading-state" id="interviewLoadingState">
                             <div class="loading-spinner"></div>
                             <h3>جاري تحضير أسئلة المقابلة...</h3>
                        </div>
                        <div class="question-card" id="questionCard" style="display:none;">
                            <div class="question-header">
                                <div class="question-number">السؤال <span id="currentQuestion">1</span> من <span id="totalQuestions">5</span></div>
                                <div class="question-timer"><i class="fas fa-clock"></i><span id="timer">05:00</span></div>
                            </div>
                            <div class="question-content">
                                <h3 id="questionText"></h3>
                                <div class="answer-section">
                                    <label for="textAnswer">الإجابة الكتابية:</label>
                                    <textarea id="textAnswer" rows="5" placeholder="اكتب إجابتك هنا..."></textarea>
                                    <div class="real-time-coaching" id="realTimeCoaching" style="display: none;">
                                        <span><i class="fas fa-text-width"></i> الإيجاز: <span id="brevityMeter">--</span></span>
                                        <span><i class="fas fa-brain"></i> كلمات قوية: <span id="powerWordsMeter">0</span></span>
                                    </div>
                                </div>
                                <div class="voice-section">
                                    <label>الإجابة الصوتية (اختياري):</label>
                                    <div class="voice-controls">
                                        <button class="voice-btn btn" id="recordBtn" onclick="app.interview.toggleRecording()"><i class="fas fa-microphone"></i> ابدأ التسجيل</button>
                                        <div class="recording-status" id="recordingStatus"></div>
                                    </div>
                                    <audio id="audioPlayback" controls style="display: none;"></audio>
                                </div>
                            </div>
                            <div class="question-actions">
                                <button type="button" class="btn btn-secondary" id="prevQuestionBtn" onclick="app.interview.previousQuestion()" disabled><i class="fas fa-arrow-right"></i> السابق</button>
                                <button type="button" class="btn btn-primary" id="nextQuestionBtn" onclick="app.interview.nextQuestion()"><i class="fas fa-arrow-left"></i> التالي</button>
                                <button type="button" class="btn btn-primary" id="finishInterviewBtn" onclick="app.interview.finishInterview()" style="display: none;"><i class="fas fa-check"></i> إنهاء المقابلة</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 6: Report -->
                <div class="step-content" id="step6">
                    <div class="step-header">
                        <h2><i class="fas fa-chart-line"></i> التقرير الشامل والتقييم النهائي</h2>
                        <p>تقرير شامل عن تقييمك وتوصياتنا لمسيرتك المهنية</p>
                    </div>
                    <div class="loading-state" id="reportLoadingState">
                        <div class="loading-spinner"></div>
                        <h3>جاري إعداد تقريرك النهائي...</h3>
                    </div>
<div class="report-container" id="reportContainer" style="display:none;">
    <div class="final-score-counter" id="finalScoreCounter"></div>
    <!-- Report content will be injected here -->
    <div id="vacanciesMatchSection" style="margin-top:2rem;"></div>
</div>
<div class="form-actions" id="reportActions" style="display:none;">
    <button type="button" class="btn btn-secondary" onclick="app.downloadReport()"><i class="fas fa-download"></i> تحميل التقرير (PDF)</button>
    <button type="button" class="btn btn-primary" onclick="app.submitApplication()"><i class="fas fa-paper-plane"></i> إرسال الطلب</button>
    <button type="button" class="btn" style="background-color: var(--accent); color: white;" onclick="app.startNew()"><i class="fas fa-trash-alt"></i> حذف بياناتي والبدء من جديد</button>
</div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="aiAssistant">
        <div class="ai-avatar" id="aiAvatar"><i class="fas fa-robot"></i></div>
        <div class="ai-message">
            <strong id="aiAssistantName">مساعدك نمو</strong>
            <p id="aiAssistantMessage">أهلاً بك في بوابة التوظيف الذكية! أنا هنا لمساعدتك.</p>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="resumeModal">
        <div class="modal-content">
            <h2><i class="fas fa-history"></i> متابعة طلب سابق؟</h2>
            <p>لقد وجدنا بيانات طلب غير مكتمل. هل تود المتابعة من حيث توقفت؟</p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="startNewBtn">ابدأ من جديد</button>
                <button class="btn btn-primary" id="resumeBtn">نعم, متابعة</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="interviewModal">
        <div class="modal-content" id="interviewModalContent">
           <!-- Content will be injected by JS -->
        </div>
    </div>


<script>
// --- Firebase Firestore Initialization ---
const firebaseConfig = {
    // يمكنك وضع إعدادات Firebase هنا أو في مكان مركزي
    // apiKey, authDomain, projectId, ... إلخ
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

const App = function() {
    // --- STATE ---
    this.state = {
        currentStep: 1,
        totalSteps: 6,
        theme: 'light',
        themeCycle: ['light', 'dark', 'high-contrast'],
        persona: 'default',
        achievements: [],
        applicationData: {
            basicInfo: {},
            cvFile: null,
            cvContent: '',
            analysisResults: {},
            interactiveChallenge: {
                scenario: null,
                answer: ''
            },
            interview: {
                questions: [],
                currentQuestion: 0,
                answers: [],
                timer: null,
                timeLeft: 300,
            },
            finalReport: {}
        }
    };

    // --- CONFIG ---
    this.config = {
        groqApiKey: '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',
        groqModel: 'meta-llama/llama-4-maverick-17b-128e-instruct', 
        steps: [
            { id: 1, title: 'البيانات', icon: 'fa-user-plus' },
            { id: 2, title: 'السيرة الذاتية', icon: 'fa-file-upload' },
            { id: 3, title: 'التحليل', icon: 'fa-brain' },
            { id: 4, title: 'التحدي', icon: 'fa-puzzle-piece' },
            { id: 5, title: 'المقابلة', icon: 'fa-comments' },
            { id: 6, title: 'التقرير', icon: 'fa-chart-line' },
        ],
        marketInsights: {
            developer: "نصيحة من البيانات: 70% من المطورين الناجحين يذكرون Git و CI/CD في سيرهم الذاتية. تأكد من إبرازها.",
            designer: "نصيحة من البيانات: 90% من المصممين الذين تم توظيفهم يرفقون رابطًا لمعرض أعمالهم (Portfolio).",
            marketer: "نصيحة من البيانات: المسوقون الذين يذكرون نتائج رقمية (مثل زيادة المبيعات بنسبة X%) يحصلون على اهتمام أكبر."
        },
        powerWords: ['قُدت', 'طوّرت', 'أدرت', 'حققت', 'أنجزت', 'أسست', 'زدت', 'حسّنت', 'خفضت', 'ابتكرت', 'led', 'managed', 'developed', 'achieved', 'increased', 'decreased', 'improved', 'founded', 'innovated']
    };
    
    this.dom = {};

    this.init = () => {
        this.dom.progressBar = document.querySelector('.progress-bar');
        this.dom.themeToggleBtn = document.getElementById('themeToggleBtn');
        this.dom.basicInfoForm = document.getElementById('basicInfoForm');
        this.dom.uploadArea = document.getElementById('uploadArea');
        this.dom.cvFile = document.getElementById('cvFile');
        this.dom.aiAssistant = document.getElementById('aiAssistant');
        this.dom.aiAssistantMessage = document.getElementById('aiAssistantMessage');
        this.dom.resumeModal = document.getElementById('resumeModal');
        this.dom.resumeBtn = document.getElementById('resumeBtn');
        this.dom.startNewBtn = document.getElementById('startNewBtn');
        this.dom.fullNameInput = document.getElementById('fullName');
        this.dom.specializationInput = document.getElementById('specialization');
        this.dom.textAnswerTextarea = document.getElementById('textAnswer');
        this.dom.interviewModal = document.getElementById('interviewModal');
        this.dom.interviewModalContent = document.getElementById('interviewModalContent');
        
        if (!this.config.groqApiKey || !this.config.groqApiKey.startsWith('gsk_')) {
             this.showNotification('تنبيه: مفتاح Groq API غير صحيح. لن تعمل ميزات الذكاء الاصطناعي.', 'error');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        this.setupEventListeners();
        this.renderProgressBar();
        this.initTheme();
        this.checkForSavedState();
    };

    this.setupEventListeners = () => {
        this.dom.themeToggleBtn.addEventListener('click', this.toggleTheme);
        this.dom.basicInfoForm.addEventListener('submit', this.handleBasicInfoSubmit);
        this.dom.fullNameInput.addEventListener('input', (e) => this.personalizeWelcome(e.target.value));
        this.dom.specializationInput.addEventListener('input', (e) => this.adaptiveUI.updatePersona(e.target.value));
        this.dom.textAnswerTextarea.addEventListener('input', this.interview.updateRealTimeCoaching);
        
        this.dom.uploadArea.addEventListener('click', () => this.dom.cvFile.click());
        this.dom.cvFile.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            this.dom.uploadArea.addEventListener(eventName, this.handleDragDrop, false);
        });

        this.dom.resumeBtn.addEventListener('click', this.resumeState);
        this.dom.startNewBtn.addEventListener('click', this.clearStateAndHideModal);
    };
    
    // --- STEP 2: CV UPLOAD ---
    this.handleDragDrop = (e) => { e.preventDefault(); e.stopPropagation(); this.dom.uploadArea.classList.remove('dragover'); if (e.type === 'dragover') { this.dom.uploadArea.classList.add('dragover'); } if (e.type === 'drop') { this.handleFileSelect(e.dataTransfer.files[0]); } };
    this.handleFileSelect = async (file) => {
        if (!file) return;
        const allowedMimeTypes = [ 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'text/markdown' ];
        if (!allowedMimeTypes.includes(file.type)) { this.showNotification('نوع الملف غير مدعوم. يرجى رفع PDF, DOCX, DOC, TXT, أو MD.', 'error'); return; }
        if (file.size > 10 * 1024 * 1024) { this.showNotification('حجم الملف كبير جداً (الحد الأقصى 10MB)', 'error'); return; }
        this.state.applicationData.cvFile = file;
        try {
            this.showNotification('جاري معالجة الملف...', 'success');
            let extractedText = '';
            switch (file.type) {
                case 'application/pdf': extractedText = await this.extractTextFromPDF(file); break;
                case 'application/msword': case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': extractedText = await this.extractTextFromWord(file); break;
                case 'text/plain': case 'text/markdown': extractedText = await this.extractTextFromPlain(file); break;
            }
            this.state.applicationData.cvContent = extractedText;
            this.showFileInfo(file);
            document.getElementById('analyzeBtn').disabled = false;
            this.showNotification('تم رفع الملف بنجاح. جاهز للتحليل.', 'success');
            this.unlockAchievement('الوثيقة الأهم', 'تم رفع سيرتك الذاتية بنجاح وجاهزة للتحليل!');
        } catch (error) {
            console.error('File Processing Error:', error);
            this.showNotification('حدث خطأ أثناء معالجة الملف. قد يكون الملف تالفاً.', 'error');
            this.removeFile();
        }
    };
    this.extractTextFromPDF = async (file) => { const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(arrayBuffer).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); text += textContent.items.map(item => item.str).join(' '); } return text; };
    this.extractTextFromWord = async (file) => { const arrayBuffer = await file.arrayBuffer(); const result = await mammoth.extractRawText({ arrayBuffer }); return result.value; };
    this.extractTextFromPlain = (file) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = (e) => reject(e); reader.readAsText(file); }); };
    this.showFileInfo = (file) => { document.getElementById('fileName').textContent = file.name; document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`; document.getElementById('fileInfo').style.display = 'flex'; document.getElementById('uploadArea').style.display = 'none'; };
    this.removeFile = () => { this.state.applicationData.cvFile = null; this.state.applicationData.cvContent = ''; document.getElementById('fileInfo').style.display = 'none'; document.getElementById('uploadArea').style.display = 'block'; document.getElementById('analyzeBtn').disabled = true; this.dom.cvFile.value = ''; };

    // --- API & UTILITIES ---
    this._extractJson = (text) => {
        const match = text.match(/```json\s*([\s\S]*?)\s*```/);
        if (match && match[1]) {
            return match[1].trim();
        }
        return text.trim();
    };

    this.callGroqAPI = async (prompt) => {
        if (!this.config.groqApiKey || !this.config.groqApiKey.startsWith('gsk_')) {
            throw new Error("Groq API key is not configured correctly.");
        }
        const url = 'https://api.groq.com/openai/v1/chat/completions';
        const body = {
            messages: [{ role: "user", content: prompt }],
            model: this.config.groqModel,
            temperature: 0.3,
            max_tokens: 4096,
            top_p: 1,
            stream: false,
            response_format: { type: "json_object" },
        };
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${this.config.groqApiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData?.error?.message || `HTTP error! status: ${response.status}`;
            throw new Error(`Groq API Error: ${errorMessage}`);
        }
        const data = await response.json();
        if (data.choices && data.choices[0]?.message?.content) {
            const rawContent = data.choices[0].message.content;
            const cleanJsonString = this._extractJson(rawContent);
            try {
                return JSON.parse(cleanJsonString);
            } catch (e) {
                console.error("Failed to parse JSON from Groq response:", cleanJsonString);
                throw new Error("Groq API returned malformed JSON.");
            }
        } else {
            const finishReason = data.choices?.[0]?.finish_reason || 'Unknown reason';
            throw new Error(`Groq API call finished unexpectedly. Reason: ${finishReason}.`);
        }
    };
    
    this.startAnalysis = async () => {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('analysisResults').style.display = 'none';
        try {
            const prompt = `
            أنت خبير توظيف محترف. حلل السيرة الذاتية أدناه بشكل منطقي وموضوعي وبدون مجاملات أو حشو. كن دقيقًا في إبراز نقاط القوة والضعف الحقيقية فقط، وركز على تحليل السيرة أولاً ثم إجابات الأسئلة لاحقًا. لا تكرر عبارات عامة أو تمدح بلا سبب. 
            أجب فقط بجسم JSON المطلوب، وبالعربية الكاملة.

            السياق:
            - التخصص: ${this.state.applicationData.basicInfo.specialization}
            - سنوات الخبرة: ${this.state.applicationData.basicInfo.experience}
            - وصف الوظيفة المستهدفة (إن وجد): """${this.state.applicationData.basicInfo.jobDescription || 'تحليل عام للتخصص'}"""
            - نص السيرة الذاتية: """${this.state.applicationData.cvContent}"""

            يجب أن يكون الرد كائن JSON واحد فقط بهذا الشكل (بدون أي نص خارجي):
            {
              "matchScore": <رقم من 0-100>,
              "skillsAnalysis": { "مهارة": <درجة>, ... },
              "summary": "<ملخص منطقي مختصر (2-3 جمل) يصف وضع المرشح الحقيقي>",
              "improvements": [
                  { "original": "<نقطة ضعف حقيقية>", "suggestion": "<اقتراح تطوير عملي>" },
                  { "original": "نصيحة استراتيجية", "suggestion": "<نصيحة مختصرة عملية>" }
              ],
              "professionalSummary": "<ملخص احترافي واقعي (3-4 أسطر) بصيغة المتكلم، دون مبالغة>",
              "suggestedJobs": ["<مسمى وظيفي>", "<مسمى آخر>"]
            }
            `;
            const analysisData = await this.callGroqAPI(prompt);
            this.state.applicationData.analysisResults = analysisData;
            this.displayAnalysisResults(analysisData);
            this.unlockAchievement('خبير تحليل السير', 'تم تحليل سيرتك الذاتية بتقنيات الذكاء الاصطناعي!');
        } catch (error) {
            console.error("AI Analysis Error:", error);
            this.showNotification(`فشل تحليل AI: ${error.message}. سيتم استخدام بيانات تجريبية.`, 'error');
            this.displayAnalysisResults({
                matchScore: 78,
                skillsAnalysis: { "تحليل البيانات": 85, "التواصل": 90, "إدارة المشاريع": 75, "حل المشكلات": 88, "القيادة": 70 },
                summary: "المرشح يمتلك خبرة متوسطة وبعض المهارات، لكن توجد فجوات واضحة في بعض الجوانب. السيرة بحاجة لمزيد من الأمثلة العملية.",
                improvements: [{original: "ضعف في ذكر الإنجازات الرقمية.", suggestion: "أضف أرقامًا ونتائج ملموسة لكل تجربة."}, {original: "نصيحة استراتيجية", suggestion:"ركز على إبراز المهارات التقنية المرتبطة بالوظيفة المطلوبة."}],
                professionalSummary: "أنا متخصص أمتلك خبرة عملية في مجالي، وأسعى لتطوير نفسي في نقاط محددة. أبحث عن فرصة تناسب مهاراتي الحالية وتدفعني للنمو الواقعي.",
                suggestedJobs: ["محلل بيانات", "مساعد إداري"]
            });
        } finally {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('challengeBtn').disabled = false;
        }
    };
    
    this.generateChallenge = async () => {
        document.getElementById('challengeLoadingState').style.display = 'block';
        document.getElementById('challengeContent').style.display = 'none';
        try {
            const prompt = `
            You are an AI assistant that creates job-related challenges.
            Your entire response MUST be a single, valid JSON object, and all text content within the JSON must be in Arabic.
            
            CANDIDATE PROFILE:
            - Specialization: ${this.state.applicationData.basicInfo.specialization}
            - CV Summary: ${this.state.applicationData.analysisResults.summary}
            
            Based on the profile, create a realistic, single-paragraph scenario.
            The JSON object must have this exact structure:
            { 
              "title": "<A short, engaging title for the challenge in Arabic>", 
              "scenario": "<The detailed scenario text in Arabic>" 
            }
            Do not add any text before or after the JSON.
            `;
            const challengeData = await this.callGroqAPI(prompt);
            this.state.applicationData.interactiveChallenge.scenario = challengeData;
            this.displayChallenge(challengeData);
        } catch (error) {
            console.error("Challenge Generation Error:", error);
            this.showNotification(`فشل إنشاء التحدي: ${error.message}. سيتم استخدام سيناريو عام.`, 'error');
            const fallbackChallenge = { title: "سيناريو: إدارة أزمة غير متوقعة", scenario: "تخيل أنك تعمل على مشروع مهم مع موعد تسليم نهائي بعد يومين. فجأة، يخبرك عضو رئيسي في الفريق أنه سيضطر للتغيب لظرف طارئ. ما هي الخطوات الثلاث الأولى التي ستتخذها للتعامل مع هذا الموقف وضمان استمرارية العمل؟" };
            this.state.applicationData.interactiveChallenge.scenario = fallbackChallenge;
            this.displayChallenge(fallbackChallenge);
        } finally {
            document.getElementById('challengeLoadingState').style.display = 'none';
            document.getElementById('challengeContent').style.display = 'block';
        }
    };

    this.interview = {
        mediaRecorder: null, audioChunks: [], isRecording: false, 
        init: async function() {
            const parent = app;
            const warmupAccepted = await parent.showInterviewModal('warmup');
            if (!warmupAccepted) { parent.assistantSpeak("لا بأس، لنبدأ المقابلة مباشرة. حظًا موفقًا!"); }
            document.getElementById('interviewLoadingState').style.display = 'block';
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('realTimeCoaching').style.display = 'flex';
            const interviewState = parent.state.applicationData.interview;
            try {
                const prompt = `
                You are an expert interviewer AI. Your task is to generate 5 insightful interview questions in Arabic.
                Your entire response MUST be a single, valid JSON object with a key "questions" containing an array of 5 strings, and all text content within the JSON must be in Arabic.

                CANDIDATE CONTEXT:
                - Specialization: "${parent.state.applicationData.basicInfo.specialization}"
                - CV Analysis Summary: "${parent.state.applicationData.analysisResults.summary}"
                - Candidate's challenge answer: """${parent.state.applicationData.interactiveChallenge.answer}"""

                Generate 5 diverse questions (behavioral, technical, situational) in Arabic, based on all the context.
                One question should be a direct follow-up to their challenge answer.

                Example of required output:
                {
                  "questions": [
                    "السؤال الأول",
                    "السؤال الثاني",
                    "السؤال الثالث",
                    "السؤال الرابع",
                    "السؤال الخامس"
                  ]
                }
                Do not add any text before or after the JSON object.
                `;
                const questionsObj = await parent.callGroqAPI(prompt);
                interviewState.questions = questionsObj.questions;
            } catch (error) {
                console.error("Interview questions generation failed:", error);
                parent.showNotification(`فشل إنشاء أسئلة مخصصة: ${error.message}. سيتم استخدام أسئلة عامة.`, 'error');
                interviewState.questions = [ "ما هي أهم إنجازاتك المهنية التي تفتخر بها؟", "صف تحديًا صعبًا واجهته وكيف تغلبت عليه.", "أين ترى نفسك مهنياً بعد 5 سنوات من الآن؟", "كيف تواكب التطورات الجديدة في مجال عملك؟", "لماذا تعتقد أنك المرشح الأنسب لهذه الفرصة؟" ];
            }
            interviewState.answers = new Array(interviewState.questions.length).fill(null).map(() => ({ text: '', audioUrl: null }));
            interviewState.currentQuestion = 0;
            document.getElementById('interviewLoadingState').style.display = 'none';
            document.getElementById('questionCard').style.display = 'block';
            this.displayCurrentQuestion();
        },
        displayCurrentQuestion: function() { 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            
 
            const qIndex = interviewState.currentQuestion; 
            document.getElementById('currentQuestion').textContent = qIndex + 1; 
            document.getElementById('totalQuestions').textContent = interviewState.questions.length; 
            document.getElementById('questionText').textContent = interviewState.questions[qIndex]; 
            document.getElementById('textAnswer').value = interviewState.answers[qIndex]?.text || ''; 
            this.updateNavButtons(); 
            this.resetAudio(); 
            this.updateRealTimeCoaching(); 
        }, 
        saveCurrentAnswer: function() { 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            const qIndex = interviewState.currentQuestion; 
            if (!interviewState.answers[qIndex]) { 
                interviewState.answers[qIndex] = { text: '', audioUrl: null }; 
            } 
            interviewState.answers[qIndex].text = document.getElementById('textAnswer').value; 
            parent.saveState(); 
        }, 
        nextQuestion: function() { 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            this.saveCurrentAnswer(); 
            if (interviewState.currentQuestion < interviewState.questions.length - 1) { 
                interviewState.currentQuestion++; 
                this.displayCurrentQuestion(); 
            } 
        }, 
        previousQuestion: function() { 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            this.saveCurrentAnswer(); 
            if (interviewState.currentQuestion > 0) { 
                interviewState.currentQuestion--; 
                this.displayCurrentQuestion(); 
            } 
        }, 
        finishInterview: async function() { 
            this.saveCurrentAnswer(); 
            app.unlockAchievement('المحاور البارع', 'أكملت المقابلة التفاعلية بنجاح!'); 
            const debriefDone = await app.showInterviewModal('debrief'); 
            app.nextStep(); 
        }, 
        updateNavButtons: function() { 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            const qIndex = interviewState.currentQuestion; 
            document.getElementById('prevQuestionBtn').disabled = qIndex === 0; 
            const isLast = qIndex === interviewState.questions.length - 1; 
            document.getElementById('nextQuestionBtn').style.display = isLast ? 'none' : 'inline-flex'; 
            document.getElementById('finishInterviewBtn').style.display = isLast ? 'inline-flex' : 'none'; 
        }, 
        toggleRecording: async function() { 
            if (this.isRecording) { 
                this.stopRecording(); 
            } else { 
                await this.startRecording(); 
            } 
        }, 
        startRecording: async function() { 
            try { 
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
                this.mediaRecorder = new MediaRecorder(stream); 
                this.audioChunks = []; 
                this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data); 
                this.mediaRecorder.onstop = () => { 
                    const parent = app; 
                    const interviewState = parent.state.applicationData.interview; 
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' }); 
                    const audioUrl = URL.createObjectURL(audioBlob); 
                    if (!interviewState.answers[interviewState.currentQuestion]) { 
                        interviewState.answers[interviewState.currentQuestion] = { text: '', audioUrl: null }; 
                    } 
                    interviewState.answers[interviewState.currentQuestion].audioUrl = audioUrl; 
                    document.getElementById('audioPlayback').src = audioUrl; 
                    document.getElementById('audioPlayback').style.display = 'block'; 
                    document.getElementById('recordingStatus').textContent = 'تم حفظ التسجيل.'; 
                }; 
                this.mediaRecorder.start(); 
                this.isRecording = true; 
                const recordBtn = document.getElementById('recordBtn'); 
                recordBtn.classList.add('recording'); 
                recordBtn.innerHTML = '<i class="fas fa-stop"></i> إيقاف التسجيل'; 
                document.getElementById('recordingStatus').textContent = 'جاري التسجيل...'; 
            } catch (err) { 
                app.showNotification('لا يمكن الوصول إلى الميكروفون.', 'error'); 
            } 
        }, 
        stopRecording: function() { 
            if (this.mediaRecorder) { 
                this.mediaRecorder.stop(); 
                this.isRecording = false; 
                if (this.mediaRecorder.stream) { 
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop()); 
                } 
                const recordBtn = document.getElementById('recordBtn'); 
                recordBtn.classList.remove('recording'); 
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i> ابدأ التسجيل'; 
            } 
        }, 
        resetAudio: function() { 
            this.stopRecording(); 
            const parent = app; 
            const interviewState = parent.state.applicationData.interview; 
            const audioUrl = interviewState.answers[interviewState.currentQuestion]?.audioUrl; 
            const audioPlayback = document.getElementById('audioPlayback'); 
            if (audioUrl) { 
                audioPlayback.src = audioUrl; 
                audioPlayback.style.display = 'block'; 
                document.getElementById('recordingStatus').textContent = 'يوجد تسجيل محفوظ.'; 
            } else { 
                audioPlayback.style.display = 'none'; 
                audioPlayback.src = ''; 
                document.getElementById('recordingStatus').textContent = ''; 
            } 
        }, 
        updateRealTimeCoaching: function() { 
            const text = app.dom.textAnswerTextarea.value; 
            const wordCount = text.split(/\s+/).filter(Boolean).length; 
            let brevityStatus = 'ممتاز'; 
            if (wordCount > 100) brevityStatus = 'طويل جدًا'; 
            else if (wordCount > 60) brevityStatus = 'طويل'; 
            document.getElementById('brevityMeter').textContent = brevityStatus; 
            const powerWordsFound = text.toLowerCase().split(/\s+/).filter(word => app.config.powerWords.includes(word)).length; 
            document.getElementById('powerWordsMeter').textContent = powerWordsFound; 
        }
    };
    
    this.initTheme = () => { 
        const savedTheme = localStorage.getItem('theme') || 'light'; 
        this.state.theme = savedTheme; 
        document.documentElement.setAttribute('data-theme', savedTheme); 
        this.updateThemeIcon(); 
    };
    this.toggleTheme = () => { 
        const currentThemeIndex = this.state.themeCycle.indexOf(this.state.theme); 
        const nextThemeIndex = (currentThemeIndex + 1) % this.state.themeCycle.length; 
        const nextTheme = this.state.themeCycle[nextThemeIndex]; 
        this.state.theme = nextTheme; 
        localStorage.setItem('theme', this.state.theme); 
        this.initTheme(); 
    };
    this.updateThemeIcon = () => { 
        const icon = this.dom.themeToggleBtn.querySelector('i'); 
        const themeIcons = { light: 'fa-moon', dark: 'fa-sun', 'high-contrast': 'fa-low-vision' }; 
        icon.className = `fas ${themeIcons[this.state.theme]}`; 
    };
    this.personalizeWelcome = (name) => { 
        const persona = this.state.persona; 
        let message = "أهلاً بك في بوابة التوظيف الذكية! أنا هنا لإرشادك في رحلتك."; 
        if(name.trim() !== '') { 
            if(persona === 'developer') { 
                message = `أهلاً بك يا ${name}! استعد لكتابة الكود نحو وظيفتك القادمة.`; 
            } else if (persona === 'designer') { 
                message = `يا ${name}، أهلاً بك! لنصمم معًا لوحة مشرقة لمستقبلك المهني.`; 
            } else if (persona === 'marketer') { 
                message = `حملة توظيف ${name} انطلقت! أهلاً بك، لنحقق أفضل عائد على الاستثمار في مهاراتك.`; 
            } else { 
                message = `أهلاً بك يا ${name}! يسعدني أن أكون مرشدك اليوم.`; 
            } 
        } 
        this.assistantSpeak(message); 
    };
    this.adaptiveUI = { 
        updatePersona: (specialization) => { 
            let persona = 'default'; 
            const spec = specialization.toLowerCase(); 
            if (spec.includes('مطور') || spec.includes('مبرمج') || spec.includes('developer') || spec.includes('engineer')) { 
                persona = 'developer'; 
            } else if (spec.includes('مصمم') || spec.includes('designer') || spec.includes('creative')) { 
                persona = 'designer'; 
            } else if (spec.includes('مسوق') || spec.includes('marketer') || spec.includes('تسويق')) { 
                persona = 'marketer'; 
            } 
            if (this.state.persona !== persona) { 
                this.state.persona = persona; 
                document.documentElement.setAttribute('data-persona', persona); 
                this.personalizeWelcome(this.dom.fullNameInput.value); 
            } 
        } 
    };
    this.saveState = () => { 
        try { 
            const stateToSave = JSON.parse(JSON.stringify(this.state)); 
            if (stateToSave.applicationData.cvFile) { 
                stateToSave.applicationData.cvFile = { 
                    name: this.state.applicationData.cvFile.name, 
                    size: this.state.applicationData.cvFile.size, 
                    type: this.state.applicationData.cvFile.type, 
                }; 
            } 
            localStorage.setItem('appState', JSON.stringify(stateToSave)); 
        } catch (error) { 
            console.error("Failed to save state:", error); 
        } 
    };
    this.checkForSavedState = () => { 
        const savedStateJSON = localStorage.getItem('appState'); 
        if (savedStateJSON) { 
            this.dom.resumeModal.classList.add('show'); 
        } else { 
            this.showStep(1); 
        } 
    };
    this.resumeState = () => { 
        const savedStateJSON = localStorage.getItem('appState'); 
        if (savedStateJSON) { 
            const savedState = JSON.parse(savedStateJSON); 
            Object.assign(this.state, savedState); 
            this.state.totalSteps = 6; 
            this.initTheme(); 
            this.adaptiveUI.updatePersona(this.state.applicationData.basicInfo.specialization || ''); 
            const basicInfo = this.state.applicationData.basicInfo; 
            for (const key in basicInfo) { 
                const element = document.getElementById(key); 
                if (element) element.value = basicInfo[key]; 
            } 
            if (this.state.applicationData.cvFile) { 
                this.showFileInfo(this.state.applicationData.cvFile); 
                document.getElementById('analyzeBtn').disabled = false; 
            } 
            this.showStep(this.state.currentStep); 
            this.showNotification('تم استئناف طلبك بنجاح. أهلاً بعودتك!', 'success'); 
        } 
        this.dom.resumeModal.classList.remove('show'); 
    };
    this.clearStateAndHideModal = () => { 
        localStorage.removeItem('appState'); 
        this.dom.resumeModal.classList.remove('show'); 
        window.location.reload(); 
    };
    this.startNew = () => { 
        if (confirm('هل تريد حذف جميع بياناتك الحالية والبدء من جديد؟ لا يمكن التراجع عن هذا الإجراء.')) { 
            localStorage.removeItem('appState'); 
            localStorage.removeItem('submittedApplications'); 
            window.location.reload(); 
        } 
    };
    this.unlockAchievement = (title, message) => { 
        if (this.state.achievements.includes(title)) return; 
        this.state.achievements.push(title); 
        this.saveState(); 
        const achievement = document.createElement('div'); 
        achievement.className = 'notification achievement'; 
        achievement.innerHTML = `<i class="fas fa-trophy"></i> <div><span class="achievement-title">${title}</span>${message}</div>`; 
        document.body.appendChild(achievement); 
        setTimeout(() => achievement.classList.add('show'), 100); 
        setTimeout(() => { 
            achievement.classList.remove('show'); 
            setTimeout(() => achievement.remove(), 500); 
        }, 6000); 
    };
    this.renderProgressBar = () => { 
        this.dom.progressBar.innerHTML = this.config.steps.map(step => ` 
            <div class="progress-step" data-step="${step.id}"> 
                <div class="step-circle"><i class="fas ${step.icon}"></i></div> 
                <div class="step-title">${step.title}</div> 
            </div> 
        `).join(''); 
    };
    this.updateProgressBar = () => { 
        document.querySelectorAll('.progress-step').forEach((stepEl) => { 
            const stepNumber = parseInt(stepEl.dataset.step, 10); 
            stepEl.classList.remove('active', 'completed'); 
            if (stepNumber < this.state.currentStep) { 
                stepEl.classList.add('completed'); 
            } else if (stepNumber === this.state.currentStep) { 
                stepEl.classList.add('active'); 
            } 
        }); 
    };
    this.showStep = (step) => { 
        this.state.currentStep = step; 
        document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active')); 
        const currentStepElement = document.getElementById(`step${step}`); 
        if(currentStepElement) currentStepElement.classList.add('active'); 
        this.updateProgressBar(); 
        this.assistantSpeakForStep(step); 
        this.saveState(); 
        switch(step) { 
            case 3: this.startAnalysis(); break; 
            case 4: this.generateChallenge(); break; 
            case 5: this.interview.init(); break; 
            case 6: this.generateFinalReport(); break; 
        } 
    };
    this.nextStep = () => { 
        if (this.state.currentStep < this.state.totalSteps) { 
            if(this.state.currentStep === 1) { 
                this.unlockAchievement('الانطلاقة الأولى', 'أكملت بياناتك الأساسية بنجاح!'); 
            } 
            if(this.state.currentStep === 4) { 
                this.state.applicationData.interactiveChallenge.answer = document.getElementById('challengeAnswer').value; 
                this.unlockAchievement('المفكر الاستراتيجي', 'أجبت على التحدي العملي ببراعة!'); 
            } 
            this.showStep(this.state.currentStep + 1); 
        } 
    };
    this.previousStep = () => { 
        if (this.state.currentStep > 1) { 
            this.showStep(this.state.currentStep - 1); 
        } 
    };
    this.handleBasicInfoSubmit = (e) => { 
        e.preventDefault(); 
        const formData = new FormData(e.target); 
        this.state.applicationData.basicInfo = Object.fromEntries(formData.entries()); 
        this.nextStep(); 
    };
    this.displayAnalysisResults = (data) => { 
        document.getElementById('analysisSummary').innerHTML = `<p>${data.summary}</p>`; 
        document.getElementById('cvImprovements').innerHTML = `<ul>${data.improvements.map(i => `<li><strong>الأصل/النصيحة:</strong> ${i.original}<br><strong>الاقتراح:</strong> ${i.suggestion}</li>`).join('')}</ul>`; 
        document.getElementById('professionalSummary').innerHTML = `<p>${data.professionalSummary}</p>`; 
        document.getElementById('suggestedJobs').innerHTML = `<ul>${data.suggestedJobs.map(j => `<li>${j}</li>`).join('')}</ul>`; 
        this.renderSkillsChart(data.skillsAnalysis, data.matchScore); 
    };
    this.renderSkillsChart = (skillsData, matchScore) => { 
        const chartElement = document.getElementById('skillsChart'); 
        if (Chart.getChart(chartElement)) { 
            Chart.getChart(chartElement).destroy(); 
        } 
        new Chart(chartElement.getContext('2d'), { 
            type: 'radar', 
            data: { 
                labels: Object.keys(skillsData), 
                datasets: [{
                    label: 'تقييم المهارات', 
                    data: Object.values(skillsData), 
                    backgroundColor: 'rgba(46, 139, 87, 0.2)', 
                    borderColor: 'rgb(46, 139, 87)', 
                    pointBackgroundColor: 'rgb(46, 139, 87)' 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: true, 
                scales: { 
                    r: { 
                        angleLines: { color: 'rgba(128, 128, 128, 0.2)' }, 
                        grid: { color: 'rgba(128, 128, 128, 0.2)' }, 
                        pointLabels: { 
                            font: { size: 12, family: 'Cairo' }, 
                            color: getComputedStyle(document.body).getPropertyValue('--text-secondary') 
                        }, 
                        ticks: { 
                            backdropColor: 'transparent', 
                            stepSize: 20 
                        }, 
                        suggestedMin: 0, 
                        suggestedMax: 100 
                    } 
                }, 
                plugins: { 
                    legend: { 
                        labels: { 
                            font: { family: 'Cairo' }, 
                            color: getComputedStyle(document.body).getPropertyValue('--text-primary') 
                        } 
                    }, 
                    title: { 
                        display: true, 
                        text: `التطابق مع الوظيفة: ${matchScore}%`, 
                        font: { size: 16, family: 'Cairo' }, 
                        color: getComputedStyle(document.body).getPropertyValue('--text-primary') 
                    } 
                } 
            } 
        }); 
    };
    this.displayChallenge = (data) => { 
        document.getElementById('challengeTitle').textContent = data.title; 
        document.getElementById('challengeScenario').textContent = data.scenario; 
        document.getElementById('challengeAnswer').value = this.state.applicationData.interactiveChallenge.answer || ''; 
    };
    this.showInterviewModal = (type) => { 
        return new Promise(resolve => { 
            let content = ''; 
            const closeModal = (resolution) => { 
                this.dom.interviewModal.classList.remove('show'); 
                resolve(resolution); 
            }; 
            if (type === 'warmup') { 
                content = ` 
                <h2><i class="fas fa-mug-hot"></i> إحماء قبل المقابلة</h2> 
                <p>أعلم أن المقابلات قد تكون مرهقة. قبل أن نبدأ، ما رأيك في إحماء سريع؟ أخبرني عن شيء ممتع تعلمته هذا الأسبوع خارج نطاق العمل.</p> 
                <p class="disclaimer">هذا السؤال للمساعدة على الاسترخاء فقط ولن يتم تقييمه.</p> 
                <div class="form-actions"> 
                    <button class="btn btn-secondary" id="skipWarmup">تخطِ الإحماء</button> 
                    <button class="btn btn-primary" id="startWarmup">ابدأ الإحماء</button> 
                </div>`; 
                this.dom.interviewModalContent.innerHTML = content; 
                document.getElementById('skipWarmup').onclick = () => closeModal(false); 
                document.getElementById('startWarmup').onclick = () => { 
                    this.assistantSpeak('عظيم! خذ وقتك. عندما تكون جاهزاً، يمكننا البدء بالأسئلة الرسمية.'); 
                    this.dom.interviewModalContent.innerHTML = ` 
                    <h2><i class="fas fa-coffee"></i> سؤال الإحماء</h2> 
                    <p>أخبرني عن شيء ممتع تعلمته هذا الأسبوع خارج نطاق العمل.</p> 
                    <div class="form-group full-width" style="margin-top: 1rem; text-align: right;"> 
                        <textarea id="warmupAnswer" rows="4" placeholder="اكتب هنا..." class="form-group textarea"></textarea> 
                    </div> 
                    <div class="form-actions"> 
                        <button class="btn btn-primary" id="finishWarmup">أنا جاهز، لنبدأ المقابلة</button> 
                    </div> 
                    `; 
                    document.getElementById('finishWarmup').onclick = () => closeModal(true); 
                }; 
            } else if (type === 'debrief') { 
                content = ` 
                <h2><i class="fas fa-award"></i> أداء رائع!</h2> 
                <p>لقد أكملت المقابلة بنجاح. كيف تشعر حيال إجاباتك؟ خذ لحظة للتفكير.</p> 
                <p class="disclaimer">تفكيرك في أدائك هو بحد ذاته مهارة مهمة.</p> 
                <div class="form-actions"> 
                    <button class="btn btn-primary" id="viewReport">عرض تقريري النهائي</button> 
                </div>`; 
                this.dom.interviewModalContent.innerHTML = content; 
                document.getElementById('viewReport').onclick = () => closeModal(true); 
            } 
            this.dom.interviewModal.classList.add('show'); 
        }); 
    };
    this.generateFinalReport = async () => { 
        document.getElementById('reportLoadingState').style.display = 'block'; 
        document.getElementById('reportContainer').style.display = 'none'; 
        document.getElementById('reportActions').style.display = 'none'; 
        try { 
            const interviewSummary = this.state.applicationData.interview.answers.map((ans, i) => `Q${i+1}: ${this.state.applicationData.interview.questions[i]}\nA: ${ans.text || '(No text answer)'}`).join('\n---\n'); 
            const prompt = ` 
            أنت خبير توظيف محترف. أنشئ تقريرًا نهائيًا صارمًا وواقعيًا بناءً على بيانات المرشح أدناه. لا تجامل ولا تكرر عبارات عامة. ركز على تحليل السيرة أولاً ثم إجابات الأسئلة. أبرز نقاط القوة والضعف الحقيقية فقط، وكن مختصرًا وموضوعيًا. 
            أجب فقط بجسم JSON المطلوب، وبالعربية الكاملة.

            بيانات المرشح:
            - المعلومات الأساسية: ${JSON.stringify(this.state.applicationData.basicInfo)} 
            - تحليل السيرة: ${JSON.stringify(this.state.applicationData.analysisResults)} 
            - إجابة التحدي: """${this.state.applicationData.interactiveChallenge.answer}""" 
            - ملخص المقابلة: """${interviewSummary}""" 
            
            يجب أن يكون الرد كائن JSON واحد فقط بهذا الشكل (بدون أي نص خارجي):
            { 
                "finalScore": <درجة نهائية من 0-100>, 
                "performanceCategory": "<أداء متميز|أداء جيد|يحتاج إلى تحسين|أداء ضعيف>", 
                "strengths": ["<نقطة قوة حقيقية>", "<نقطة أخرى>"], 
                "improvements": ["<مجال تطوير حقيقي>", "<آخر>"], 
                "personalityAnalysis": { 
                    "summary": "<تحليل مختصر واقعي>", 
                    "disclaimer": "هذا التحليل تجريبي ومبني على الأسلوب اللغوي فقط ولا يمثل تقييماً نفسياً قاطعاً." 
                }, 
                "suggestedJobs": [
                    {
                        "title": "<مسمى وظيفي>",
                        "department": "<القسم>",
                        "reason": "<سبب الترشيح>"
                    }
                ],
                "careerRoadmap": [ 
                    { "path": "<مسار مهني>", "skills": "<مهارات مطلوبة>" }, 
                    { "path": "<مسار آخر>", "skills": "<مهارات أخرى>" } 
                ], 
                "finalVerdict": "<قرار نهائي مختصر وموضوعي>"
            }
            `; 
            const reportData = await this.callGroqAPI(prompt); 
            this.state.applicationData.finalReport = reportData; 
            this.displayFinalReport(reportData); 
        } catch (error) { 
            console.error("Report Generation Error:", error); 
            this.showNotification(`فشل إنشاء التقرير: ${error.message}. سيتم استخدام بيانات تجريبية.`, 'error'); 
            this.state.applicationData.finalReport = { 
                finalScore: 45, 
                performanceCategory: 'أداء ضعيف', 
                strengths: ["إظهار الرغبة في التعلم", "إكمال جميع خطوات التقديم بنجاح"], 
                improvements: ["الحاجة لمراجعة أساسيات التخصص بشكل أعمق", "التدرب على حل المشكلات بشكل منهجي", "تحسين مهارات التواصل الكتابي لتكون أكثر احترافية"], 
                personalityAnalysis: { 
                    summary: "الإجابات تفتقر إلى العمق والخبرة العملية الكافية حالياً.", 
                    disclaimer: "هذا التحليل تجريبي ومبني على الأسلوب اللغوي فقط ولا يمثل تقييماً نفسياً قاطعاً." 
                }, 
                suggestedJobs: [
                    {
                        "title": "فني صيانة",
                        "department": "التشغيل والصيانة",
                        "reason": "بناءً على خبرتك في المجال الفني واستعدادك للتعلم"
                    },
                    {
                        "title": "مساعد إداري",
                        "department": "الإدارة",
                        "reason": "بسبب مهاراتك التنظيمية وقدرتك على متابعة المهام"
                    }
                ],
                careerRoadmap: [
                    { path: "فترة تدريبية (Internship)", skills: "دورات أساسية في علوم الحاسب, بناء مشاريع شخصية بسيطة" }, 
                    { path: "دعم فني مبتدئ", skills: "شهادات مثل CompTIA A+, مهارات خدمة العملاء" } 
                ], 
                finalVerdict: "هناك فجوات كبيرة بين مؤهلاتك ومتطلبات الدور. ركز على تطوير الجوانب المذكورة قبل التقديم مجددًا." 
            }; 
            this.displayFinalReport(this.state.applicationData.finalReport); 
        } finally { 
            document.getElementById('reportLoadingState').style.display = 'none'; 
            document.getElementById('reportContainer').style.display = 'block'; 
            document.getElementById('reportActions').style.display = 'flex'; 
        } 
    };
    this.downloadReport = async () => { 
        const { jsPDF } = window.jspdf; 
        const reportElement = document.getElementById('pdf-report'); 
        this.showNotification('جاري إعداد التقرير للتحميل...', 'success'); 
        const canvas = await html2canvas(reportElement, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-content'), 
        }); 
        const imgData = canvas.toDataURL('image/png'); 
        const pdf = new jsPDF({ 
            orientation: 'portrait', 
            unit: 'px', 
            format: [canvas.width, canvas.height] 
        }); 
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height); 
        pdf.save(`تقرير-${this.state.applicationData.basicInfo.fullName}.pdf`); 
    };
    this.submitApplication = async () => { 
        try {
            const appData = {
                ...this.state.applicationData,
                submittedAt: new Date().toISOString(),
                status: 'new'
            };
            
            // حذف الملفات الكبيرة غير الضرورية
            delete appData.cvFile;
            delete appData.cvContent;
            
            // إضافة الطلب إلى Firestore
            const docRef = await db.collection("applications").add(appData);
            
            this.showNotification('تم إرسال طلبك بنجاح! نتمنى لك كل التوفيق.', 'success'); 
            setTimeout(() => window.location.reload(), 3000); 
        } catch (error) {
            console.error('فشل في إرسال الطلب:', error);
            this.showNotification('حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى.', 'error');
        }
    };

    this.showNotification = (message, type = 'success') => { 
        const notification = document.createElement('div'); 
        notification.className = `notification ${type}`; 
        notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'times-circle'}"></i> ${message}`; 
        document.body.appendChild(notification); 
        setTimeout(() => notification.classList.add('show'), 100); 
        setTimeout(() => { 
            notification.classList.remove('show'); 
            setTimeout(() => notification.remove(), 5000); 
        }, 5000); 
    };
    this.assistantSpeakForStep = (step) => { 
        const persona = this.state.persona; 
        const insight = this.config.marketInsights[persona] || ''; 
        const messages = { 
            1: "أهلاً بك! لنبدأ معًا هذه الرحلة. أولاً، بعض المعلومات الأساسية عنك.", 
            2: `ممتاز! الآن، الخطوة المحورية: سيرتك الذاتية. تذكر، هذه فرصتك لتلمع. ${insight}`, 
            3: "رائع! لقد استلمت الملف. سأقوم الآن بتشغيل محركاتي التحليلية. قد يستغرق هذا بضع لحظات.", 
            4: "تحليل مثير للاهتمام! الآن لنر كيف تطبق مهاراتك على أرض الواقع. لقد أعددت لك تحدياً عملياً قصيراً.", 
            5: `إجابة مدروسة! الآن، بناءً على كل ما سبق، حان وقت المقابلة. تذكر، الهدف هو فهم طريقة تفكيرك. ${persona === 'developer' ? 'فكر فيها كجلسة pair programming.' : 'فكر فيها كجلسة عصف ذهني.'}`, 
            6: "لقد اكتمل التقييم! عمل رائع. أنا الآن أقوم بتجميع تقريرك الشامل وخارطة طريقك المهنية." 
        }; 
        if (messages[step]) { 
            this.assistantSpeak(messages[step]); 
        } 
    };
    this.assistantSpeak = (message) => { 
        this.dom.aiAssistantMessage.textContent = message; 
        this.dom.aiAssistant.classList.add('show'); 
        setTimeout(() => {
            this.dom.aiAssistant.classList.remove('show');
        }, 8000);
    };
    
    this.loadData = async function() {
        this.showLoading && this.showLoading();

        // جلب المتقدمين من Firebase
        const applicationsSnapshot = await db.collection("applications").get();
        this.applications = applicationsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        // جلب الشواغر من Firebase
        const vacanciesSnapshot = await db.collection("vacancies").get();
        this.vacancies = vacanciesSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        this.hideLoading && this.hideLoading();
    };

};
   
    const firebaseConfig = {
    apiKey: "your-api-key",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "your-messaging-sender-id",
    appId: "your-app-id"
};
    <!-- أضف Firebase SDK -->
 
           this.submitApplication = async () => { 
    try {
        // إنشاء نسخة من بيانات الطلب
        const appData = {
            ...this.state.applicationData,
            submittedAt: new Date().toISOString(),
            status: 'new'
        };
        
        // حذف الملفات الكبيرة غير الضرورية
        delete appData.cvFile;
        delete appData.cvContent;
        
        // إضافة الطلب إلى Firestore
        const docRef = await db.collection("applications").add(appData);
        
        this.showNotification('تم إرسال طلبك بنجاح! نتمنى لك كل التوفيق.', 'success'); 
        setTimeout(() => window.location.reload(), 3000); 
    } catch (error) {
        console.error('فشل في إرسال الطلب:', error);
        this.showNotification('حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى.', 'error');
    }
};

// --- Instantiate and run the app ---
const app = new App();
document.addEventListener('DOMContentLoaded', app.init);

// Preloader logic
window.addEventListener('DOMContentLoaded', function() {
    const preloader = document.getElementById('preloader');
    const progress = preloader.querySelector('.preloader-progress');
    setTimeout(() => {
        progress.style.width = '100%';
    }, 200);
    setTimeout(() => {
        preloader.classList.add('hide');
    }, 900); // تقليل مدة الانتقال بعد التحميل
});
